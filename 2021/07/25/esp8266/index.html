<!DOCTYPE html>
<html>
  <!-- meta/link... -->
  



<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
  <!-- Global site tag (gtag.js) - Google Analytics -->


  <title>ESP8266 | Souther Blog</title>

  <link rel="icon" type="image/png" href="/medias/icons/favicon.png">
  <link rel="stylesheet" href="https://at.alicdn.com/t/font_1911880_c1nvbyezg17.css">
  <link href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" rel="stylesheet">
  <link href="/js/swiper/swiper@5.4.1.min.css" rel="stylesheet">
  
  
  
  
<link rel="stylesheet" href="/css/animate.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
  
    <link href="https://unpkg.com/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" rel="stylesheet">
  
  
    
<link rel="stylesheet" href="/js/shareJs/share.min.css">

  
  <style>
        @media (max-width: 992px) {
            #waifu {
                display: none;
            }
        }
    </style>
    <script defer src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
    <link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">

    
    
    <!-- 依赖于jquery和vue -->
    <script src="https://unpkg.com/jquery@3.5.1/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@2.6.11/dist/vue.min.js"></script>

    <!-- import link -->
    
        
            <link href="/custom/index.css" rel="stylesheet">
        
    
    <!-- import script -->
    
        
            
        
            
        
    

<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="Souther Blog" type="application/atom+xml">
</head>

  
  <!-- 预加载动画 -->
  
  
  <div class="preloader-1" id="loader">
  <div  aria-label="Orange and tan hamster running in a metal wheel" role="img" class="wheel-and-hamster">
    <div class="wheel"></div>
    <div class="hamster">
      <div class="hamster__body">
        <div class="hamster__head">
          <div class="hamster__ear"></div>
          <div class="hamster__eye"></div>
          <div class="hamster__nose"></div>
        </div>
        <div class="hamster__limb hamster__limb--fr"></div>
        <div class="hamster__limb hamster__limb--fl"></div>
        <div class="hamster__limb hamster__limb--br"></div>
        <div class="hamster__limb hamster__limb--bl"></div>
        <div class="hamster__tail"></div>
      </div>
    </div>
    <div class="spoke"></div>
  </div>
</div>
  <script>
    var endLoading = function () {
      document.body.style.overflow = 'auto';
      document.getElementById('loader').classList.add("loaded");
    }
    window.addEventListener('DOMContentLoaded', endLoading);
  </script>


  <body>
    <!-- 判断是否为暗黑风格 -->
    <!-- 判断是否为黑夜模式 -->
<script defer>
  let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');

  if (isDark) {
    $(document.body).addClass('darkModel');
  }
</script>

    <!-- 需要在上面加载的js -->
    <script>
  function loadScript(src, cb) {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }

  //https://github.com/filamentgroup/loadCSS
  var loadCSS = function (src) {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  };

</script> 

<!-- 轮播图所需要的js -->
<script src="/js/swiper/swiper.min.js"></script>
<script src="/js/swiper/vue-awesome-swiper.js"></script>
<script src="/js/swiper/swiper.animate1.0.3.min.js"></script>

<script type="text/javascript">
  Vue.use(window.VueAwesomeSwiper)
</script>


  <script src="/js/vue-typed-js/index.js"></script>


<!-- 首页的公告滚动插件的js需要重新加载 -->
<script src="/js/vue-seamless-scroll/index.js"></script>

<!-- 打字机效果js -->
<script src="https://unpkg.com/typed.js@2.0.11"></script>


    <div id="safearea">
      <main class="main" id="pjax-container">
        <!-- 头部导航 -->
        
<header class="header  " 
  id="navHeader"
  style="position: fixed;
  left: 0; top: 0; z-index: 10;width: 100%;"
>
  <div class="header-content">
    <div class="bars">
      <div id="appDrawer" class="sidebar-image">
  <div class="drawer-box-icon">
    <i class="fas fa-bars" aria-hidden="true" @click="showDialogDrawer"></i>
  </div>
  
  <transition name="fade">
    <div class="drawer-box_mask" v-cloak style="display: none;" v-show="visible" @click.self="cancelDialogDrawer">
    </div>
  </transition>
  <div class="drawer-box" :class="{'active': visible}">
    <div class="drawer-box-head bg-color">
      <img class="drawer-box-head_logo lazyload placeholder" src="/medias/icons/sanye.jpg" class="lazyload placeholder" data-srcset="/medias/icons/sanye.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
      <h3 class="drawer-box-head_title">Souther Blog</h3>
      <h5 class="drawer-box-head_desc"></h5>
    </div>
    
    <div class="drawer-box-content">
      <ul class="drawer-box-content_menu">
        
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/" class="drawer-menu-item-link">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/archives" class="drawer-menu-item-link">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="/tags" class="drawer-menu-item-link">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="drawer-box-content_item" style="position: relative;">
              
                <a href="javascript:;" class="drawer-menu-item-link has-children" @click="openOrCloseMenu(3)">
                  <span>
                    
                    <span class="name">更多</span>
                  </span>
                  <i class="fas fa-chevron-left arrow " :class="{'icon-rotate': isOpen(3)}" aria-hidden="true"></i>
                </a>
                <ul class="drawer-sub-menu" v-if="isOpen(3)">
                  
                  <li>
                    <a href="/about">
                      
                      <i class="fa fa-address-card" style="margin-top: -20px;"></i>
                      
                      <span>关于我</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/friends">
                      
                      <i class="fa fa-users" style="margin-top: -20px;"></i>
                      
                      <span>友情链接</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
        
      </ul>
    </div>
  </div>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDrawer',
    data: {
      visible: false,
      top: 0,
      openArr: [],
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      isOpen(index) {
        if (this.openArr.includes(index)) {
          return true;
        } else {
          return false;
        }
      },
      openOrCloseMenu(curIndex) {
        const index = this.openArr.indexOf(curIndex);
        if (index !== -1) {
          this.openArr.splice(index, 1);
        } else {
          this.openArr.push(curIndex);
        }
      },
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'width: 100%; height: 100%;overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      }
    },
    created() {}
  })
</script>

    </div>
    <div class="blog-title" id="author-avatar">
      
        <div class="avatar">
          <img src="/medias/icons/sanye.jpg" class="lazyload placeholder" data-srcset="/medias/icons/sanye.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="logo">
        </div>
      
      <a href="/" class="logo">Souther Blog</a>
    </div>
    <nav class="navbar">
      <ul class="menu">
        
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/" class="menu-item-link" title="首页">
                  
                    <i class="fas fa-home" aria-hidden="true"></i>
                  
                  <span class="name">首页</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/archives" class="menu-item-link" title="归档">
                  
                    <i class="fas fa-archive" aria-hidden="true"></i>
                  
                  <span class="name">归档</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="/tags" class="menu-item-link" title="标签">
                  
                    <i class="fas fa-tags" aria-hidden="true"></i>
                  
                  <span class="name">标签</span>
                </a>
              
            </li>
          
            <li class="menu-item" style="position: relative;">
              
                <a href="javascript:;" class="menu-item-link" title="更多">
                  
                  <span class="name">更多</span>
                  <i class="fas fa-chevron-down arrow" aria-hidden="true"></i>
                </a>
                <ul class="sub-menu">
                  
                  <li>
                    <a href="/about">
                      
                      <i class="fa fa-address-card" style="margin-top: -20px;"></i>
                      
                      <span>关于我</span>
                    </a>
                  </li>
                  
                  <li>
                    <a href="/friends">
                      
                      <i class="fa fa-users" style="margin-top: -20px;"></i>
                      
                      <span>友情链接</span>
                    </a>
                  </li>
                  
                </ul>
              
            </li>
          
        
      </ul>
      
      
        <div id="appSearch">
  <div class="search"  @click="showDialog()"><i class="fas fa-search" aria-hidden="true"></i></div>
  <transition name="fade">
    <div class="message-box_wrapper" style="display: none;" v-cloak v-show="dialogVisible" @click.self="cancelDialogVisible()">
      <div class="message-box animated bounceInDown">
        <h2>
          <span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <span class="title">本地搜索</span>
          </span>
          <i class="fas fa-times close" pointer style="float:right;" aria-hidden="true" @click.self="cancelDialogVisible()"></i>
        </h2>
        <form class="site-search-form">
          <input type="text"
            placeholder="请输入关键字"
            id="local-search-input" 
            @click="getSearchFile()"
            class="st-search-input"
            v-model="searchInput"
          />
        </form>
        <div class="result-wrapper">
          <div id="local-search-result" class="local-search-result-cls"></div>
        </div>
      </div>
    </div>
  </transition>
</div>
<script src="/js/local_search.js"></script>
<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appSearch',
    data: {
      dialogVisible: false,
      searchInput: '',
      top: 0,
    },
    computed: {
    },
    mounted() {
      window.addEventListener('pjax:complete', () => {
        this.cancelDialogVisible();
      })
    },
    methods: {
      showDialog() {
        this.dialogVisible = true;
        // 防止页面滚动，只能让弹框滚动
        this.top = $(document).scrollTop()
        body.style.cssText = 'overflow: hidden;';
      },
      getSearchFile() {
        if (!this.searchInput) {
          getSearchFile("/search.xml");
        }
      },
      cancelDialogVisible() {
        this.dialogVisible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
    },
    created() {}
  })
</script>
<!-- 解决刷新页面闪烁问题，可以在元素上添加display: none, 或者用vue.extend方法，详情：https://blog.csdn.net/qq_31393401/article/details/81017912 -->
<!-- 下面是搜索基本写法 -->
<!-- <script type="text/javascript" id="local.search.active">
  var inputArea = document.querySelector("#local-search-input");
  inputArea.onclick   = function(){ getSearchFile(); this.onclick = null }
  inputArea.onkeydown = function(){ if(event.keyCode == 13) return false }
</script> -->

      

    </nav>
  </div>
  
  
</header>
        <!-- 内容区域 -->
        
<!-- prismjs 代码高亮 -->




<div class="bg-dark-floor" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -1;"></div>


  <!-- 文章详情页顶部图片和标题 -->




<div class="post-detail-header" id="thumbnail_canvas" style="background-repeat: no-repeat; background-size: cover; 
  background-position: center center;position: relative;background-image:url('https://z3.ax1x.com/2021/08/25/helaa8.jpg')">
  <div class="post-detail-header-mask"></div>
  <canvas id="header_canvas"style="position:absolute;bottom:0;pointer-events:none;"></canvas>
  
  <div class="post-detail-header_info-box">
    <div class="title-box">
      <span class="title">
        ESP8266
      </span>
    </div>
    
    
      
        <span class="post-detail-header_date">
          <i class="fas fa-calendar"></i> 发表于：2021-07-25 |
        </span>
      

      

      
        <div class="post-detail-header_wordcount">
          <span class="totalcount">
            <i class="fas fa-file-text-o"></i> 字数统计: 29.1k |
          </span>
  
          <span class="min2read">
            <i class="fas fa-clock"></i> 阅读时长: 144分钟 |
          </span>
  
          
            <span class="reading">
              <i class="fas fa-eye"></i> 阅读量：<span id="busuanzi_value_page_pv"></span>
            </span>
          
        </div>
      
    
  </div>
  
  
    <script defer src="/js/bubble/bubble.js"></script>
  
</div>





<div class="post-detail-content post-row" 
  style="padding-top: 0px;">
  <div class="main-content">
    <article class="post post-detail">
      <div class="post-content">
        <h1 id="1、esp8266系列模块"><a href="#1、esp8266系列模块" class="headerlink" title="1、esp8266系列模块"></a>1、esp8266系列模块</h1><p>​	ESP8266 系列模组是深圳市安信可科技有限公司开发的一系列基于乐鑫ESP8266EX的低功耗UART-WiFi芯片模组，可以方便地进行二次开发，接入云端服务，实现手机3&#x2F;4G全球随时随地的控制，加速产品原型设计。</p>
<p>　　模块核心处理器 ESP8266 在较小尺寸封装中集成了业界领先的 Tensilica L106 超低功耗 32 位微型 MCU，带有 16 位精简模式，主频支持 80 MHz 和 160 MHz，支持 RTOS，集成 Wi-Fi MAC&#x2F; BB&#x2F;RF&#x2F;PA&#x2F;LNA，板载天线。支持标准的 IEEE802.11 b&#x2F;g&#x2F;n 协议，完整的 TCP&#x2F;IP 协议栈。用户可以使用该模块为现有的设备添加联网功能，也可以构建独立的网络控制器。</p>
<pre><code> **特点:**
</code></pre>
<ul>
<li>802.11 b&#x2F;g&#x2F;n</li>
<li>内置Tensilica L106 超低功耗 32 位微型 MCU，主频支持 80 MHz 和160 MHz，支持 RTOS</li>
<li>内置10 bit高精度ADC</li>
<li>内置TCP&#x2F;IP协议栈</li>
<li>内置TR 开关、balun、LNA、功率放大器和匹配网络</li>
<li>内置PLL、稳压器和电源管理组件，802.11b 模式下+18 dBm的输出功率</li>
<li>A-MPDU 、 A-MSDU 的聚合和 0.4 s的保护间隔</li>
<li>Wi-Fi @ 2.4 GHz，支持 WPA&#x2F;WPA2 安全模式</li>
<li>支持AT本地升级及云端OTA升级</li>
<li>支持 STA&#x2F;AP&#x2F;STA+AP 工作模式</li>
<li>支持 Smart Config 功能（包括 Android 和 IOS 设备）</li>
<li>HSPI 、UART、I2C、I2S、IR Remote Control、PWM、GPIO</li>
<li>深度睡眠保持电流为 20 uA，关断电流小于 5 uA</li>
<li>2 ms 之内唤醒、连接并传递数据包</li>
<li>待机状态消耗功率小于1.0 mW (DTIM3)</li>
<li>工作温度范围：详情请见具体型号规格书</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fCFrdK"><img src="https://z3.ax1x.com/2021/08/02/fCFrdK.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/02/fCFrdK.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fCFrdK.png"  /></a></p>
<h1 id="2、固件下载错误进行擦除"><a href="#2、固件下载错误进行擦除" class="headerlink" title="2、固件下载错误进行擦除"></a>2、固件下载错误进行擦除</h1><p>​	ESPtool.py是一个python开发的针对ESP8266的小工具，可以实现底层的操作，弥补ESP8266官方工具的不足。flash的小工具，可以弥补ESP8266官方工具的不足。它也是一个开源项目，项目在github上进行托管：<a target="_blank" rel="noopener" href="https://github.com/themadinventor/esptool">https://github.com/themadinventor/esptool</a></p>
<p>​	虽然可以直接从github上下载使用，但是更好的方法是通过网络的方式进行安装，这样不会缺少依赖模块，减少运行中的故障。下面就介绍它的安装方法。</p>
<ol>
<li><p>因为esptool.py需要使用python2，所以我们先需要安装python2，并将python加入系统路径（path）。</p>
</li>
<li><p>安装python的包管理器pip，通常是使用get-pip.py进行安装。在 <a target="_blank" rel="noopener" href="https://pip.pypa.io/en/latest/installing/">https://pip.pypa.io/en/latest/installing/</a> 可以找到安装的说明和需要下载的文件，按照说明可以很容易安装pip。（如果同时安装了python2和python3，pip可能默认是pip3，需要用pip2来代替下面的pip，在Linux上需要用sudo权限安装）。</p>
</li>
<li><p>用pip安装esptool<br><code>pip install esptool</code></p>
</li>
<li><p>因为esptool需要使用串口，所以还需要安装pyserial。</p>
</li>
</ol>
<p><code>pip install pyserial</code></p>
<ol start="5">
<li>安装后，在Linux下，通常就可以直接运行esptool.py，在Windwos下，esptool一般安装在python2\Scripts\目录下，需要输入完整目录才能运行，如：</li>
</ol>
<p><code>c:\Python27\Scripts\esptool.py</code></p>
<p>​	如果不清楚esptool.py的用法，可以输入-h查看帮助，如</p>
<p> <code>esptool.py -h</code></p>
<p>​	甚至可以查看某个用法的帮助：</p>
<p> <code>esptool.py read_flash -h</code></p>
<ol start="6">
<li>擦除flash。<br>首先要确认一下8266所连接的串口号，要以串口号作为指令的参数，如我的设备是在COM4，我运行的指令就是esptool.py –port COM4 erase_flash<br><img src="http://bbs.eeworld.com.cn/data/attachment/forum/201608/14/002734julv7tylu4hae44a.png.thumb.jpg" class="lazyload placeholder" data-srcset="http://bbs.eeworld.com.cn/data/attachment/forum/201608/14/002734julv7tylu4hae44a.png.thumb.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"><br>此处需要注意，执行擦除的指令前，需要像烧录固件一样，让8266进入升级模式，即按住板上的flash键不放，按下rst键，等待两秒，松开rst键，再松开flash键。否则会出现如下的错误提示：<img src="http://bbs.eeworld.com.cn/forum.php?mod=image&aid=253737&size=300x300&key=d2d7d3e3ef4b0dda&nocache=yes&type=fixnone" class="lazyload placeholder" data-srcset="http://bbs.eeworld.com.cn/forum.php?mod=image&aid=253737&size=300x300&key=d2d7d3e3ef4b0dda&nocache=yes&type=fixnone" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="img"  />
这样flash的擦除工作就完成了，重新再烧录固件之后即可解决固件运行异常的问题。</li>
</ol>
<h1 id="3、环境准备（Arduino开发）"><a href="#3、环境准备（Arduino开发）" class="headerlink" title="3、环境准备（Arduino开发）"></a>3、环境准备（Arduino开发）</h1><h2 id="1、硬件准备"><a href="#1、硬件准备" class="headerlink" title="1、硬件准备"></a>1、硬件准备</h2><p>GPIO0决定板子处于什么模式（上电低电平为进入下载模式）</p>
<h3 id="1、ESP-01系列"><a href="#1、ESP-01系列" class="headerlink" title="1、ESP-01系列"></a>1、ESP-01系列</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/WhEJnU"><img src="https://z3.ax1x.com/2021/07/26/WhEJnU.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/WhEJnU.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="WhEJnU.md.png" style="zoom: 80%;" /></a><a target="_blank" rel="noopener" href="https://imgtu.com/i/fCZ14f"><img src="https://z3.ax1x.com/2021/08/02/fCZ14f.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/02/fCZ14f.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fCZ14f.png" style="zoom: 80%;" /></a></p>
<h3 id="2、用的最多的12F"><a href="#2、用的最多的12F" class="headerlink" title="2、用的最多的12F"></a>2、用的最多的12F</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/Whud4e"><img src="https://z3.ax1x.com/2021/07/26/Whud4e.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/Whud4e.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="Whud4e.md.png"></a><br>SMD-22封装，GPIO0-GPIO16共17个通用IO口，一个单通道ADC，GPIO6-GPIO11用于连接外部flash，不可用，支持SPI总线通信：GPIO12-GPIO15，支持I2C总线：GPIO4-GPIO5,串口通信：GPIO1-GPIO3。</p>
<ul>
<li><p>12F一般D0-D8（除D3口即GPIO0下载用）；</p>
</li>
<li><p>D0：INPUT（输入）、OUTPUT（输出）、INPUT_PULLDOWN（输入，默认下拉，低电平）；</p>
</li>
<li><p>其余IO口：INPUT（输入）、OTPUT（输出）、INPUT_PULLUP（输入，默认上拉，高电平）；</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/WhEdhR"><img src="https://z3.ax1x.com/2021/07/26/WhEdhR.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/WhEdhR.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="WhEdhR.md.png"></a></p>
<p>注意：烧录模式GPIO0接地，正常模式GPIO悬空。</p>
<h3 id="3、NodeMcu（ESP-12F开发板）"><a href="#3、NodeMcu（ESP-12F开发板）" class="headerlink" title="3、NodeMcu（ESP-12F开发板）"></a>3、NodeMcu（ESP-12F开发板）</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/WhKk5D"><img src="https://z3.ax1x.com/2021/07/26/WhKk5D.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/WhKk5D.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="WhKk5D.md.png"  /></a><br><a target="_blank" rel="noopener" href="https://imgtu.com/i/WhKla8"><img src="https://z3.ax1x.com/2021/07/26/WhKla8.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/WhKla8.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="WhKla8.md.png"  /></a></p>
<h3 id="4、8266-12E"><a href="#4、8266-12E" class="headerlink" title="4、8266-12E"></a>4、8266-12E</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fCJX6I"><img src="https://z3.ax1x.com/2021/08/02/fCJX6I.jpg" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/02/fCJX6I.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fCJX6I.jpg" style="zoom: 50%;" /></a></p>
<h2 id="2、软件准备"><a href="#2、软件准备" class="headerlink" title="2、软件准备"></a>2、软件准备</h2><h3 id="1、Arduino安装-8266包安装"><a href="#1、Arduino安装-8266包安装" class="headerlink" title="1、Arduino安装+8266包安装"></a>1、Arduino安装+8266包安装</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fCmCY6"><img src="https://z3.ax1x.com/2021/08/02/fCmCY6.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/02/fCmCY6.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fCmCY6.png"></a></p>
<h3 id="2、芯片检测程序"><a href="#2、芯片检测程序" class="headerlink" title="2、芯片检测程序"></a>2、芯片检测程序</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    测试ESP8266 demo,打印ESP8266模块信息</span></span><br><span class="line"><span class="comment"> *    1.打印Arduino Core For ESP8266 版本</span></span><br><span class="line"><span class="comment"> *    2.打印Flash的唯一性芯片id</span></span><br><span class="line"><span class="comment"> *    3.打印Flash实际大小</span></span><br><span class="line"><span class="comment"> *    4.打印IDE配置的使用Flash大小</span></span><br><span class="line"><span class="comment"> *    5.打印IDE配置的Flash连接通信的频率</span></span><br><span class="line"><span class="comment"> *    6.打印Flash连接模式：QIO QOUT DIO DOUT，可以理解为Flash传输速率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//使能软件看门狗的触发间隔</span></span><br><span class="line">  <span class="comment">//规定时间（5S）内不喂狗，系统复位</span></span><br><span class="line">  ESP.wdtEnable(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//喂狗</span></span><br><span class="line">  ESP.wdtFeed();</span><br><span class="line">  FlashMode_t ideMode = ESP.getFlashChipMode();</span><br><span class="line">  String coreVersion = ESP.getCoreVersion();</span><br><span class="line">  Serial.print(F(<span class="string">&quot;Arduino Core For ESP8266 Version: &quot;</span>));</span><br><span class="line">  Serial.println(coreVersion);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Flash real id（唯一标识符）:   %08X\n&quot;</span>, ESP.getFlashChipId());</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Flash 实际大小: %u KBytes\n&quot;</span>, ESP.getFlashChipRealSize()/<span class="number">1024</span>);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;IDE配置Flash大小: %u KBytes,往往小于实际大小\n&quot;</span>, ESP.getFlashChipSize()/<span class="number">1024</span>);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;IDE配置Flash频率 : %u MHz\n&quot;</span>, ESP.getFlashChipSpeed()/<span class="number">1000000</span>);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Flash ide mode:  %s\n\n&quot;</span>, (ideMode == FM_QIO ? <span class="string">&quot;QIO&quot;</span> : ideMode == FM_QOUT ? <span class="string">&quot;QOUT&quot;</span> : ideMode == FM_DIO ? <span class="string">&quot;DIO&quot;</span> : ideMode == FM_DOUT ? <span class="string">&quot;DOUT&quot;</span> : <span class="string">&quot;UNKNOWN&quot;</span>));  </span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://z3.ax1x.com/2021/07/26/WhVRqU.md.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/07/26/WhVRqU.md.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="WhVRqU.md.png"></p>
<h1 id="4、相关外设使用"><a href="#4、相关外设使用" class="headerlink" title="4、相关外设使用"></a>4、相关外设使用</h1><h2 id="1、计时和延时"><a href="#1、计时和延时" class="headerlink" title="1、计时和延时"></a>1、计时和延时</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*     计时和延时：</span></span><br><span class="line"><span class="comment">*     delay(ms);</span></span><br><span class="line"><span class="comment">*     delayMicroseconds(us);延时中不能做其他事</span></span><br><span class="line"><span class="comment">*     millis(); //返回重启后所经过的毫秒数</span></span><br><span class="line"><span class="comment">*     micros(); //返回重启后所经过的微秒数</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="type">long</span> debouncdDelay = <span class="number">60</span>;<span class="comment">//延时间隔</span></span><br><span class="line"><span class="type">long</span> lastDebounceTime = <span class="number">0</span>; <span class="comment">//最近记录的一次时间</span></span><br><span class="line"><span class="comment">// 判断时间间隔是否大于设定的时间间隔。</span></span><br><span class="line"><span class="keyword">if</span>(millis()-lastDebounceTime&gt;debouncdDelay)&#123;</span><br><span class="line">    lastDebounceTime = millis();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、IO口（Blink）"><a href="#2、IO口（Blink）" class="headerlink" title="2、IO口（Blink）"></a>2、IO口（Blink）</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * LED灯闪烁实验</span></span><br><span class="line"><span class="comment"> * 12E模块，LED在GPIO2口，即NodeMCU的D4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">    pinMode(D4, OUTPUT);   <span class="comment">// 初始化D1引脚为输出引脚</span></span><br><span class="line">&#125; </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">    digitalWrite(D4, LOW); <span class="comment">// 亮灯</span></span><br><span class="line">    delay(<span class="number">1000</span>); <span class="comment">// 延时1s</span></span><br><span class="line">    digitalWrite(D4, HIGH);<span class="comment">// 灭灯</span></span><br><span class="line">    delay(<span class="number">1000</span>); <span class="comment">// 延时1s</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、中断"><a href="#3、中断" class="headerlink" title="3、中断"></a>3、中断</h2><p>（除了DO&#x2F;GPIO16，中断可以绑到任意GPIO脚）</p>
<p>相关函数：</p>
<ol>
<li><code>attachInterrupt(pin,function,mode);</code> 在指定引脚设置为响应中断。pin:要设置的中断号，function:中断时执行的函数，不带任何参数，无返回,Interrupt type&#x2F;mode:中断触发条件（CHANGE:改变沿；RISING：上升沿；FALLING：下降沿）</li>
<li><code>detachInterrupt(pin);</code> 禁用指定GPIO引脚上的中断。pin:要禁用的中断的GPIO引脚，无返回值。</li>
<li><code>digitalPinToInterrupt(pin);</code> 获取指定GPIO引脚的中断号。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：ESP8266中断演示</span></span><br><span class="line"><span class="comment"> * D2口接下拉电阻到地，同时也通过一个按键开关接到VCC</span></span><br><span class="line"><span class="comment"> * 当开关按下，D2接到上升沿，开启中断，进入中断函数</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line"> Serial.begin(<span class="number">115200</span>);<span class="comment">//设置串口波特率</span></span><br><span class="line"> attachInterrupt(digitalPinToInterrupt(D2), InterruptFunc, RISING);<span class="comment">//设置中断号、响应函数、触发方式</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 中断响应函数</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">ICACHE_RAM_ATTR <span class="type">void</span> <span class="title function_">InterruptFunc</span><span class="params">()</span>&#123;</span><br><span class="line"> Serial.println(<span class="string">&quot;Hello ESP8266&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、模拟输入（ADC）"><a href="#4、模拟输入（ADC）" class="headerlink" title="4、模拟输入（ADC）"></a>4、模拟输入（ADC）</h2><p>esp8266只用一个10位ADC通道（和芯片供电电压复用：即可设置为测量系统电压或者外部电压）</p>
<h3 id="1、测量外部电压"><a href="#1、测量外部电压" class="headerlink" title="1、测量外部电压"></a>1、测量外部电压</h3><ul>
<li>方法：<code>analogRead(A0);</code></li>
<li>0-1.0V</li>
<li>测量精度：10位ADC：0~$2^{10}$​​​</li>
<li>注意：开发板上做了电阻分压器，使其能够测量0 ~ 3.3V（220K与100K电阻分压）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：ESP8266 ADC 读取外部电压</span></span><br><span class="line"><span class="comment"> * 在串口调试器查看效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);<span class="comment">//配置波特率</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;ADC Value: &quot;</span>);</span><br><span class="line">  Serial.println(analogRead(A0));<span class="comment">//输出0-1023 对应 外部输入电压 0-1.0v</span></span><br><span class="line">  <span class="comment">//延时1s</span></span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、测量系统外部电压"><a href="#2、测量系统外部电压" class="headerlink" title="2、测量系统外部电压"></a>2、测量系统外部电压</h3><ul>
<li><p>方法： ESP.getVcc()      </p>
</li>
<li><p>单位： mv</p>
</li>
<li><p>ADC引脚要悬空。读取前要更改ADC模式（在#include行后面）<code>ADC_TOUT</code> (对外部电压），<code>ADC_VCC</code>（对系统电压），默认读取外部</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：ESP8266 ADC 读取系统电压</span></span><br><span class="line"><span class="comment"> * 在串口调试器查看效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">ADC_MODE(ADC_VCC);<span class="comment">//设置ADC模式为读取系统电压</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;ESP8266当前系统电压(mV): &quot;</span>);</span><br><span class="line">  Serial.println(ESP.getVcc());</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="5、模拟输出（PWM）"><a href="#5、模拟输出（PWM）" class="headerlink" title="5、模拟输出（PWM）"></a>5、模拟输出（PWM）</h2><ul>
<li><p><code>analogWrite(pin,val)</code>	在指定引脚上启用PWM；pin:GPIO;    val:一般0 ~ PWMRANGE,默认PWMRANGE&#x3D;1023;无返回值；<code>analogWrite(pin,0)</code>相当于禁用指定引脚上的PWM；</p>
</li>
<li><p><code>analogWriteRange(new_range)</code>  改变PWMRANGE数值；new_range:新的PWMRANGE数值；无返回值；（可以调节PWM精度）；</p>
</li>
<li><p><code>analogWriteFreq(new_frequency)</code>  改变PWM频率；默认1KHz</p>
<ul>
<li><p>Arduino For ESP8266的PWM频率范围为100Hz ~40KHz:</p>
<p>  源码：</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint16_t</span> analogFreq = <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">void</span> __analogWriteFreq(<span class="type">uint32_t</span> freq) &#123;</span><br><span class="line">  <span class="keyword">if</span> (freq &lt; <span class="number">100</span>) &#123;</span><br><span class="line">    analogFreq = <span class="number">100</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (freq &gt; <span class="number">40000</span>) &#123;</span><br><span class="line">    analogFreq = <span class="number">40000</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    analogFreq = freq;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<p>例程（呼吸灯）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：ESP8266 PWM演示例程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_LED D6</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(PIN_LED,OUTPUT);</span><br><span class="line">  analogWrite(PIN_LED,<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> val=<span class="number">0</span>;val&lt;<span class="number">1024</span>;val++)&#123;</span><br><span class="line">     <span class="comment">//占空比不断增大  亮度渐亮</span></span><br><span class="line">	 analogWrite(PIN_LED,val);</span><br><span class="line">	 delay(<span class="number">2</span>);</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> val=<span class="number">1023</span>;val&gt;=<span class="number">0</span>;val--)&#123;</span><br><span class="line">     <span class="comment">//占空比不断变小  亮度渐暗</span></span><br><span class="line">	 analogWrite(PIN_LED,<span class="number">1023</span>);</span><br><span class="line">	 delay(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6、串口通信"><a href="#6、串口通信" class="headerlink" title="6、串口通信"></a>6、串口通信</h2><p>与传统Arduino设备完全一样。除硬件FIFO（128字节用于TX和RX）之外，硬件串口还有额外的256字节的TX和RX缓存。发送和接受全部由中断驱动。当FIFO&#x2F;缓存满时，Write函数会阻塞工程代码执行，等待空闲空间。当FIFO&#x2F;缓存空时，read函数也会阻塞工程代码的执行，等待串口数据进来。</p>
<ul>
<li><p>NodeMcu上有两组串口，Serial和Serial1（都是硬件串口）。</p>
<ul>
<li><p><strong>Serial使用UART0</strong>，默认GPIO1（TX）和GPIO3（RX）；Serial.begin执行之后，调用<code>Serial.swap()</code>可以将Serial重新映射到GPIO15（TX）和GPIO13（RX）。可来回调用。一般默认</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：ESP8266 Serial映射例程</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;GPIO1(TX),GPIO3(RX)&quot;</span>);</span><br><span class="line">  <span class="comment">//调用映射方法</span></span><br><span class="line">  Serial.swap();</span><br><span class="line">  Serial.println(<span class="string">&quot;GPIO15(TX),GPIO13(RX)&quot;</span>);</span><br><span class="line">  <span class="comment">//重新映射回来</span></span><br><span class="line">  Serial.swap();</span><br><span class="line">  Serial.println(<span class="string">&quot;GPIO1(TX),GPIO3(RX)&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>Serial1使用UART1</strong>，默认对应GPIO2（TX）。Serial1不能接收数据（RX被flash芯片占用）,<code>Serial1.begin(baudrate)</code>。</p>
  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;Hello Serial&quot;</span>);</span><br><span class="line">  Serial1.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial1.println(<span class="string">&quot;Hello Serial1&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>若不用Serial1且不映射串口，可将UART0的TX映射到GPIO2：在<code>Serial.begin()</code>之后调用<code>Serial.set_tx(2)</code>或者直接调用<code>Serial.begin(baud,config,mode,2)</code> ;</p>
</li>
<li><p>默认当调用Serial.begin后，将禁用WIFI库的诊断输出，再次启动：<code>Serial.setDebugOutput(true)</code>若将调试输出映射到Serial1时：<code>Serial1.setDebugOutput(true)</code> ;</p>
</li>
<li><p><code>Serial.setRxBufferSize(size_t size)</code>定义接收缓冲区大小，默认256；</p>
</li>
<li><p>Serial和Serial1对象都支持5，6，7，8个数据位，奇数（O），偶数（E）和无（N）奇偶校验，1或2个停止位：<code>Serial.begin(baudrate,SERIAL_8N1)</code></p>
</li>
<li><p>获取当前波特率设置：<code>Serial.baudRate()</code>或<code>Serial1.baudRate()</code></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/plerup/espsoftwareserial">ESP8266软件串口功能</a></p>
</li>
<li><p>检测进入Serial的未知波特率的数据：<code>Serial.detectBaudrate(time_t timeoutMillis)</code> : 尝试在timeoutMillis ms的时间内检测波特率，检测成功返回波特率，失败返回0。<code>detectBaudrate()</code>方法在<code>Serial.begin()</code>之前调用。可使用<code>Serial.begin(detectedBaudrate)</code></p>
</li>
</ul>
<p>示例（WIFI连接）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * statin模式下，创建一个连接到可接入点（wifi热点），并且打印IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;xxxxx&quot;</span> <span class="comment">//这里改成你的wifi名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;xxxxx&quot;</span><span class="comment">//这里改成你的wifi密码</span></span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时2s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup start&quot;</span>);</span><br><span class="line">  <span class="comment">//启动STA模式，并连接到wifi网络</span></span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSW);</span><br><span class="line"> </span><br><span class="line">  DebugPrint(String(<span class="string">&quot;Connecting to &quot;</span>)+AP_SSID);</span><br><span class="line">  <span class="comment">//判断网络状态是否连接上，没连接上就延时500ms，并且打出一个点，模拟连接过程</span></span><br><span class="line">  <span class="comment">//笔者扩展：加入网络一直都连不上 是否可以做个判断，由你们自己实现</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected, IP address: &quot;</span>);</span><br><span class="line">  <span class="comment">//输出station IP地址，这里的IP地址由DHCP分配</span></span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="7、ESP8266与EEPROM"><a href="#7、ESP8266与EEPROM" class="headerlink" title="7、ESP8266与EEPROM"></a>7、ESP8266与EEPROM</h1><h2 id="1、写数据"><a href="#1、写数据" class="headerlink" title="1、写数据"></a>1、写数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 功能描述：该代码向EEPROM写入100字节数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> addr = <span class="number">0</span>; <span class="comment">//EEPROM数据地址</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;Start write&quot;</span>);</span><br><span class="line"></span><br><span class="line">  EEPROM.begin(<span class="number">100</span>);  <span class="comment">//申请size大小的内存大小</span></span><br><span class="line">  <span class="keyword">for</span>(addr = <span class="number">0</span>; addr&lt;<span class="number">100</span>; addr++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">int</span> data = addr;</span><br><span class="line">    EEPROM.write(addr, data); <span class="comment">//写数据</span></span><br><span class="line">  &#125;</span><br><span class="line">  EEPROM.end(); <span class="comment">//写入flash并释放内存空间  保存更改的数据</span></span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;End write&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、读数据"><a href="#2、读数据" class="headerlink" title="2、读数据"></a>2、读数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 功能描述：该代码从EEPROM读取100字节数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> addr = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">9600</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;Start read&quot;</span>);</span><br><span class="line"></span><br><span class="line">  EEPROM.begin(<span class="number">100</span>); </span><br><span class="line">  <span class="keyword">for</span>(addr = <span class="number">0</span>; addr&lt;<span class="number">100</span>; addr++)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">int</span> data = EEPROM.read(addr); <span class="comment">//读数据</span></span><br><span class="line">    Serial.print(data);</span><br><span class="line">    Serial.print(<span class="string">&quot; &quot;</span>);</span><br><span class="line">    delay(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//释放内存</span></span><br><span class="line">  EEPROM.end();</span><br><span class="line">  Serial.println(<span class="string">&quot;End read&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> </span><br><span class="line">&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、清除数据"><a href="#3、清除数据" class="headerlink" title="3、清除数据"></a>3、清除数据</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   EEPROM Clear</span></span><br><span class="line"><span class="comment">   Sets all of the bytes of the EEPROM to 0.</span></span><br><span class="line"><span class="comment">   This example code is in the public domain.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  EEPROM.begin(<span class="number">100</span>);</span><br><span class="line">  <span class="comment">// write a 0 to all 100 bytes of the EEPROM</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">    EEPROM.write(i, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//释放内存</span></span><br><span class="line">  EEPROM.end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="4、结构体操作"><a href="#4、结构体操作" class="headerlink" title="4、结构体操作"></a>4、结构体操作</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 功能描述：eeprom结构体操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;EEPROM.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_STASSID <span class="string">&quot;danpianjicainiao&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEFAULT_STAPSW  <span class="string">&quot;boge&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">config_type</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="type">char</span> stassid[<span class="number">32</span>];</span><br><span class="line">  <span class="type">char</span> stapsw[<span class="number">64</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">config_type config;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 保存参数到EEPROM</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveConfig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.println(<span class="string">&quot;Save config!&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;stassid:&quot;</span>);</span><br><span class="line">  Serial.println(config.stassid);</span><br><span class="line">  Serial.print(<span class="string">&quot;stapsw:&quot;</span>);</span><br><span class="line">  Serial.println(config.stapsw);</span><br><span class="line"></span><br><span class="line">  EEPROM.begin(<span class="number">1024</span>);</span><br><span class="line">  <span class="type">uint8_t</span> *p = (<span class="type">uint8_t</span>*)(&amp;config);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(config); i++)</span><br><span class="line">  &#123;</span><br><span class="line">    EEPROM.write(i, *(p + i));</span><br><span class="line">  &#125;</span><br><span class="line">  EEPROM.commit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 从EEPROM加载参数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">loadConfig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  EEPROM.begin(<span class="number">1024</span>);</span><br><span class="line">  <span class="type">uint8_t</span> *p = (<span class="type">uint8_t</span>*)(&amp;config);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(config); i++)</span><br><span class="line">  &#123;</span><br><span class="line">    *(p + i) = EEPROM.read(i);</span><br><span class="line">  &#125;</span><br><span class="line">  EEPROM.commit();</span><br><span class="line">  Serial.println(<span class="string">&quot;-----Read config-----&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;stassid:&quot;</span>);</span><br><span class="line">  Serial.println(config.stassid);</span><br><span class="line">  Serial.print(<span class="string">&quot;stapsw:&quot;</span>);</span><br><span class="line">  Serial.println(config.stapsw);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*初始化</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  ESP.wdtEnable(<span class="number">5000</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(config.stassid, DEFAULT_STASSID);</span><br><span class="line">  <span class="built_in">strcpy</span>(config.stapsw, DEFAULT_STAPSW);</span><br><span class="line">  saveConfig();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*主循环</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  ESP.wdtFeed();</span><br><span class="line">  loadConfig();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="8、SPI通信"><a href="#8、SPI通信" class="headerlink" title="8、SPI通信"></a>8、SPI通信</h1><h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>​	串行外设接口（Serial Peripheral Interface），高速、全双工、同步通信总线（同一时刻只有一主一从进行通信），四线（MISO:主入从出；MOSI：主出从入；SCK：同步时钟信号；SS或CS：片选使能）。（Quad SPI&#x3D;2Dual SPI&#x3D;4标准SPI）。</p>
<h2 id="2、ESP8266-SPI类库成员函数"><a href="#2、ESP8266-SPI类库成员函数" class="headerlink" title="2、ESP8266 SPI类库成员函数"></a>2、ESP8266 SPI类库成员函数</h2><p>SPI.h头文件中，该类库只提供主设备API</p>
<ol>
<li><code>SPI.begin()</code>  初始化SPI通信；无参，无返回值；</li>
<li><code>SPI.end()</code>关闭SPI通信；无参，无返回值；</li>
<li><code>SPI.setBitOrder(order)</code>设置数据传输顺序；<ul>
<li>参数（order）：<ul>
<li>~ LSBFIRST，低位在前；</li>
<li>~ MSBFIRST，高位在前；</li>
</ul>
</li>
<li>无返回值；</li>
</ul>
</li>
<li><code>SPI.setClockDivider(divider)</code>设置通信时钟（由系统时钟分频）<ul>
<li>参数（divider）:<ul>
<li>~ SPI_CLOCK_DIV2, 2分频；</li>
<li>~ SPI_CLOCK_DIV4, 4分频；</li>
<li>~ SPI_CLOCK_DIV8, 8分频；</li>
<li>~ SPI_CLOCK_DIV16, 16分频；</li>
<li>~ SPI_CLOCK_DIV32, 32分频；</li>
<li>~ SPI_CLOCK_DIV64, 64分频；</li>
<li>~ SPI_CLOCK_DIV128, 128分频；</li>
</ul>
</li>
<li>无返回值；</li>
</ul>
</li>
<li><code>SPI.setDataMode(mode)</code>设置数据模式<ul>
<li>参数（mode）:<ul>
<li>~ SPI_MODE0;				即：CPOL&#x3D;0,CPHA&#x3D;0</li>
<li>~ SPI_MODE1;                即：CPOL&#x3D;0,CPHA&#x3D;1</li>
<li>~ SPI_MODE2;                即：CPOL&#x3D;1,CPHA&#x3D;0</li>
<li>~ SPI_MODE3;                即：CPOL&#x3D;1,CPHA&#x3D;1</li>
</ul>
</li>
<li>无返回值</li>
<li>补充：四种模式，即SPI相位（CPHA）和极性（CPOL）分别为0或1;<ul>
<li>CPOL：即SPI空闲时，SCLK的电平（1高，0低）；</li>
<li>CPHA：即SPI在SCLK的第几个边沿开始采样（0第一个，1第二个）；</li>
</ul>
</li>
</ul>
</li>
<li><code>SPI.transfer(val)</code>传输1B的数据。全双工，发1B收1B数据</li>
<li><code>SPI.transfer16(val)</code>传输2B数据，从机返回2B作为返回值；</li>
<li><code>SPI.transferBuf(buf,count)</code>传输一个缓冲区数据，参数为发送的缓冲区buf（<code>uint8_t*</code>数据），count位缓冲区大小，无返回值（但从机传输来的数据会替换掉buf缓冲区的数据）</li>
<li><code>SPI.pins(sck,miso,mosi,ss)</code>切换SPI引脚映射，需在<code>SPI.begin()</code>前调用</li>
</ol>
<h2 id="3、SPI寄存器"><a href="#3、SPI寄存器" class="headerlink" title="3、SPI寄存器"></a>3、SPI寄存器</h2><p>所有SPI设置都是由Arduino SPI控制寄存器（SPCR）决定。该寄存器就是MCU内存的一个字节，可读写。寄存器提供服务：控制、数据、状态。</p>
<ol>
<li><p>控制寄存器（SPCR）：</p>
<p>8位，（如单片机的中断允许控制寄存器IE、中断优先级控制寄存器IP、定时器&#x2F;计数器控制寄存器）</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fFaWEn"><img src="https://z3.ax1x.com/2021/08/03/fFaWEn.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/03/fFaWEn.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fFaWEn.png"></a></p>
</li>
<li><p>数据寄存器（SPDR）：</p>
<p>（如串行口锁存器SBUF，仅hold住一个字节）</p>
</li>
<li><p>状态寄存器（SPSR）:</p>
<p>​	根据多种微控制器的条件改变其状态</p>
</li>
</ol>
<h1 id="10、Ticker-—ESP8266定时库"><a href="#10、Ticker-—ESP8266定时库" class="headerlink" title="10、Ticker —ESP8266定时库"></a>10、Ticker —ESP8266定时库</h1><h2 id="1、概述-1"><a href="#1、概述-1" class="headerlink" title="1、概述"></a>1、概述</h2><ul>
<li>用于规定时间后调用函数；</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fAfIxg"><img src="https://z3.ax1x.com/2021/08/04/fAfIxg.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/04/fAfIxg.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fAfIxg.png"></a></p>
<ul>
<li>一个方法的示例（为了说明三个参数时的意义，两个参数时好理解）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔xx毫秒周期性执行</span></span><br><span class="line"><span class="comment"> * @param seconds 秒数</span></span><br><span class="line"><span class="comment"> * @param callback 回调函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">attach_ms</span><span class="params">(<span class="type">float</span> seconds, <span class="type">callback_function_t</span> callback)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 每隔xx毫秒周期性执行</span></span><br><span class="line"><span class="comment"> * @param seconds 秒数</span></span><br><span class="line"><span class="comment"> * @param callback 回调函数</span></span><br><span class="line"><span class="comment"> * @param arg 回调函数的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">attach_ms</span><span class="params">(<span class="type">uint32_t</span> milliseconds, <span class="type">void</span> (*callback)(TArg), TArg arg)</span></span><br></pre></td></tr></table></figure>

<ul>
<li>不建议使用Ticker回调函数来阻塞IO操作（网络、串口、文件）；可以在Ticker回调函数中设置一个标记，在loop函数中检测这个标记；</li>
<li>对于arg，必须时char, short, int, float, void* , char* 之一；</li>
</ul>
<h2 id="2、示例"><a href="#2、示例" class="headerlink" title="2、示例"></a>2、示例</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代码功能：板载LED开始0.3秒闪，闪20次开始以0.1秒快闪，总共闪120次后最后常亮 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Ticker.h&gt;</span></span></span><br><span class="line">Ticker flipper;</span><br><span class="line"><span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">flip</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">int</span> state = digitalRead(LED_BUILTIN);  <span class="comment">// get the current state of GPIO1 pin</span></span><br><span class="line">  digitalWrite(LED_BUILTIN, !state);     <span class="comment">// set pin to the opposite state</span></span><br><span class="line">  ++count;</span><br><span class="line">  <span class="comment">// 当翻转次数达到20次的时候，切换led的闪烁频率，每隔0.1s翻转一次</span></span><br><span class="line">  <span class="keyword">if</span> (count == <span class="number">20</span>) &#123;</span><br><span class="line">    flipper.attach(<span class="number">0.1</span>, flip);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 当次数达到120次的时候关闭ticker</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (count == <span class="number">120</span>) &#123;</span><br><span class="line">    flipper.detach();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//LED_BUILTIN 对应板载LED的IO口</span></span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">  digitalWrite(LED_BUILTIN, LOW);</span><br><span class="line">  <span class="comment">//每隔0.3s 翻转一下led状态</span></span><br><span class="line">  flipper.attach(<span class="number">0.3</span>, flip);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*板载LED每隔25ms灭，每隔26ms亮</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Ticker.h&gt;</span></span></span><br><span class="line">Ticker tickerSetHigh;</span><br><span class="line">Ticker tickerSetLow;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setPin</span><span class="params">(<span class="type">int</span> state)</span> &#123;</span><br><span class="line">  digitalWrite(LED_BUILTIN, state);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">  digitalWrite(LED_BUILTIN, LOW);</span><br><span class="line">  <span class="comment">// 每隔25ms调用一次 setPin(0)</span></span><br><span class="line">  tickerSetLow.attach_ms(<span class="number">25</span>, setPin, <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// 每隔26ms调用一次 setPin(1)</span></span><br><span class="line">  tickerSetHigh.attach_ms(<span class="number">26</span>, setPin, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="11、Arduino-Core-For-ESP8266"><a href="#11、Arduino-Core-For-ESP8266" class="headerlink" title="11、Arduino Core For ESP8266"></a>11、Arduino Core For ESP8266</h1><ul>
<li><p>源码：<a target="_blank" rel="noopener" href="https://github.com/esp8266/Arduino">Arduino Core For ESP8266 github</a></p>
</li>
<li><p>资料：<a target="_blank" rel="noopener" href="https://arduino-esp8266.readthedocs.io/en/latest/index.html">ESP8266 Arduino Core </a></p>
</li>
<li><p>概述：</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fECKd1"><img src="https://z3.ax1x.com/2021/08/04/fECKd1.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/04/fECKd1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fECKd1.png" style="zoom: 150%;" /></a></p>
<h1 id="12、ESP8266工作模式与ESP8266WIFI库"><a href="#12、ESP8266工作模式与ESP8266WIFI库" class="headerlink" title="12、ESP8266工作模式与ESP8266WIFI库"></a>12、ESP8266工作模式与ESP8266WIFI库</h1><h2 id="1、ESP8266工作模式"><a href="#1、ESP8266工作模式" class="headerlink" title="1、ESP8266工作模式"></a>1、ESP8266工作模式</h2><ol>
<li><p>Station模式（STA）：</p>
<p>ESP8266模块连接WIFI网络（通过接入点（Access Point））</p>
<p><strong>特点</strong>：</p>
<ul>
<li>连接丢失，ESP8266会自动重连最近使用的接入点（会出问题，连不上）；</li>
<li>模块重启也会这样；</li>
<li>ESP8266将最后使用的接入点认证信息（ssid , psw）保存到Flash（非易失性）存储器中；</li>
<li>若在Arduino IDE修改代码，但不更改WIFI工作模式或接入点认证信息，ESP8266使用保存在Flash上的数据重新连接。</li>
</ul>
</li>
<li><p>AP模式（soft-AP）:</p>
<p>(Access Point) ESP8266作为接入点建立WIFI网络，供Station模式下的模块连接</p>
<p><strong>特点</strong>：</p>
<ul>
<li>AP模式可用作STA模式的模块之间交换中转站（让模块处于同一WIFI网络下）；</li>
<li>可先在AP模式下发出WIFI信号，手机连接，高速该模块家里的WIFI认证信息，模块转为STA模式，连接目标WIFI。</li>
</ul>
</li>
<li><p>AP兼STA模式：</p>
<p>以上两种模式的整合（应该是做软路由那个意思）</p>
</li>
</ol>
<h2 id="2、ESP8266WIFI库"><a href="#2、ESP8266WIFI库" class="headerlink" title="2、ESP8266WIFI库"></a>2、ESP8266WIFI库</h2><p>概述：</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fEDZ5Q"><img src="https://z3.ax1x.com/2021/08/04/fEDZ5Q.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/04/fEDZ5Q.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fEDZ5Q.png"></a></p>
<p><strong>相关知识</strong>：</p>
<ol>
<li><p>名字里带Secure、SSL、TLS的，和安全校验有关（https）；</p>
</li>
<li><p>带Client，和tcp客户端（发送端）有关；</p>
</li>
<li><p>带Server，和tcp服务端（接收端）有关；</p>
</li>
<li><p>带8266，针对ESP8266的代码封装；</p>
</li>
<li><p>带Scan，和WIFI扫描有关；</p>
</li>
<li><p>带STA，和ESP8266 Station模式有关；</p>
</li>
<li><p>带AP，和ESP8266 AP模式（AP热点）有关；</p>
</li>
<li><p>ESP8266WiFiGeneric（8266模块通用库）包括：处理程序来管理WIFI事件，如连接、断开或获得ip，WIFI模式的变化，管理模块睡眠模式的功能，以ip地址解析hostName等；</p>
</li>
<li><p>ESP8266WiFiGType.h文件，主要用来定义各种配置选项，如WIFI工作模式（WiFiMode）,WiFi睡眠模式（WiFiSleep Type）,wifi物理模式（WiFiPhyMode）,wifi事件（WiFiEvent），wifi断开原因等；</p>
</li>
<li><p>ESP8266WiFi库不仅仅局限于ESP8266WIFi.h和ESP8266WiFi.cpp这两个文件，但他们是最核心的统一入口；</p>
</li>
<li><p>WiFiUdp库，在ESP8266WiFi功能基础上包装了UDP广播协议，适用于UDP通信，需另加头文件</p>
<p><strong>引入<code>#include&lt;ESP8266WiFi.h&gt;</code>一步到位</strong></p>
</li>
</ol>
<p><strong>详解</strong>：</p>
<h3 id="1、WIFI通用功能库（ESP8266WiFiGeneric）："><a href="#1、WIFI通用功能库（ESP8266WiFiGeneric）：" class="headerlink" title="1、WIFI通用功能库（ESP8266WiFiGeneric）："></a>1、WIFI通用功能库（ESP8266WiFiGeneric）：</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fErOte"><img src="https://z3.ax1x.com/2021/08/04/fErOte.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/04/fErOte.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fErOte.png"></a></p>
<h3 id="2、STA库（ESP8266WiFiSTA）："><a href="#2、STA库（ESP8266WiFiSTA）：" class="headerlink" title="2、STA库（ESP8266WiFiSTA）："></a>2、STA库（ESP8266WiFiSTA）：</h3><ol>
<li><p>配置连接：</p>
<p><strong>注意</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WiFi.mode(WIFI_STA);<span class="comment">//最好人为加上STA设置（虽然默认是STA模式）</span></span><br><span class="line">WiFi.disconnect();<span class="comment">//最好调用一下断连</span></span><br><span class="line"><span class="comment">/*如果之前处于AP模式，再调begin()可能会进入STA+softAp模式</span></span><br><span class="line"><span class="comment">*可检测当前模式（WiFi.getMode()）</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<ul>
<li>切换到STA模式（<code>begin()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 切换工作模式到STA模式，并自动连接到最近接入的wifi热点</span></span><br><span class="line"><span class="comment">* @param void</span></span><br><span class="line"><span class="comment">* @return void</span></span><br><span class="line"><span class="comment">* @note 调用这个方法就会切换到STA模式，并且连接到最近使用的接入点（会从flash中读取之前存储的配置信息）</span></span><br><span class="line"><span class="comment">* 		如果没有配置信息，那么这个方法基本上没有什么用。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">wl_status_t</span> <span class="title function_">begin</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WiFi.begin();</span><br></pre></td></tr></table></figure>

<ul>
<li>切换到STA模式（<code>begin(ssid,psw)</code>）</li>
</ul>
<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WiFi.begin(AP_SSID, AP_PSW);</span><br></pre></td></tr></table></figure>

<ul>
<li>切换到STA模式（<code>begin(ssid,psw,channel,bssid,connect)</code>）</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 切换工作模式到STA模式，并根据connect属性来判断是否连接wifi</span></span><br><span class="line"><span class="comment">* @param ssid       wifi热点名字</span></span><br><span class="line"><span class="comment">* @param password   wifi热点密码</span></span><br><span class="line"><span class="comment">* @param channel    wifi热点的通道号，用特定通信通信，可选参数</span></span><br><span class="line"><span class="comment">* @param bssid      wifi热点的mac地址，可选参数</span></span><br><span class="line"><span class="comment">* @param connect    boolean参数，默认等于true，当设置为false，不会去连接wifi热点，会建立module保存上面参数</span></span><br><span class="line"><span class="comment">* @return wl_status_t  wifi状态</span></span><br><span class="line"><span class="comment">* @note 调用这个方法就会切换到STA模式。</span></span><br><span class="line"><span class="comment">*       如果connect等于true，会连接到ssid的wifi热点。</span></span><br><span class="line"><span class="comment">*       如果connect等于false，不会连接到ssid的wifi热点，会建立module保存上面参数。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">wl_status_t</span> <span class="title function_">begin</span><span class="params">(<span class="type">char</span>* ssid, <span class="type">char</span> *passphrase = <span class="literal">NULL</span>, <span class="type">int32_t</span> channel =<span class="number">0</span>, <span class="type">const</span> <span class="type">uint8_t</span>* bssid = <span class="literal">NULL</span>, <span class="type">bool</span> connect = <span class="literal">true</span></span></span><br><span class="line"><span class="params"></span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置IP信息（<code>config(local_ip,gateway,subnet,dns1,dns2)</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 禁止DHCP client，设置station 模式下的IP配置</span></span><br><span class="line"><span class="comment">* @param  local_ip    station固定的ip地址(连接快)</span></span><br><span class="line"><span class="comment">* @param  gateway     网关</span></span><br><span class="line"><span class="comment">* @param  subnet      子网掩码（前3个参数都设置为0.0.0.0，则重启DHCP）</span></span><br><span class="line"><span class="comment">* @param  dns1，dns2  可选参数定义域名服务器（dns）的ip地址，这些域名服务器</span></span><br><span class="line"><span class="comment">*                     维护一个域名目录（如www.google.co.uk），并将它们翻译成ip地址  </span></span><br><span class="line"><span class="comment">* @return boolean值，如果配置成功，返回true；</span></span><br><span class="line"><span class="comment">*         如果配置没成功（模块没处于station或者station+soft AP模式），返回false；</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">config</span><span class="params">(IPAddress local_ip, IPAddress gateway, IPAddress subnet, IPAddress dns1 = (<span class="type">uint32_t</span>)<span class="number">0x00000000</span>, IPAddress dns2 = (<span class="type">uint32_t</span>)<span class="number">0x00000000</span>)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>管理连接：</p>
<ul>
<li>重新连接网络（<code>reconnect()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 断开连接并且重新连接station到同一个AP</span></span><br><span class="line"><span class="comment">* @param void</span></span><br><span class="line"><span class="comment">* @return false or true</span></span><br><span class="line"><span class="comment">*         返回false，意味着ESP8266不处于STA模式或者说Station在此之前没有连接到一个可接入点。</span></span><br><span class="line"><span class="comment">*         返回true，意味着已经成功重新启动连接，但是用户仍应该去检测网络连接状态指导WL_CONNECTED。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">reconnect</span><span class="params">()</span></span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">WiFi.reconnect();</span><br><span class="line"><span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)</span><br><span class="line">&#123;</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>断开网络连接（<code>disconnect()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 断开wifi连接，设置当前配置SSID和pwd为null</span></span><br><span class="line"><span class="comment">* @param wifioff 可选参数，设置为true，那么就会关闭Station模式</span></span><br><span class="line"><span class="comment">* @return false or true 返回wl_status_t状态</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">disconnect</span><span class="params">(<span class="type">bool</span> wifioff = <span class="literal">false</span>)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>是否连接网络（<code>isConnected()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 判断STA模式下是否连接上AP</span></span><br><span class="line"><span class="comment">* @return 如果STA连接上AP，那么就返回true</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">isConnected</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>设置是否自动连接到最近接入点（<code>setAutoConnect(bool autoReconnect)</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 当电源启动后，设置ESP8266在STA模式下是否自动连接flash中存储的AP</span></span><br><span class="line"><span class="comment">* @param autoConnect bool 默认是自动连接</span></span><br><span class="line"><span class="comment">* @return 返回保存状态 true or false</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">setAutoConnect</span><span class="params">(<span class="type">bool</span> autoConnect)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>判断是否自动设置自动连接（<code>getAutoConnect()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 检测ESP8266 station模式下是否启动自动连接</span></span><br><span class="line"><span class="comment">* @return 返回自动连接状态 true or false</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">getAutoConnect</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>设置是否自动重连到最近接入点（<code>setAutoReconnect(bool autoReconnect)</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 设置当断开连接的时候是否自动重连</span></span><br><span class="line"><span class="comment">*  网络断开后再设置无效</span></span><br><span class="line"><span class="comment">* @param autoConnect bool</span></span><br><span class="line"><span class="comment">* @return 返回保存状态 true or false</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">setAutoReconnect</span><span class="params">(<span class="type">bool</span> autoReconnect)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>判断网络连接状态（<code>waitForConnectResult()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 等待直到ESP8266连接AP返回结果</span></span><br><span class="line"><span class="comment">* @return uint8_t 连接结果</span></span><br><span class="line"><span class="comment">*         1.WL_CONNECTED 成功连接</span></span><br><span class="line"><span class="comment">*         2.WL_NO_SSID_AVAIL  匹配SSID失败（账号错误）</span></span><br><span class="line"><span class="comment">*         3.WL_CONNECT_FAILED psw错误</span></span><br><span class="line"><span class="comment">*         4.WL_IDLE_STATUS 当wi-fi正在不同的状态中变化</span></span><br><span class="line"><span class="comment">*         5.WL_DISCONNECTED 这个模块没有配置STA模式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">waitForConnectResult</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>station信息：</p>
<ul>
<li>获取mac地址<ul>
<li><code>macAddress(macAddr)</code></li>
<li><code>macAddress()</code></li>
</ul>
</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取ESP station下的Mac地址</span></span><br><span class="line"><span class="comment"> * @param mac   uint8_t数组的指针，数组长度为Mac地址的长度，这里为6</span></span><br><span class="line"><span class="comment"> * @return      返回uint8_t数组的指针</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint8_t</span> * <span class="title function_">macAddress</span><span class="params">(<span class="type">uint8_t</span>* mac)</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取ESP station下的Mac地址</span></span><br><span class="line"><span class="comment"> * @return  返回String的Mac地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">macAddress</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码1 这只是部分代码 不能直接使用</span></span><br><span class="line"><span class="keyword">if</span> (WiFi.status() == WL_CONNECTED)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint8_t</span> macAddr[<span class="number">6</span>];</span><br><span class="line">  WiFi.macAddress(macAddr);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Connected, mac address: %02x:%02x:%02x:%02x:%02x:%02x\n&quot;</span>, macAddr[<span class="number">0</span>], macAddr[<span class="number">1</span>], macAddr[<span class="number">2</span>], macAddr[<span class="number">3</span>], macAddr[<span class="number">4</span>], macAddr[<span class="number">5</span>]);</span><br><span class="line">  <span class="comment">//Connected, mac address: 5C:CF:7F:08:11:17</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//实例代码2 这只是部分代码 不能直接使用</span></span><br><span class="line"><span class="keyword">if</span> (WiFi.status() == WL_CONNECTED)</span><br><span class="line">&#123;</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Connected, mac address: %s\n&quot;</span>, WiFi.macAddress().c_str());</span><br><span class="line">  Connected, mac address: <span class="number">5</span>C:CF:<span class="number">7F</span>:<span class="number">08</span>:<span class="number">11</span>:<span class="number">17</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取ip地址（<code>localIP()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回ESP8266 STA模式下的IP地址</span></span><br><span class="line"><span class="comment"> * @return IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IPAddress <span class="title function_">localIP</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (WiFi.status() == WL_CONNECTED)</span><br><span class="line">&#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Connected, IP address: &quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());</span><br><span class="line">  <span class="comment">//Connected, IP address: 192.168.1.10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取子网掩码（<code>subnetMask()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取子网掩码的地址</span></span><br><span class="line"><span class="comment"> * @return 返回子网掩码的IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IPAddress <span class="title function_">subnetMask</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Serial.print(<span class="string">&quot;Subnet mask: &quot;</span>);</span><br><span class="line">Serial.println(WiFi.subnetMask());</span><br><span class="line"><span class="comment">//Subnet mask: 255.255.255.0</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取网关地址（<code>getwayIP()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取网关IP地址</span></span><br><span class="line"><span class="comment"> * @return 返回网关IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IPAddress <span class="title function_">gatewayIP</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码 这只是部分代码 不能直接使用</span></span><br><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;Gataway IP: %s\n&quot;</span>, WiFi.gatewayIP().toString().c_str());</span><br><span class="line"><span class="comment">//Gataway IP: 192.168.1.9</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取dns地址（<code>dnsIP()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取DNS ip地址</span></span><br><span class="line"><span class="comment"> * @param dns_no dns序列号</span></span><br><span class="line"><span class="comment"> * @return 返回DNS服务的IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">IPAddress <span class="title function_">dnsIP</span><span class="params">(<span class="type">uint8_t</span> dns_no = <span class="number">0</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Serial.print(<span class="string">&quot;DNS #1, #2 IP: &quot;</span>);</span><br><span class="line">WiFi.dnsIP().printTo(Serial);</span><br><span class="line">Serial.print(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">WiFi.dnsIP(<span class="number">1</span>).printTo(Serial);</span><br><span class="line">Serial.println();</span><br><span class="line"><span class="comment">//DNS #1, #2 IP: 62.179.1.60, 62.179.1.61</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取host名字（<code>hostname()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取ESP8266 station DHCP的主机名</span></span><br><span class="line"><span class="comment"> * @return 主机名</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">hostname</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>设置host名字（<code>hostname(hostname)</code>）（3种）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 设置ESP8266 station DHCP的主机名</span></span><br><span class="line"><span class="comment"> * @param aHostname 最大长度:32</span></span><br><span class="line"><span class="comment"> * @return ok</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">hostname</span><span class="params">(<span class="type">char</span>* aHostname)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">hostname</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* aHostname)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">hostname</span><span class="params">(String aHostname)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;Default hostname: %s\n&quot;</span>, WiFi.hostname().c_str());</span><br><span class="line">WiFi.hostname(<span class="string">&quot;Station_Tester_02&quot;</span>);</span><br><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;New hostname: %s\n&quot;</span>, WiFi.hostname().c_str());</span><br><span class="line"><span class="comment">//Default hostname: ESP_081117</span></span><br><span class="line"><span class="comment">//New hostname: Station_Tester_02</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取当前wifi连接状态（<code>status()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回wifi的连接状态</span></span><br><span class="line"><span class="comment"> * @return 返回wl_status_t中定义的其中一值，wl_status_t在 wl_definitions.h中定义</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">wl_status_t</span> <span class="title function_">status</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取wifi网络名字（<code>SSID()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回当前通信网络的SSID</span></span><br><span class="line"><span class="comment"> * @return SSID</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">SSID</span><span class="params">()</span> <span class="type">const</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码 这只是部分代码 不能直接使用</span></span><br><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;SSID: %s\n&quot;</span>, WiFi.SSID().c_str());</span><br><span class="line"><span class="comment">//SSID: sensor-net</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取wifi网络密码（<code>psk()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回当前通信网络的密码</span></span><br><span class="line"><span class="comment"> * @return psk</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">psk</span><span class="params">()</span> <span class="type">const</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>获取wifi网络macaddress（<code>BSSID()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回当前通信网络的mac地址</span></span><br><span class="line"><span class="comment"> * @return bssid uint8_t *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint8_t</span> * <span class="title function_">BSSID</span><span class="params">()</span>;</span><br><span class="line">String <span class="title function_">BSSIDstr</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;BSSID: %s\n&quot;</span>, WiFi.BSSIDstr().c_str());</span><br><span class="line"><span class="comment">//BSSID: 00:1A:70E:C1:68</span></span><br></pre></td></tr></table></figure>

<ul>
<li>获取wifi网络的信号强度（<code>RSSI()</code>）</li>
</ul>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the current network RSSI.返回当前通信网络的信号强度，单位是dBm</span></span><br><span class="line"><span class="comment"> * @return  RSSI value</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">RSSI</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Serial.<span class="built_in">printf</span>(<span class="string">&quot;RSSI: %d dBm\n&quot;</span>, WiFi.RSSI());</span><br><span class="line"><span class="comment">//RSSI: -68 dBm</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>智能配置：</p>
<ul>
<li>进入智能配置功能（<code>beginSmartConfig()</code>）</li>
<li>查询智能配置状态（<code>smartConfigDone()</code>）</li>
<li>停止智能配置功能（<code>stopSmartConfig()</code>）</li>
<li><code>WiFi.beginWPSConfig()</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">beginWPSConfig</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 启动 SmartConfig</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">beginSmartConfig</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 停止 SmartConfig</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">stopSmartConfig</span><span class="params">()</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查找SmartConfig状态来决定是否停止配置</span></span><br><span class="line"><span class="comment"> * @return smartConfig Done</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">smartConfigDone</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="3、AP库（ESP8266WIFIAP）"><a href="#3、AP库（ESP8266WIFIAP）" class="headerlink" title="3、AP库（ESP8266WIFIAP）"></a>3、AP库（ESP8266WIFIAP）</h3><ol>
<li>配置soft-AP:<ul>
<li>启动开放式wifi网络（<code>softAP(ssid)</code>）</li>
<li>启动校验式wifi网络（<code>softAP(ssid,password,channel,hidden)</code>）</li>
<li>配置ap网络信息（<code>softAPConfig(local_ip,gateway,subnet)</code>）</li>
</ul>
</li>
<li>管理网络：<ul>
<li>获取连接到AP上的station的数目（<code>softAPgetStationNum()</code>）</li>
<li>关闭AP模式（<code>softAPdisconnect(bool wifi off)</code>）</li>
</ul>
</li>
<li>网络信息：<ul>
<li>获取ap的IP地址（<code>softAPIP()</code>）</li>
<li>获取ap的mac地址（<code>softAPmacAddress()</code>）</li>
</ul>
</li>
</ol>
<h3 id="4、WiFi扫描库（ESP8266WiFiScan）"><a href="#4、WiFi扫描库（ESP8266WiFiScan）" class="headerlink" title="4、WiFi扫描库（ESP8266WiFiScan）:"></a>4、WiFi扫描库（ESP8266WiFiScan）:</h3><p>一般使用异步扫描（不影响代码运行）</p>
<ol>
<li><p>扫描操作：</p>
<ul>
<li><p>同步扫描周边有效wifi网络（<code>scanNetworks()</code>）</p>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Start scan WiFi networks available</span></span><br><span class="line"><span class="comment"> * @param async         run in async mode(是否启动异步扫描)</span></span><br><span class="line"><span class="comment"> * @param show_hidden   show hidden networks(是否扫描隐藏网络)</span></span><br><span class="line"><span class="comment"> * @param channel       scan only this channel (0 for all channels)(是否扫描特定通道)</span></span><br><span class="line"><span class="comment"> * @param ssid*         scan for only this ssid (NULL for all ssid&#x27;s)(是否扫描特定的SSID)</span></span><br><span class="line"><span class="comment"> * @return Number of discovered networks</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">scanNetworks</span><span class="params">(<span class="type">bool</span> async = <span class="literal">false</span>, <span class="type">bool</span> show_hidden = <span class="literal">false</span>, uint8 channel = <span class="number">0</span>, uint8* ssid = <span class="literal">NULL</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码 这只是部分代码 不能直接使用</span></span><br><span class="line"><span class="comment">//同步扫描</span></span><br><span class="line"><span class="type">int</span> n = WiFi.scanNetworks();<span class="comment">//不需要填任何参数</span></span><br><span class="line">Serial.println(<span class="string">&quot;scan done&quot;</span>);</span><br><span class="line"><span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;no networks found&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot; networks found&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>异步扫描周边有效wifi网络，包括隐藏网络（<code>scanNetworks(bool async,bool show_hiden)</code>）</p>
<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码 这只是部分代码 不能直接使用</span></span><br><span class="line"><span class="comment">//异步扫描</span></span><br><span class="line">WiFi.scanNetworks(<span class="literal">true</span>);</span><br><span class="line"><span class="comment">// print out Wi-Fi network scan result uppon completion</span></span><br><span class="line"><span class="type">int</span> n = WiFi.scanComplete();</span><br><span class="line"><span class="keyword">if</span>(n &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d network(s) found\n&quot;</span>, n);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">     Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d: %s, Ch:%d (%ddBm) %s\n&quot;</span>, i+<span class="number">1</span>, WiFi.SSID(i).c_str(), WiFi.channel(i), WiFi.RSSI(i), WiFi.encryptionType(i) == ENC_TYPE_NONE ? <span class="string">&quot;open&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//打印一次结果之后把缓存中的数据清掉</span></span><br><span class="line">  WiFi.scanDelete();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>检测异步扫描的结果（<code>scanComplete()</code>）</p>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * called to get the scan state in Async mode(异步扫描的结果函数)</span></span><br><span class="line"><span class="comment"> * @return scan result or status</span></span><br><span class="line"><span class="comment"> *          -1 if scan not find</span></span><br><span class="line"><span class="comment"> *          -2 if scan not triggered</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int8_t</span> <span class="title function_">scanComplete</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>从内存中删除最近扫描结果（<code>scanDelete()</code>）</p>
<p>如果不删除，则会叠加上次扫描结果；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * delete last scan result from RAM(从内存中删除最近的扫描结果)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">scanDelete</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>异步扫描周边wifi网络，并回调结果（<code>scanNetworkAsync(onComplete,show_hidden)</code>）</p>
<p><strong>源码：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Starts scanning WiFi networks available in async mode</span></span><br><span class="line"><span class="comment"> * @param onComplete    the event handler executed when the scan is done</span></span><br><span class="line"><span class="comment"> * @param show_hidden   show hidden networks</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">scanNetworksAsync</span><span class="params">(<span class="built_in">std</span>::function&lt;<span class="type">void</span>(<span class="type">int</span>)&gt; onComplete, <span class="type">bool</span> show_hidden = <span class="literal">false</span>)</span>;</span><br></pre></td></tr></table></figure>

<p><strong>应用：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实例代码</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ESP8266WiFi.h&quot;</span></span></span><br><span class="line"><span class="type">void</span> <span class="title function_">prinScanResult</span><span class="params">(<span class="type">int</span> networksFound)</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d network(s) found\n&quot;</span>, networksFound);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; networksFound; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d: %s, Ch:%d (%ddBm) %s\n&quot;</span>, i + <span class="number">1</span>, WiFi.SSID(i).c_str(), WiFi.channel(i), WiFi.RSSI(i), WiFi.encryptionType(i) == ENC_TYPE_NONE ? <span class="string">&quot;open&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line"> </span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line"> </span><br><span class="line">  WiFi.scanNetworksAsync(prinScanResult);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"><span class="comment">//应该会打印如下类似的显示</span></span><br><span class="line"><span class="comment">//5 network(s) found</span></span><br><span class="line"><span class="comment">//1: Tech_D005107, Ch:6 (-72dBm)</span></span><br><span class="line"><span class="comment">//2: HP-Print-A2-Photosmart 7520, Ch:6 (-79dBm)</span></span><br><span class="line"><span class="comment">//3: ESP_0B09E3, Ch:9 (-89dBm) open</span></span><br><span class="line"><span class="comment">//4: Hack-4-fun-net, Ch:9 (-91dBm)</span></span><br><span class="line"><span class="comment">//5: UPC Wi-Free, Ch:11 (-79dBm)</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>扫描结果：</p>
<ul>
<li><p>获取wifi网络名字（<code>SSID(int networkltem)</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the SSID discovered during the network scan.</span></span><br><span class="line"><span class="comment"> * @param i     specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return       ssid string of the specified item on the networks scanned list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">SSID</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取wifi网络信号强度（<code>RSS(int networkltem)</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the RSSI of the networks discovered during the scanNetworks(信号强度)</span></span><br><span class="line"><span class="comment"> * @param i specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return  signed value of RSSI of the specified item on the networks scanned list</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">RSSI</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取wifi网络加密方式（<code>encryption Type(int networkltem)</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the encryption type of the networks discovered during the scanNetworks(加密方式)</span></span><br><span class="line"><span class="comment"> * @param i specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return  encryption type (enum wl_enc_type) of the specified item on the networks scanned list</span></span><br><span class="line"><span class="comment"> * ............ Values map to 802.11 encryption suites.....................</span></span><br><span class="line"><span class="comment"> *    AUTH_OPEN          ----&gt;     ENC_TYPE_WEP  = 5,</span></span><br><span class="line"><span class="comment"> *    AUTH_WEP           ----&gt;     ENC_TYPE_TKIP = 2,</span></span><br><span class="line"><span class="comment"> *    AUTH_WPA_PSK       ----&gt;     ENC_TYPE_CCMP = 4,</span></span><br><span class="line"><span class="comment"> * ........... except these two, 7 and 8 are reserved in 802.11-2007.......</span></span><br><span class="line"><span class="comment"> *    AUTH_WPA2_PSK      ----&gt;     ENC_TYPE_NONE = 7,</span></span><br><span class="line"><span class="comment"> *    AUTH_WPA_WPA2_PSK  ----&gt;     ENC_TYPE_AUTO = 8</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint8_t</span> <span class="title function_">encryptionType</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取wifi网络mac地址（<code>BSSID(int networkltem)</code>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * return MAC / BSSID of scanned wifi (物理地址)</span></span><br><span class="line"><span class="comment"> * @param i specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return uint8_t * MAC / BSSID of scanned wifi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">uint8_t</span> * <span class="title function_">BSSID</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * return MAC / BSSID of scanned wifi (物理地址)</span></span><br><span class="line"><span class="comment"> * @param i specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return uint8_t * MAC / BSSID of scanned wifi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">String <span class="title function_">BSSIDstr</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取整体网络信息，名字，信号强度等（<code>getNetworkInfo</code>）</p>
<p>入参前面多数加了&amp;，意味着调完函数后外面获取到的详细洗信息；</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * loads all infos from a scanned wifi in to the ptr parameters</span></span><br><span class="line"><span class="comment"> * @param networkItem uint8_t</span></span><br><span class="line"><span class="comment"> * @param ssid  const char**</span></span><br><span class="line"><span class="comment"> * @param encryptionType uint8_t *</span></span><br><span class="line"><span class="comment"> * @param RSSI int32_t *</span></span><br><span class="line"><span class="comment"> * @param BSSID uint8_t **</span></span><br><span class="line"><span class="comment"> * @param channel int32_t *</span></span><br><span class="line"><span class="comment"> * @param isHidden bool *</span></span><br><span class="line"><span class="comment"> * @return (true if ok)</span></span><br><span class="line"><span class="comment"> */</span>        </span><br><span class="line"><span class="type">bool</span> <span class="title function_">getNetworkInfo</span><span class="params">(<span class="type">uint8_t</span> networkItem, String &amp;ssid, <span class="type">uint8_t</span> &amp;encryptionType, <span class="type">int32_t</span> &amp;RSSI, <span class="type">uint8_t</span>* &amp;BSSID, <span class="type">int32_t</span> &amp;channel, <span class="type">bool</span> &amp;isHidden)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>获取wifi网络通道号</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * return channel of scanned wifi(通道号)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int32_t</span> <span class="title function_">channel</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>判断wifi网络是否是隐藏网络</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * return if the scanned wifi is Hidden (no SSID)(判断扫描到的wifi是否是隐藏wifi)</span></span><br><span class="line"><span class="comment"> * @param networkItem specify from which network item want to get the information</span></span><br><span class="line"><span class="comment"> * @return bool (true == hidden)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">isHidden</span><span class="params">(<span class="type">uint8_t</span> networkItem)</span>;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ol>
<h3 id="5、TCP客户端（WiFiClient）"><a href="#5、TCP客户端（WiFiClient）" class="headerlink" title="5、TCP客户端（WiFiClient）:"></a>5、TCP客户端（WiFiClient）:</h3><p><strong>TCP与HTTP关系：</strong></p>
<p>TCP是底层通讯协议，定义的是数据传输和连接方式的规范；</p>
<p>HTTP是应用层协议，定义的是传输数据的内容规范；</p>
<p>HTTP协议中的数据是利用TCP协议传输的，所以支持HTTP就支持TCP。</p>
<ol>
<li>连接操作：<ul>
<li>启动tcp连接（<code>connect(host,port)</code>）</li>
<li>判断client是否还在连接（<code>connected()</code>）</li>
<li>停止tcp连接（<code>stop()</code>）</li>
</ul>
</li>
<li>发送http请求操作：<ul>
<li><code>print()</code></li>
<li><code>println()</code></li>
<li><code>write()</code></li>
</ul>
</li>
<li>响应操作：<ul>
<li>判断是否有响应数据（<code>available()</code>）</li>
<li>查找响应数据某个字符串（<code>find()</code>）</li>
<li>读取响应数据直到某个字符串，会清除掉（<code>readStringUntil</code>）</li>
<li>读取响应数据中的一个字符，不清除（<code>peek()</code>）</li>
<li>读取固定大小的响应数据，不清除（<code>peekBytes(buf,size)</code>）</li>
<li>读取响应数据中的一个字符，清掉（<code>read()</code>）</li>
<li>读取固定大小的响应数据，清掉（<code>read(buf,size)</code>）</li>
<li>清掉缓冲区（<code>flush()</code>）</li>
</ul>
</li>
<li>普通设置：<code>setNoDelay()</code></li>
</ol>
<h3 id="6、TCP客户端（WiFiClientSecure-https）"><a href="#6、TCP客户端（WiFiClientSecure-https）" class="headerlink" title="6、TCP客户端（WiFiClientSecure https）:"></a>6、TCP客户端（WiFiClientSecure https）:</h3><h3 id="7、TCP服务端（WiFiServer）"><a href="#7、TCP服务端（WiFiServer）" class="headerlink" title="7、TCP服务端（WiFiServer）:"></a>7、TCP服务端（WiFiServer）:</h3><ol>
<li>管理server:<ol>
<li>设置tcp server:<ul>
<li>新增tcp server（<code>WiFiServer server(port)</code>）</li>
<li>启动tcp server（<code>begin()</code>）</li>
<li>关闭小包合并发送功能（<code>setNoDelay(true)</code>）</li>
</ul>
</li>
<li>停止server:<ul>
<li><code>close()</code></li>
<li><code>stop()</code>（内部实现直接调用close()）</li>
</ul>
</li>
<li>server状态 :   <code>server.status()</code></li>
</ol>
</li>
<li>等待WiFiClient访问：<ul>
<li>判断是否有新的client连接进来（<code>available()</code>）</li>
<li>判断是否有client连接（<code>has Client()</code>）</li>
</ul>
</li>
<li>读取WiFiClient的请求：参考WiFiClient里面的响应方法</li>
</ol>
<h3 id="8、TCP服务端（WiFiServerSecure-https）"><a href="#8、TCP服务端（WiFiServerSecure-https）" class="headerlink" title="8、TCP服务端（WiFiServerSecure https）"></a>8、TCP服务端（WiFiServerSecure https）</h3><h3 id="9、ESP8266WiFi库自带方法："><a href="#9、ESP8266WiFi库自带方法：" class="headerlink" title="9、ESP8266WiFi库自带方法："></a>9、ESP8266WiFi库自带方法：</h3><ul>
<li>调用调试信息（<code>printDiag(serial)</code>）</li>
</ul>
<p><strong>总结：</strong><img src="https://z3.ax1x.com/2021/08/05/fedfFe.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/05/fedfFe.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fedfFe.png">](<a target="_blank" rel="noopener" href="https://imgtu.com/i/fedfFe">https://imgtu.com/i/fedfFe</a>)</p>
<h2 id="3、示例"><a href="#3、示例" class="headerlink" title="3、示例"></a>3、示例</h2><h3 id="1、AP模式"><a href="#1、AP模式" class="headerlink" title="1、AP模式"></a>1、AP模式</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *    AP模式下，演示AP 函数方法的使用(最多连接4个)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;AP_Test&quot;</span> <span class="comment">//这里改成你的AP名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;12345678&quot;</span> <span class="comment">//这里改成你的AP密码 8位以上</span></span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line">IPAddress <span class="title function_">local_IP</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">1</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">gateway</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">1</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">subnet</span><span class="params">(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时2s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Setting soft-AP configuration ... &quot;</span>);</span><br><span class="line">  <span class="comment">//配置AP信息</span></span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  DebugPrintln(WiFi.softAPConfig(local_IP, gateway, subnet) ? <span class="string">&quot;Ready&quot;</span> : <span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">  <span class="comment">//启动AP模式，并设置账号和密码</span></span><br><span class="line">  DebugPrint(<span class="string">&quot;Setting soft-AP ... &quot;</span>);</span><br><span class="line">  boolean result = WiFi.softAP(AP_SSID, AP_PSW);</span><br><span class="line">  <span class="keyword">if</span>(result)&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Ready&quot;</span>);</span><br><span class="line">    <span class="comment">//输出 soft-ap ip地址</span></span><br><span class="line">    DebugPrintln(String(<span class="string">&quot;Soft-AP IP address = &quot;</span>) + WiFi.softAPIP().toString());</span><br><span class="line">    <span class="comment">//输出 soft-ap mac地址</span></span><br><span class="line">    DebugPrintln(String(<span class="string">&quot;MAC address = &quot;</span>) + WiFi.softAPmacAddress().c_str());</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//不断打印当前的station个数</span></span><br><span class="line">  DebugPrintln(String(<span class="string">&quot;Stations connected =&quot;</span>) + WiFi.softAPgetStationNum());</span><br><span class="line">  delay(<span class="number">3000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2、STA模式"><a href="#2、STA模式" class="headerlink" title="2、STA模式"></a>2、STA模式</h3><p>1. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo1：</span></span><br><span class="line"><span class="comment"> *    statin模式下，创建一个连接到可接入点（wifi热点），并且打印IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;XU-ChinaNet&quot;</span> <span class="comment">//这里改成你的wifi名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;15358228063&quot;</span><span class="comment">//这里改成你的wifi密码</span></span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时2s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup start&quot;</span>);</span><br><span class="line">  <span class="comment">//启动STA模式，并连接到wifi网络</span></span><br><span class="line">  WiFi.mode(WIFI_STA);<span class="comment">//最好人为加上STA设置（虽然默认是STA模式）</span></span><br><span class="line">  WiFi.disconnect();<span class="comment">//最好调用一下断连</span></span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSW);</span><br><span class="line">  DebugPrint(String(<span class="string">&quot;Connecting to &quot;</span>)+AP_SSID);</span><br><span class="line">  <span class="comment">//判断网络状态是否连接上，没连接上就延时500ms，并且打出一个点，模拟连接过程</span></span><br><span class="line">  <span class="comment">//笔者扩展：加入网络一直都连不上 是否可以做个判断，由你们自己实现</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected, IP address: &quot;</span>);</span><br><span class="line">  <span class="comment">//输出station IP地址，这里的IP地址由DHCP分配</span></span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo2：固定IP</span></span><br><span class="line"><span class="comment"> *    statin模式下，配置IP地址，网关地址，子网掩码，并且打印IP地址</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;XU-ChinaNet&quot;</span> <span class="comment">//这里改成你的wifi名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;15358228063&quot;</span><span class="comment">//这里改成你的wifi密码</span></span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line">IPAddress <span class="title function_">staticIP</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">1</span>,<span class="number">22</span>)</span>;<span class="comment">//固定IP地址</span></span><br><span class="line">IPAddress <span class="title function_">gateway</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">1</span>,<span class="number">9</span>)</span>;<span class="comment">//网关地址</span></span><br><span class="line">IPAddress <span class="title function_">subnet</span><span class="params">(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>)</span>;<span class="comment">//子网掩码地址</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时2s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup start&quot;</span>);</span><br><span class="line">  <span class="comment">//启动STA模式，并连接到wifi网络</span></span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSW);</span><br><span class="line">  DebugPrint(String(<span class="string">&quot;Connecting to &quot;</span>)+AP_SSID);</span><br><span class="line">  <span class="comment">//配置网络</span></span><br><span class="line">  WiFi.config(staticIP,gateway,subnet);</span><br><span class="line">  <span class="comment">//判断网络状态是否连接上，没连接上就延时500ms，并且打出一个点，模拟连接过程</span></span><br><span class="line">  <span class="comment">//笔者扩展：加入网络一直都连不上 是否可以做个判断，由你们自己实现</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected, IP address: &quot;</span>);</span><br><span class="line">  <span class="comment">//输出station IP地址，这里的IP地址理论上就是上面配置的</span></span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo3：</span></span><br><span class="line"><span class="comment"> *    statin模式下，创建一个连接到可接入点（wifi热点），并且打印station信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;XU-ChinaNet&quot;</span> <span class="comment">//这里改成你的wifi名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;15358228063&quot;</span><span class="comment">//这里改成你的wifi密码</span></span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时2s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup start&quot;</span>);</span><br><span class="line">  <span class="comment">//启动STA模式，并连接到wifi网络</span></span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSW);</span><br><span class="line">  <span class="comment">//设置自动连接</span></span><br><span class="line">  WiFi.setAutoConnect(<span class="literal">true</span>);</span><br><span class="line">  <span class="comment">//设置自动重连</span></span><br><span class="line">  WiFi.setAutoReconnect(<span class="literal">true</span>);</span><br><span class="line">  DebugPrint(String(<span class="string">&quot;Connecting to &quot;</span>)+AP_SSID);</span><br><span class="line">  <span class="comment">//判断网络状态是否连接上，没连接上就延时500ms，并且打出一个点，模拟连接过程</span></span><br><span class="line">  <span class="comment">//笔者扩展：加入网络一直都连不上 是否可以做个判断，由你们自己实现</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  DebugPrintln(<span class="string">&quot;rint Network Info:&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (WiFi.status() == WL_CONNECTED)&#123;</span><br><span class="line">     <span class="comment">//输出mac地址</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;Connected, mac address: &quot;</span>)+WiFi.macAddress().c_str());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出station IP地址，这里的IP地址由DHCP分配</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;Connected, IP address: &quot;</span>)+WiFi.localIP().toString());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出子网掩码地址</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;Subnet mask: &quot;</span>)+WiFi.subnetMask().toString());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出网关 IP地址</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;Gataway IP: &quot;</span>)+WiFi.gatewayIP().toString());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出hostname</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;Default hostname: &quot;</span>)+WiFi.hostname());</span><br><span class="line">     <span class="comment">//设置新的hostname</span></span><br><span class="line">     WiFi.hostname(<span class="string">&quot;Station_host_123&quot;</span>);</span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;New hostname: &quot;</span>)+WiFi.hostname());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出SSID</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;SSID: &quot;</span>)+WiFi.SSID());</span><br><span class="line"> </span><br><span class="line">     <span class="comment">//输出psk</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;psk: &quot;</span>)+WiFi.psk());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出BSSID</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;BSSID: &quot;</span>)+WiFi.BSSIDstr());</span><br><span class="line">     </span><br><span class="line">     <span class="comment">//输出RSSI</span></span><br><span class="line">     DebugPrintln(String(<span class="string">&quot;RSSI: &quot;</span>) + WiFi.RSSI() + <span class="string">&quot; dBm&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3、扫描："><a href="#3、扫描：" class="headerlink" title="3、扫描："></a>3、扫描：</h3><p>1. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    STA模式下，演示同步扫描Scan wifi功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时5s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">// 我不想别人连接我，只想做个站点</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  <span class="comment">//断开连接</span></span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup done&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;scan start&quot;</span>);</span><br><span class="line">  <span class="comment">// 同步扫描，等待返回结果</span></span><br><span class="line">  <span class="type">int</span> n = WiFi.scanNetworks();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;scan done&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">0</span>)&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;no networks found&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrint(n);</span><br><span class="line">    DebugPrintln(<span class="string">&quot; networks found&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i)&#123;</span><br><span class="line">      DebugPrint(i + <span class="number">1</span>);</span><br><span class="line">      DebugPrint(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">      <span class="comment">//打印wifi账号</span></span><br><span class="line">      DebugPrint(WiFi.SSID(i));</span><br><span class="line">      DebugPrint(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">      DebugPrint(String(<span class="string">&quot;Ch:&quot;</span>)+WiFi.channel(i));</span><br><span class="line">      DebugPrint(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">      DebugPrint(WiFi.isHidden(i)?<span class="string">&quot;hide&quot;</span>:<span class="string">&quot;show&quot;</span>);</span><br><span class="line">      DebugPrint(<span class="string">&quot; (&quot;</span>);</span><br><span class="line">      <span class="comment">//打印wifi信号强度</span></span><br><span class="line">      DebugPrint(WiFi.RSSI(i));</span><br><span class="line">      DebugPrint(<span class="string">&quot;dBm&quot;</span>);</span><br><span class="line">      DebugPrint(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">      <span class="comment">//打印wifi加密方式</span></span><br><span class="line">      DebugPrintln((WiFi.encryptionType(i) == ENC_TYPE_NONE)?<span class="string">&quot;open&quot;</span>:<span class="string">&quot;*&quot;</span>);</span><br><span class="line">      delay(<span class="number">10</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  <span class="comment">// 延时5s之后再次扫描</span></span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    STA模式下，演示异步扫描Scan wifi功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="comment">//定义一个扫描时间间隔</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SCAN_PERIOD 5000</span></span><br><span class="line"><span class="type">long</span> lastScanMillis;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时5s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">// 我不想别人连接我，只想做个站点</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  <span class="comment">//断开连接</span></span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup done&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line"> <span class="type">long</span> currentMillis = millis();</span><br><span class="line"> <span class="comment">//触发扫描</span></span><br><span class="line"> <span class="keyword">if</span> (currentMillis - lastScanMillis &gt; SCAN_PERIOD)&#123;</span><br><span class="line">    WiFi.scanNetworks(<span class="literal">true</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;\nScan start ... &quot;</span>);</span><br><span class="line">    lastScanMillis = currentMillis;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 判断是否有扫描结果</span></span><br><span class="line">  <span class="type">int</span> n = WiFi.scanComplete();</span><br><span class="line">  <span class="keyword">if</span>(n &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d network(s) found\n&quot;</span>, n);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d: %s, Ch:%d (%ddBm) %s\n&quot;</span>, i+<span class="number">1</span>, WiFi.SSID(i).c_str(), WiFi.channel(i), WiFi.RSSI(i), WiFi.encryptionType(i) == ENC_TYPE_NONE ? <span class="string">&quot;open&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//打印完一次扫描结果之后  删除内存保存结果</span></span><br><span class="line">    WiFi.scanDelete();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    STA模式下，演示异步扫描Scan wifi功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 打印扫描结果</span></span><br><span class="line"><span class="comment"> * @param networksFound 结果个数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">prinScanResult</span><span class="params">(<span class="type">int</span> networksFound)</span>&#123;</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d network(s) found\n&quot;</span>, networksFound);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; networksFound; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;%d: %s, Ch:%d (%ddBm) %s\n&quot;</span>, i + <span class="number">1</span>, WiFi.SSID(i).c_str(), WiFi.channel(i), WiFi.RSSI(i), WiFi.encryptionType(i) == ENC_TYPE_NONE ? <span class="string">&quot;open&quot;</span> : <span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时5s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">// 我不想别人连接我，只想做个站点</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  <span class="comment">//断开连接</span></span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup done&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;\nScan start ... &quot;</span>);</span><br><span class="line">  WiFi.scanNetworksAsync(prinScanResult);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4、通用库处理事件："><a href="#4、通用库处理事件：" class="headerlink" title="4、通用库处理事件："></a>4、通用库处理事件：</h3><ol>
<li>官方示例：(AP模式)</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    This sketch shows how to use WiFi event handlers.</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">    In this example, ESP8266 works in AP mode.</span></span><br><span class="line"><span class="comment">    Three event handlers are demonstrated:</span></span><br><span class="line"><span class="comment">    - station connects to the ESP8266 AP</span></span><br><span class="line"><span class="comment">    - station disconnects from the ESP8266 AP</span></span><br><span class="line"><span class="comment">    - ESP8266 AP receives a probe request from a station</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid     = <span class="string">&quot;ap-ssid&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;ap-password&quot;</span>;</span><br><span class="line"></span><br><span class="line">WiFiEventHandler stationConnectedHandler;</span><br><span class="line">WiFiEventHandler stationDisconnectedHandler;</span><br><span class="line">WiFiEventHandler probeRequestPrintHandler;</span><br><span class="line">WiFiEventHandler probeRequestBlinkHandler;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> blinkFlag;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">  digitalWrite(LED_BUILTIN, HIGH);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不保存任何wifi配置到flash</span></span><br><span class="line">  WiFi.persistent(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 建立一个AP</span></span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  WiFi.softAP(ssid, password);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册事件处理器</span></span><br><span class="line">  <span class="comment">// 回调函数会在事件发生时被调用</span></span><br><span class="line">  <span class="comment">// onStationConnected函数会在每一次有station连接时调用</span></span><br><span class="line">  stationConnectedHandler = WiFi.onSoftAPModeStationConnected(&amp;onStationConnected);</span><br><span class="line">  <span class="comment">// onStationDisconnected函数会在每一次有station断开时调用</span></span><br><span class="line">  stationDisconnectedHandler = WiFi.onSoftAPModeStationDisconnected(&amp;onStationDisconnected);</span><br><span class="line">  <span class="comment">// onProbeRequestPrint和onProbeRequestBlink函数会在每一次收到探针请求时调用</span></span><br><span class="line">  <span class="comment">// onProbeRequestPrint会打印station的mac地址和信号强度到串口监视器</span></span><br><span class="line">  <span class="comment">// onProbeRequestBlink会闪烁LED</span></span><br><span class="line">  probeRequestPrintHandler = WiFi.onSoftAPModeProbeRequestReceived(&amp;onProbeRequestPrint);</span><br><span class="line">  probeRequestBlinkHandler = WiFi.onSoftAPModeProbeRequestReceived(&amp;onProbeRequestBlink);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onStationConnected</span><span class="params">(<span class="type">const</span> WiFiEventSoftAPModeStationConnected&amp; evt)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Station connected: &quot;</span>);</span><br><span class="line">  Serial.println(macToString(evt.mac));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onStationDisconnected</span><span class="params">(<span class="type">const</span> WiFiEventSoftAPModeStationDisconnected&amp; evt)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Station disconnected: &quot;</span>);</span><br><span class="line">  Serial.println(macToString(evt.mac));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onProbeRequestPrint</span><span class="params">(<span class="type">const</span> WiFiEventSoftAPModeProbeRequestReceived&amp; evt)</span> &#123;</span><br><span class="line">  Serial.print(<span class="string">&quot;Probe request from: &quot;</span>);</span><br><span class="line">  Serial.print(macToString(evt.mac));</span><br><span class="line">  Serial.print(<span class="string">&quot; RSSI: &quot;</span>);</span><br><span class="line">  Serial.println(evt.rssi);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">onProbeRequestBlink</span><span class="params">(<span class="type">const</span> WiFiEventSoftAPModeProbeRequestReceived&amp;)</span> &#123;</span><br><span class="line">  <span class="comment">// 我们不能在事件处理函数中调用延时函数或者其他阻塞函数</span></span><br><span class="line">  <span class="comment">// 因此这里设置一个标志位</span></span><br><span class="line">  blinkFlag = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (millis() &gt; <span class="number">10000</span> &amp;&amp; probeRequestPrintHandler) &#123;</span><br><span class="line">    <span class="comment">// 10s之后，禁止 onProbeRequestPrint</span></span><br><span class="line">    Serial.println(<span class="string">&quot;Not printing probe requests any more (LED should still blink)&quot;</span>);</span><br><span class="line">    probeRequestPrintHandler = WiFiEventHandler();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (blinkFlag) &#123;</span><br><span class="line">    blinkFlag = <span class="literal">false</span>;</span><br><span class="line">    digitalWrite(LED_BUILTIN, LOW);</span><br><span class="line">    delay(<span class="number">100</span>);</span><br><span class="line">    digitalWrite(LED_BUILTIN, HIGH);</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">10</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">String <span class="title function_">macToString</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* mac)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">20</span>];</span><br><span class="line">  <span class="built_in">snprintf</span>(buf, <span class="keyword">sizeof</span>(buf), <span class="string">&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;</span>,</span><br><span class="line">           mac[<span class="number">0</span>], mac[<span class="number">1</span>], mac[<span class="number">2</span>], mac[<span class="number">3</span>], mac[<span class="number">4</span>], mac[<span class="number">5</span>]);</span><br><span class="line">  <span class="keyword">return</span> String(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>station模式：</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *ssid = <span class="string">&quot;********&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *password = <span class="string">&quot;********&quot;</span>;</span><br><span class="line"></span><br><span class="line">WiFiEventHandler STAConnected;</span><br><span class="line">WiFiEventHandler STADisconnected;</span><br><span class="line">WiFiEventHandler STAGotIP;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">ConnectedHandler</span><span class="params">(<span class="type">const</span> WiFiEventStationModeConnected &amp;event)</span></span><br><span class="line">&#123;</span><br><span class="line">    Serial.println(WiFi.status());</span><br><span class="line">    Serial.println(<span class="string">&quot;模块连接到网络&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DisconnectedHandler</span><span class="params">(<span class="type">const</span> WiFiEventStationModeDisconnected &amp;event)</span></span><br><span class="line">&#123;</span><br><span class="line">    Serial.println(WiFi.status());</span><br><span class="line">    Serial.println(<span class="string">&quot;模块从网络断开&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    Serial.begin(<span class="number">115200</span>);</span><br><span class="line">    Serial.println();</span><br><span class="line"></span><br><span class="line">    STAConnected = WiFi.onStationModeConnected(ConnectedHandler);</span><br><span class="line">    STADisconnected = WiFi.onStationModeDisconnected(DisconnectedHandler);</span><br><span class="line">    STAGotIP = WiFi.onStationModeGotIP([](<span class="type">const</span> WiFiEventStationModeGotIP &amp;event) &#123;</span><br><span class="line">        Serial.println(WiFi.status());</span><br><span class="line">        Serial.println(<span class="string">&quot;模块获得IP&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    WiFi.mode(WIFI_STA);</span><br><span class="line">    WiFi.begin(ssid, password);</span><br><span class="line">    Serial.println(WiFi.status());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    delay(<span class="number">5000</span>); <span class="comment">//等待5秒</span></span><br><span class="line">    WiFi.disconnect(); <span class="comment">//断开当前网络连接</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5、TCP客户端（client）"><a href="#5、TCP客户端（client）" class="headerlink" title="5、TCP客户端（client）"></a>5、TCP客户端（client）</h3><ol>
<li>演视WiFiClient与TCP server之间通信功能（使用TCP调试助手（TCP&#x2F;UDP Socket调试工具））在TCP调试助手上建立一个TCP server, IP地址是192.168.1.102，端口号是8234。</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    STA模式下，演示WiFiClient与TCP server之间的通信功能</span></span><br><span class="line"><span class="comment"> *    本实验需要跟TCP调试助手一起使用。</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;XU-ChinaNet&quot;</span> <span class="comment">//这里改成你的wifi名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;15358228063&quot;</span><span class="comment">//这里改成你的wifi密码</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> port = <span class="number">8234</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> * host = <span class="string">&quot;192.168.1.8&quot;</span>; <span class="comment">// ip or dns</span></span><br><span class="line">WiFiClient client;<span class="comment">//创建一个tcp client连接</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//设置串口波特率，以便打印信息</span></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  <span class="comment">//延时5s 为了演示效果</span></span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">// 我不想别人连接我，只想做个站点</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID,AP_PSW);</span><br><span class="line"> </span><br><span class="line">  DebugPrint(<span class="string">&quot;Wait for WiFi... &quot;</span>);</span><br><span class="line">  <span class="comment">//等待wifi连接成功</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line"> </span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  </span><br><span class="line">  DebugPrint(<span class="string">&quot;connecting to &quot;</span>);</span><br><span class="line">  DebugPrintln(host);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (!client.connect(host, port)) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;connection failed&quot;</span>);</span><br><span class="line">    DebugPrintln(<span class="string">&quot;wait 5 sec...&quot;</span>);</span><br><span class="line">    delay(<span class="number">5000</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 发送数据到Tcp server</span></span><br><span class="line">  DebugPrintln(<span class="string">&quot;Send this data to server&quot;</span>);</span><br><span class="line">  client.println(String(<span class="string">&quot;Send this data to server&quot;</span>));</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//读取从server返回到响应数据</span></span><br><span class="line">  String line = client.readStringUntil(<span class="string">&#x27;\r&#x27;</span>);</span><br><span class="line">  DebugPrintln(line);</span><br><span class="line"> </span><br><span class="line">  DebugPrintln(<span class="string">&quot;closing connection&quot;</span>);</span><br><span class="line">  client.stop();</span><br><span class="line"> </span><br><span class="line">  DebugPrintln(<span class="string">&quot;wait 5 sec...&quot;</span>);</span><br><span class="line">  delay(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>通过TCP client包装Http请求协议去调用天气接口获取天气信息</p>
<p>（使用ArduinoJson库，尽量使用5.X版本）</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示Http请求天气接口信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid     = <span class="string">&quot;TP-LINK_5344&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;6206908you11011010&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* host = <span class="string">&quot;api.seniverse.com&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* APIKEY = <span class="string">&quot;wcmquevztdy1jpca&quot;</span>;        <span class="comment">//API KEY</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* city = <span class="string">&quot;guangzhou&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* language = <span class="string">&quot;zh-Hans&quot;</span>;<span class="comment">//zh-Hans 简体中文  会显示乱码</span></span><br><span class="line">  </span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> HTTP_TIMEOUT = <span class="number">5000</span>;               <span class="comment">// max respone time from server</span></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> MAX_CONTENT_SIZE = <span class="number">1000</span>;                   <span class="comment">// max size of the HTTP response</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 我们要从此网页中提取的数据的类型</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WeatherData</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> city[<span class="number">16</span>];<span class="comment">//城市名称</span></span><br><span class="line">  <span class="type">char</span> weather[<span class="number">32</span>];<span class="comment">//天气介绍（多云...）</span></span><br><span class="line">  <span class="type">char</span> temp[<span class="number">16</span>];<span class="comment">//温度</span></span><br><span class="line">  <span class="type">char</span> udate[<span class="number">32</span>];<span class="comment">//更新时间</span></span><br><span class="line">&#125;;</span><br><span class="line">  </span><br><span class="line">WiFiClient client;</span><br><span class="line"><span class="type">char</span> response[MAX_CONTENT_SIZE];</span><br><span class="line"><span class="type">char</span> endOfHeaders[] = <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your setup code here, to run once:</span></span><br><span class="line">  WiFi.mode(WIFI_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connecting to &quot;</span>);<span class="comment">//写几句提示，哈哈</span></span><br><span class="line">  DebugPrintln(ssid);</span><br><span class="line">  WiFi.begin(ssid, password);   <span class="comment">//连接wifi</span></span><br><span class="line">  WiFi.setAutoConnect(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    <span class="comment">//这个函数是wifi连接状态，返回wifi链接状态</span></span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  delay(<span class="number">500</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());<span class="comment">//WiFi.localIP()返回8266获得的ip地址</span></span><br><span class="line">  client.setTimeout(HTTP_TIMEOUT);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your main code here, to run repeatedly:</span></span><br><span class="line">  <span class="comment">//判断tcp client是否处于连接状态，不是就建立连接</span></span><br><span class="line">  <span class="keyword">while</span> (!client.connected())&#123;</span><br><span class="line">     <span class="keyword">if</span> (!client.connect(host, <span class="number">80</span>))&#123;</span><br><span class="line">         DebugPrintln(<span class="string">&quot;connection....&quot;</span>);</span><br><span class="line">         delay(<span class="number">500</span>);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//发送http请求 并且跳过响应头 直接获取响应body</span></span><br><span class="line">  <span class="keyword">if</span> (sendRequest(host, city, APIKEY) &amp;&amp; skipResponseHeaders()) &#123;</span><br><span class="line">    <span class="comment">//清除缓冲</span></span><br><span class="line">    clrEsp8266ResponseBuffer();</span><br><span class="line">    <span class="comment">//读取响应数据</span></span><br><span class="line">    readReponseContent(response, <span class="keyword">sizeof</span>(response));</span><br><span class="line">    WeatherData weatherData;</span><br><span class="line">    <span class="keyword">if</span> (parseUserData(response, &amp;weatherData)) &#123;</span><br><span class="line">      printUserData(&amp;weatherData);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  delay(<span class="number">5000</span>);<span class="comment">//每5s调用一次</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @发送http请求指令</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">sendRequest</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host, <span class="type">const</span> <span class="type">char</span>* cityid, <span class="type">const</span> <span class="type">char</span>* apiKey)</span> &#123;</span><br><span class="line">  <span class="comment">// We now create a URI for the request</span></span><br><span class="line">  <span class="comment">//心知天气  发送http请求</span></span><br><span class="line">  String GetUrl = <span class="string">&quot;/v3/weather/now.json?key=&quot;</span>;</span><br><span class="line">  GetUrl += apiKey;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;location=&quot;</span>;</span><br><span class="line">  GetUrl += city;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;language=&quot;</span>;</span><br><span class="line">  GetUrl += language;</span><br><span class="line">  <span class="comment">// This will send the request to the server</span></span><br><span class="line">  client.print(String(<span class="string">&quot;GET &quot;</span>) + GetUrl + <span class="string">&quot; HTTP/1.1\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Host: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Connection: close\r\n\r\n&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;create a request:&quot;</span>);</span><br><span class="line">  DebugPrintln(String(<span class="string">&quot;GET &quot;</span>) + GetUrl + <span class="string">&quot; HTTP/1.1\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Host: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 跳过 HTTP 头，使我们在响应正文的开头</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">skipResponseHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// HTTP headers end with an empty line</span></span><br><span class="line">  <span class="type">bool</span> ok = client.find(endOfHeaders);</span><br><span class="line">  <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;No response or invalid response!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 从HTTP服务器响应中读取正文</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">readReponseContent</span><span class="params">(<span class="type">char</span>* content, <span class="type">size_t</span> maxSize)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> length = client.readBytes(content, maxSize);</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Get the data from Internet!&quot;</span>);</span><br><span class="line">  content[length] = <span class="number">0</span>;</span><br><span class="line">  DebugPrintln(content);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Read data Over!&quot;</span>);</span><br><span class="line">  client.flush();<span class="comment">//清除一下缓冲</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Desc 解析数据 Json解析</span></span><br><span class="line"><span class="comment"> * 数据格式如下：</span></span><br><span class="line"><span class="comment"> * &#123;</span></span><br><span class="line"><span class="comment"> *    &quot;results&quot;: [</span></span><br><span class="line"><span class="comment"> *        &#123;</span></span><br><span class="line"><span class="comment"> *            &quot;location&quot;: &#123;</span></span><br><span class="line"><span class="comment"> *                &quot;id&quot;: &quot;WX4FBXXFKE4F&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;name&quot;: &quot;北京&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;country&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;path&quot;: &quot;北京,北京,中国&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;timezone&quot;: &quot;Asia/Shanghai&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;timezone_offset&quot;: &quot;+08:00&quot;</span></span><br><span class="line"><span class="comment"> *            &#125;,</span></span><br><span class="line"><span class="comment"> *            &quot;now&quot;: &#123;</span></span><br><span class="line"><span class="comment"> *                &quot;text&quot;: &quot;多云&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;code&quot;: &quot;4&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;temperature&quot;: &quot;23&quot;</span></span><br><span class="line"><span class="comment"> *            &#125;,</span></span><br><span class="line"><span class="comment"> *            &quot;last_update&quot;: &quot;2017-09-13T09:51:00+08:00&quot;</span></span><br><span class="line"><span class="comment"> *        &#125;</span></span><br><span class="line"><span class="comment"> *    ]</span></span><br><span class="line"><span class="comment"> *&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parseUserData</span><span class="params">(<span class="type">char</span>* content, <span class="keyword">struct</span> WeatherData* weatherData)</span> &#123;</span><br><span class="line"><span class="comment">//    -- 根据我们需要解析的数据来计算JSON缓冲区最佳大小</span></span><br><span class="line"><span class="comment">//   如果你使用StaticJsonBuffer时才需要</span></span><br><span class="line"><span class="comment">//    const size_t BUFFER_SIZE = 1024;</span></span><br><span class="line"><span class="comment">//   在堆栈上分配一个临时内存池</span></span><br><span class="line"><span class="comment">//    StaticJsonBuffer&lt;BUFFER_SIZE&gt; jsonBuffer;</span></span><br><span class="line"><span class="comment">//    -- 如果堆栈的内存池太大，使用 DynamicJsonBuffer jsonBuffer 代替</span></span><br><span class="line">  DynamicJsonBuffer jsonBuffer;</span><br><span class="line">   </span><br><span class="line">  JsonObject&amp; root = jsonBuffer.parseObject(content);</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">if</span> (!root.success()) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;JSON parsing failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//复制我们感兴趣的字符串</span></span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;city, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;location&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;weather, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;text&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;temp, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;temperature&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;udate, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;last_update&quot;</span>]);</span><br><span class="line">  <span class="comment">//  -- 这不是强制复制，你可以使用指针，因为他们是指向“内容”缓冲区内，所以你需要确保</span></span><br><span class="line">  <span class="comment">//   当你读取字符串时它仍在内存中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 打印从JSON中提取的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printUserData</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> WeatherData* weatherData)</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Print parsed data :&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;City : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;city);</span><br><span class="line">  DebugPrint(<span class="string">&quot;, \t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Weather : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;weather);</span><br><span class="line">  DebugPrint(<span class="string">&quot;,\t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Temp : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;temp);</span><br><span class="line">  DebugPrint(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;,\t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Last Updata : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;udate);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 关闭与HTTP服务器连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stopConnect</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Disconnect&quot;</span>);</span><br><span class="line">  client.stop();</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">clrEsp8266ResponseBuffer</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(response, <span class="number">0</span>, MAX_CONTENT_SIZE);      <span class="comment">//清空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6、TCP服务端（server）"><a href="#6、TCP服务端（server）" class="headerlink" title="6、TCP服务端（server）"></a>6、TCP服务端（server）</h3><ol>
<li>8266作为WiFiServer端，打开TCP调试助手，模拟TCP Client的请求；</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示WiFiServer功能</span></span><br><span class="line"><span class="comment"> *    打开TCP调试助手 模拟TCP client请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//定义最多多少个client可以连接本server(一般不要超过4个)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SRV_CLIENTS 1</span></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;TP-LINK_5344&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;6206908you11011010&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//创建server 端口号是23</span></span><br><span class="line">WiFiServer <span class="title function_">server</span><span class="params">(<span class="number">23</span>)</span>;</span><br><span class="line"><span class="comment">//管理clients</span></span><br><span class="line">WiFiClient serverClients[MAX_SRV_CLIENTS];</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  DebugPrint(<span class="string">&quot;\nConnecting to &quot;</span>); </span><br><span class="line">  DebugPrintln(ssid);</span><br><span class="line">  <span class="type">uint8_t</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED &amp;&amp; i++ &lt; <span class="number">20</span>) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (i == <span class="number">21</span>) &#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;Could not connect to&quot;</span>); </span><br><span class="line">    DebugPrintln(ssid);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      delay(<span class="number">500</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//启动server</span></span><br><span class="line">  server.begin();</span><br><span class="line">  <span class="comment">//关闭小包合并包功能，不会延时发送数据</span></span><br><span class="line">  server.setNoDelay(<span class="literal">true</span>);</span><br><span class="line"> </span><br><span class="line">  DebugPrint(<span class="string">&quot;Ready! Use &#x27;telnet &quot;</span>);</span><br><span class="line">  DebugPrint(WiFi.localIP());</span><br><span class="line">  DebugPrintln(<span class="string">&quot; 23&#x27; to connect&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">uint8_t</span> i;</span><br><span class="line">  <span class="comment">//检测是否有新的client请求进来</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasClient()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_SRV_CLIENTS; i++) &#123;</span><br><span class="line">      <span class="comment">//释放旧无效或者断开的client</span></span><br><span class="line">      <span class="keyword">if</span> (!serverClients[i] || !serverClients[i].connected()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (serverClients[i]) &#123;</span><br><span class="line">          serverClients[i].stop();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//分配最新的client</span></span><br><span class="line">        serverClients[i] = server.available();</span><br><span class="line">        DebugPrint(<span class="string">&quot;New client: &quot;</span>); </span><br><span class="line">        DebugPrint(i);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//当达到最大连接数 无法释放无效的client，需要拒绝连接</span></span><br><span class="line">    <span class="keyword">if</span> (i == MAX_SRV_CLIENTS) &#123;</span><br><span class="line">      WiFiClient serverClient = server.available();</span><br><span class="line">      serverClient.stop();</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Connection rejected &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//检测client发过来的数据</span></span><br><span class="line">  <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_SRV_CLIENTS; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (serverClients[i] &amp;&amp; serverClients[i].connected()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (serverClients[i].available()) &#123;</span><br><span class="line">        <span class="comment">//get data from the telnet client and push it to the UART</span></span><br><span class="line">        <span class="keyword">while</span> (serverClients[i].available()) &#123;</span><br><span class="line">          <span class="comment">//发送到串口调试器</span></span><br><span class="line">          Serial.write(serverClients[i].read());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span> (Serial.available()) &#123;</span><br><span class="line">    <span class="comment">//把串口调试器发过来的数据 发送给client</span></span><br><span class="line">    <span class="type">size_t</span> len = Serial.available();</span><br><span class="line">    <span class="type">uint8_t</span> sbuf[len];</span><br><span class="line">    Serial.readBytes(sbuf, len);</span><br><span class="line">    <span class="comment">//push UART data to all connected telnet clients</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX_SRV_CLIENTS; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (serverClients[i] &amp;&amp; serverClients[i].connected()) &#123;</span><br><span class="line">        serverClients[i].write(sbuf, len);</span><br><span class="line">        delay(<span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>8266作为web server端，打开PC浏览器输入IP网址，请求web server</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Demo：</span><br><span class="line"> *    演示web Server功能</span><br><span class="line"> *    打开PC浏览器 输入IP地址。请求web server</span><br><span class="line"> */</span><br><span class="line">#include &lt;ESP8266WiFi.h&gt;</span><br><span class="line"> </span><br><span class="line">const char* ssid = &quot;TP-LINK_5344&quot;;//wifi账号 这里需要修改</span><br><span class="line">const char* password = &quot;xxxx&quot;;//wifi密码 这里需要修改</span><br><span class="line"> </span><br><span class="line">//创建 tcp server 端口号是80</span><br><span class="line">WiFiServer server(80);</span><br><span class="line"> </span><br><span class="line">void setup()&#123;</span><br><span class="line">  Serial.begin(115200);</span><br><span class="line">  Serial.println();</span><br><span class="line"> </span><br><span class="line">  Serial.printf(&quot;Connecting to %s &quot;, ssid);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  while (WiFi.status() != WL_CONNECTED)&#123;</span><br><span class="line">    delay(500);</span><br><span class="line">    Serial.print(&quot;.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(&quot; connected&quot;);</span><br><span class="line">  //启动TCP 连接</span><br><span class="line">  server.begin();</span><br><span class="line">  //打印TCP server IP地址</span><br><span class="line">  Serial.printf(&quot;Web server started, open %s in a web browser\n&quot;, WiFi.localIP().toString().c_str());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">/**</span><br><span class="line"> * 模拟web server 返回http web响应内容</span><br><span class="line"> * 这里是手动拼接HTTP响应内容</span><br><span class="line"> * 后面楼主会继续讲解另外两个专用于http请求的库</span><br><span class="line"> */</span><br><span class="line">String prepareHtmlPage()&#123;</span><br><span class="line">  String htmlPage =</span><br><span class="line">     String(&quot;HTTP/1.1 200 OK\r\n&quot;) +</span><br><span class="line">            &quot;Content-Type: text/html\r\n&quot; +</span><br><span class="line">            &quot;Connection: close\r\n&quot; +  // the connection will be closed after completion of the response</span><br><span class="line">            &quot;Refresh: 5\r\n&quot; +  // refresh the page automatically every 5 sec</span><br><span class="line">            &quot;\r\n&quot; +</span><br><span class="line">            &quot;&lt;!DOCTYPE HTML&gt;&quot; +</span><br><span class="line">            &quot;&lt;html&gt;&quot; +</span><br><span class="line">            &quot;Analog input:  &quot; + String(analogRead(A0)) +</span><br><span class="line">            &quot;&lt;/html&gt;&quot; +</span><br><span class="line">            &quot;\r\n&quot;;</span><br><span class="line">  return htmlPage;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">void loop()&#123;</span><br><span class="line">  WiFiClient client = server.available();</span><br><span class="line">  // wait for a client (web browser) to connect</span><br><span class="line">  if (client)&#123;</span><br><span class="line">    Serial.println(&quot;\n[Client connected]&quot;);</span><br><span class="line">    while (client.connected())&#123;</span><br><span class="line">      // 不断读取请求内容</span><br><span class="line">      if (client.available())&#123;</span><br><span class="line">        String line = client.readStringUntil(&#x27;\r&#x27;);</span><br><span class="line">        Serial.print(line);</span><br><span class="line">        // wait for end of client&#x27;s request, that is marked with an empty line</span><br><span class="line">        if (line.length() == 1 &amp;&amp; line[0] == &#x27;\n&#x27;)&#123;</span><br><span class="line">          //返回响应内容</span><br><span class="line">          client.println(prepareHtmlPage());</span><br><span class="line">          break;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      //由于我们设置了 Connection: close  当我们响应数据之后就会自动断开连接</span><br><span class="line">    &#125;</span><br><span class="line">    delay(100); // give the web browser time to receive the data</span><br><span class="line"> </span><br><span class="line">    // close the connection:</span><br><span class="line">    client.stop();</span><br><span class="line">    Serial.println(&quot;[Client disonnected]&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>8266作为WiFiServer端，演示简单的web server功能，web server 会根据请求来做不同的操作</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* Demo：</span></span><br><span class="line"><span class="comment">*    演示简单web Server功能</span></span><br><span class="line"><span class="comment">*    web server会根据请求来做不同的操作</span></span><br><span class="line"><span class="comment">*    http://server_ip/gpio/0 打印 /gpio0</span></span><br><span class="line"><span class="comment">*    http://server_ip/gpio/1 打印 /gpio1</span></span><br><span class="line"><span class="comment">*    server_ip就是ESP8266的Ip地址</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;TP-LINK_5344&quot;</span>;<span class="comment">//wifi账号 这里需要修改</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxxx&quot;</span>;<span class="comment">//wifi密码 这里需要修改</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 创建tcp server</span></span><br><span class="line">WiFiServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">10</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Connect to WiFi network</span></span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(String(<span class="string">&quot;Connecting to &quot;</span>) + ssid);</span><br><span class="line">  <span class="comment">//我只想做个安静的美男子 STA</span></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  <span class="comment">//我想连接路由wifi</span></span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 启动server</span></span><br><span class="line">  server.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Server started&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 打印IP地址</span></span><br><span class="line">  DebugPrintln(WiFi.localIP().toString());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// 等待有效的tcp连接</span></span><br><span class="line">  WiFiClient client = server.available();</span><br><span class="line">  <span class="keyword">if</span> (!client) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  DebugPrintln(<span class="string">&quot;new client&quot;</span>);</span><br><span class="line">  <span class="comment">//等待client数据过来</span></span><br><span class="line">  <span class="keyword">while</span> (!client.available()) &#123;</span><br><span class="line">    delay(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 读取请求的第一行 会包括一个url，这里只处理url</span></span><br><span class="line">  String req = client.readStringUntil(<span class="string">&#x27;\r&#x27;</span>);</span><br><span class="line">  DebugPrintln(req);</span><br><span class="line">  <span class="comment">//清掉缓冲区数据 据说这个方法没什么用 可以换种实现方式</span></span><br><span class="line">  client.flush();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 开始匹配</span></span><br><span class="line">  <span class="type">int</span> val;</span><br><span class="line">  <span class="keyword">if</span> (req.indexOf(<span class="string">&quot;/gpio/0&quot;</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;/gpio0&quot;</span>);</span><br><span class="line">    val = <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (req.indexOf(<span class="string">&quot;/gpio/1&quot;</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;/gpio1&quot;</span>);</span><br><span class="line">    val = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;invalid request&quot;</span>);</span><br><span class="line">    <span class="comment">//关闭这个client请求</span></span><br><span class="line">    client.stop();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//清掉缓冲区数据</span></span><br><span class="line">  client.flush();</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 准备响应数据</span></span><br><span class="line">  String s = <span class="string">&quot;HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n&lt;!DOCTYPE HTML&gt;\r\n&lt;html&gt;\r\nGPIO is now &quot;</span>;</span><br><span class="line">  s += (val) ? <span class="string">&quot;high&quot;</span> : <span class="string">&quot;low&quot;</span>;</span><br><span class="line">  s += <span class="string">&quot;&lt;/html&gt;\n&quot;</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 发送响应数据给client</span></span><br><span class="line">  client.print(s);</span><br><span class="line">  delay(<span class="number">1</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Client disonnected&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// The client will actually be disconnected</span></span><br><span class="line">  <span class="comment">// when the function returns and &#x27;client&#x27; object is detroyed</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="7、Smartconfig智能配网："><a href="#7、Smartconfig智能配网：" class="headerlink" title="7、Smartconfig智能配网："></a>7、Smartconfig智能配网：</h3><p>收集APP端发送包含WIFI用户名和密码的UDP广播包，智能终端的WIFI芯片接收到UDP包，解密配置连接。</p>
<p>手机软件esptouch:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">smartConfig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  Serial.println(<span class="string">&quot;\r\nWait for Smartconfig&quot;</span>);</span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  <span class="comment">// 等待配网</span></span><br><span class="line">  WiFi.beginSmartConfig();</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    <span class="keyword">if</span> (WiFi.smartConfigDone())</span><br><span class="line">    &#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;SmartConfig Success&quot;</span>);</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;SSID:%s\r\n&quot;</span>, WiFi.SSID().c_str());</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;PSW:%s\r\n&quot;</span>, WiFi.psk().c_str());</span><br><span class="line">      WiFi.setAutoConnect(<span class="literal">true</span>);  <span class="comment">// 设置自动连接</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;WiFi connected&quot;</span>);  </span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  smartConfig();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">   Serial.print(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="13、HttpClient–ESP8266HTTPClient库"><a href="#13、HttpClient–ESP8266HTTPClient库" class="headerlink" title="13、HttpClient–ESP8266HTTPClient库"></a>13、HttpClient–ESP8266HTTPClient库</h1><h2 id="1、HTTP"><a href="#1、HTTP" class="headerlink" title="1、HTTP"></a>1、HTTP</h2><h3 id="1、概述-2"><a href="#1、概述-2" class="headerlink" title="1、概述"></a>1、概述</h3><p><em><strong>HTTP协议（Hyper Text Transfer Protocol）超文本传输协议</strong></em>，用于从WWW服务器传输文本到本地浏览器的传送协议。基于TCP&#x2F;IP通信协议：浏览器作为HTTP客户端通过URL向HTTP服务端即WEB服务器发送所有请求。WEB服务器根据接收到的请求后，向客户端发送响应信息；</p>
<p>HTTP协议作为TCP&#x2F;IP模型中<strong>应用层</strong>的协议，承载与TCP协议上，有时也承载与TLS或者SSL协议层之上，这时就是<strong>HTTPS</strong>；</p>
<p>HTTP由<strong>请求</strong>与<strong>响应</strong>构成，是一个标准的客户端服务器模型，默认端口号80，HTTPS是443；</p>
<p>浏览网页时HTTP主要应用（不只是这个功能，只是一种协议，只要通信双方都支持这个协议，HTTP就能用）</p>
<p>特点：HTTP0.9与1.0使用非持续连接；1.1使用持续连接。</p>
<p>无状态，无记忆能力</p>
<h3 id="2、工作流程"><a href="#2、工作流程" class="headerlink" title="2、工作流程"></a>2、工作流程</h3><p>一次HTTP操作称位一个事务，可分4步：</p>
<ol>
<li><p>client与server建立连接；</p>
</li>
<li><p>连接后，client发送一个请求给server，请求方法格式：统一资源标示符（URL）、HTTP协议版本号、请求头、请求内容等；</p>
</li>
<li><p>server接收到请求后，给予响应，格式：状态行（包括协议版本、成功或者失败代码、服务器信息、实体信息等）</p>
</li>
<li><p>client接收到server返回信息，通过浏览器显示在用户显示屏上，然后client与server断开连接</p>
</li>
</ol>
<h3 id="3、HTTP请求"><a href="#3、HTTP请求" class="headerlink" title="3、HTTP请求"></a>3、HTTP请求</h3><p>Get请求：</p>
<ul>
<li>请求行（request line）：说明请求类型，要访问的资源及HTTP版本</li>
<li>请求头部（header）：说明服务器要使用的附加信息（第二行起位请求头部，HOST指出目的地；User-Agent是client与server脚本都能访问，是浏览器检测逻辑的重要基础）（该信息由浏览器定义，并在每个请求中自动发送）</li>
<li>空行（empty line）：请求头部后空行是必须的（即使第四部分请求数据为空，也必须有空行）</li>
<li>请求数据（request body）：主体，可添加任意其他数据（下面例子中请求数据为空）</li>
</ul>
<p>请求例子（Gharles抓取的request）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GET /<span class="number">562f</span>25980001b1b106000338.jpg HTTP/<span class="number">1.1</span></span><br><span class="line">Host    img.mukewang.com</span><br><span class="line">User-Agent    Mozilla/<span class="number">5.0</span> (Windows NT <span class="number">10.0</span>; WOW64) AppleWebKit/<span class="number">537.36</span> (KHTML, like Gecko) Chrome/<span class="number">51.0</span><span class="number">.2704</span><span class="number">.106</span> Safari/<span class="number">537.36</span></span><br><span class="line">Accept    image/webp,image<span class="comment">/*,*/</span>*;q=<span class="number">0.8</span></span><br><span class="line">Referer    http:<span class="comment">//www.imooc.com/</span></span><br><span class="line">Accept-Encoding    gzip, deflate, sdch</span><br><span class="line">Accept-Language    zh-CN,zh;q=<span class="number">0.8</span></span><br></pre></td></tr></table></figure>

<p>POST请求：</p>
<p>请求例子（Gharles抓取的request）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP1<span class="number">.1</span></span><br><span class="line">Host:www.wrox.com</span><br><span class="line">User-Agent:Mozilla/<span class="number">4.0</span> (compatible; MSIE <span class="number">6.0</span>; Windows NT <span class="number">5.1</span>; SV1; .NET CLR <span class="number">2.0</span><span class="number">.50727</span>; .NET CLR <span class="number">3.0</span><span class="number">.04506</span><span class="number">.648</span>; .NET CLR <span class="number">3.5</span><span class="number">.21022</span>)</span><br><span class="line">Content-Type:application/x-www-form-urlencoded</span><br><span class="line">Content-Length:<span class="number">40</span></span><br><span class="line">Connection: Keep-Alive</span><br><span class="line"> </span><br><span class="line">name=Professional%<span class="number">20</span>Ajax&amp;publisher=Wiley</span><br></pre></td></tr></table></figure>

<h3 id="4、HTTP-Response响应信息"><a href="#4、HTTP-Response响应信息" class="headerlink" title="4、HTTP Response响应信息"></a>4、HTTP Response响应信息</h3><ul>
<li>状态行</li>
<li>消息报头</li>
<li>空行</li>
<li>响应正文</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/huf9qH"><img src="https://z3.ax1x.com/2021/08/26/huf9qH.jpg" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/26/huf9qH.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="huf9qH.jpg"></a></p>
<p>HTTP状态码</p>
<h3 id="5、ESP8266HTTPClient库"><a href="#5、ESP8266HTTPClient库" class="headerlink" title="5、ESP8266HTTPClient库"></a>5、ESP8266HTTPClient库</h3><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/f3MpdO"><img src="https://z3.ax1x.com/2021/08/09/f3MpdO.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/09/f3MpdO.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="f3MpdO.png"></a></p>
<h3 id="6、示例"><a href="#6、示例" class="headerlink" title="6、示例"></a>6、示例</h3><ol>
<li>获取天气请求（心知天气）</li>
</ol>
<p>setup中配置好url，串口参数和httpclient并设置client请求头。loop中每1秒请求一次get服务，把获取回来的天气信息通过json库转成具体对应的数值</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示Http请求天气接口信息</span></span><br><span class="line"><span class="comment"> *    https://api.seniverse.com/v3/weather/now.json?key=Sv6J6HVHp8V2Cc34a&amp;location=beijing&amp;language=zh-Hans&amp;unit=c</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266HTTPClient.h&gt;</span>  <span class="comment">//不属于ESP8266WiFi库的一部分</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;XU-ChinaNet&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;15358228063&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* HOST = <span class="string">&quot;http://api.seniverse.com&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* APIKEY = <span class="string">&quot;&quot;</span>;        <span class="comment">//API KEY</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* CITY = <span class="string">&quot;yancheng&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* LANGUAGE = <span class="string">&quot;zh-Hans&quot;</span>;<span class="comment">//zh-Hans 简体中文  会显示乱码</span></span><br><span class="line">  </span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> HTTP_TIMEOUT = <span class="number">5000</span>;               <span class="comment">// max respone time from server</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 我们要从此网页中提取的数据的类型</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WeatherData</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> city[<span class="number">16</span>];<span class="comment">//城市名称</span></span><br><span class="line">  <span class="type">char</span> weather[<span class="number">32</span>];<span class="comment">//天气介绍（多云...）</span></span><br><span class="line">  <span class="type">char</span> temp[<span class="number">16</span>];<span class="comment">//温度</span></span><br><span class="line">  <span class="type">char</span> udate[<span class="number">32</span>];<span class="comment">//更新时间</span></span><br><span class="line">&#125;;</span><br><span class="line">WiFiClient client;</span><br><span class="line">HTTPClient http;</span><br><span class="line">String GetUrl;</span><br><span class="line">String response;</span><br><span class="line">WeatherData weatherData;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your setup code here, to run once:</span></span><br><span class="line">  WiFi.mode(WIFI_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connecting to &quot;</span>);<span class="comment">//写几句提示，哈哈</span></span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);   <span class="comment">//连接wifi</span></span><br><span class="line">  WiFi.setAutoConnect(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    <span class="comment">//这个函数是wifi连接状态，返回wifi链接状态</span></span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line"> </span><br><span class="line">  <span class="comment">//拼接get请求url  博哥后面考虑看看是否可以封装一个方法来用用 不需要自己一个个拼装这个url</span></span><br><span class="line">  GetUrl = String(HOST) + <span class="string">&quot;/v3/weather/now.json?key=&quot;</span>;</span><br><span class="line">  GetUrl += APIKEY;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;location=&quot;</span>;</span><br><span class="line">  GetUrl += CITY;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;language=&quot;</span>;</span><br><span class="line">  GetUrl += LANGUAGE;</span><br><span class="line">  <span class="comment">//设置超时</span></span><br><span class="line">  http.setTimeout(HTTP_TIMEOUT);</span><br><span class="line">  <span class="comment">//设置请求url</span></span><br><span class="line">  <span class="comment">//http.begin(GetUrl);</span></span><br><span class="line">  http.begin(client,GetUrl);</span><br><span class="line">  <span class="comment">//以下为设置一些头  其实没什么用 最重要是后端服务器支持</span></span><br><span class="line">  http.setUserAgent(<span class="string">&quot;esp8266&quot;</span>);<span class="comment">//用户代理版本</span></span><br><span class="line">  http.setAuthorization(<span class="string">&quot;esp8266&quot;</span>,<span class="string">&quot;boge&quot;</span>);<span class="comment">//用户校验信息</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//心知天气  发送http  get请求</span></span><br><span class="line">  <span class="type">int</span> httpCode = http.GET();</span><br><span class="line">  <span class="keyword">if</span> (httpCode &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;[HTTP] GET... code: %d\n&quot;</span>, httpCode);</span><br><span class="line">      <span class="comment">//判断请求是否成功</span></span><br><span class="line">      <span class="keyword">if</span> (httpCode == HTTP_CODE_OK) &#123;</span><br><span class="line">        <span class="comment">//读取响应内容</span></span><br><span class="line">        response = http.getString();</span><br><span class="line">        DebugPrintln(<span class="string">&quot;Get the data from Internet!&quot;</span>);</span><br><span class="line">        DebugPrintln(response);</span><br><span class="line">        <span class="comment">//解析响应内容</span></span><br><span class="line">        <span class="keyword">if</span> (parseUserData(response, &amp;weatherData)) &#123;</span><br><span class="line">          <span class="comment">//打印响应内容</span></span><br><span class="line">          printUserData(&amp;weatherData);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;[HTTP] GET... failed, error: %s\n&quot;</span>, http.errorToString(httpCode).c_str());</span><br><span class="line">  &#125;</span><br><span class="line">  http.end();</span><br><span class="line">  delay(<span class="number">1000</span>);<span class="comment">//每1s调用一次 </span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @Desc 解析数据 Json解析</span></span><br><span class="line"><span class="comment"> * 数据格式如下：</span></span><br><span class="line"><span class="comment"> * &#123;</span></span><br><span class="line"><span class="comment"> *    &quot;results&quot;: [</span></span><br><span class="line"><span class="comment"> *        &#123;</span></span><br><span class="line"><span class="comment"> *            &quot;location&quot;: &#123;</span></span><br><span class="line"><span class="comment"> *                &quot;id&quot;: &quot;WX4FBXXFKE4F&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;name&quot;: &quot;北京&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;country&quot;: &quot;CN&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;path&quot;: &quot;北京,北京,中国&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;timezone&quot;: &quot;Asia/Shanghai&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;timezone_offset&quot;: &quot;+08:00&quot;</span></span><br><span class="line"><span class="comment"> *            &#125;,</span></span><br><span class="line"><span class="comment"> *            &quot;now&quot;: &#123;</span></span><br><span class="line"><span class="comment"> *                &quot;text&quot;: &quot;多云&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;code&quot;: &quot;4&quot;,</span></span><br><span class="line"><span class="comment"> *                &quot;temperature&quot;: &quot;23&quot;</span></span><br><span class="line"><span class="comment"> *            &#125;,</span></span><br><span class="line"><span class="comment"> *            &quot;last_update&quot;: &quot;2017-09-13T09:51:00+08:00&quot;</span></span><br><span class="line"><span class="comment"> *        &#125;</span></span><br><span class="line"><span class="comment"> *    ]</span></span><br><span class="line"><span class="comment"> *&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parseUserData</span><span class="params">(String content, <span class="keyword">struct</span> WeatherData* weatherData)</span> &#123;</span><br><span class="line"><span class="comment">//    -- 根据我们需要解析的数据来计算JSON缓冲区最佳大小</span></span><br><span class="line"><span class="comment">//   如果你使用StaticJsonBuffer时才需要</span></span><br><span class="line"><span class="comment">//    const size_t BUFFER_SIZE = 1024;</span></span><br><span class="line"><span class="comment">//   在堆栈上分配一个临时内存池</span></span><br><span class="line"><span class="comment">//    StaticJsonBuffer&lt;BUFFER_SIZE&gt; jsonBuffer;</span></span><br><span class="line"><span class="comment">//    -- 如果堆栈的内存池太大，使用 DynamicJsonBuffer jsonBuffer 代替</span></span><br><span class="line">  DynamicJsonBuffer jsonBuffer;</span><br><span class="line">   </span><br><span class="line">  JsonObject&amp; root = jsonBuffer.parseObject(content);</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">if</span> (!root.success()) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;JSON parsing failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">//复制我们感兴趣的字符串</span></span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;city, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;location&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;weather, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;text&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;temp, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;temperature&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(weatherData-&gt;udate, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;last_update&quot;</span>]);</span><br><span class="line">  <span class="comment">//  -- 这不是强制复制，你可以使用指针，因为他们是指向“内容”缓冲区内，所以你需要确保</span></span><br><span class="line">  <span class="comment">//   当你读取字符串时它仍在内存中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">   </span><br><span class="line"><span class="comment">// 打印从JSON中提取的数据</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">printUserData</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> WeatherData* weatherData)</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Print parsed data :&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;City : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;city);</span><br><span class="line">  DebugPrint(<span class="string">&quot;, \t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Weather : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;weather);</span><br><span class="line">  DebugPrint(<span class="string">&quot;,\t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Temp : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;temp);</span><br><span class="line">  DebugPrint(<span class="string">&quot; C&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;,\t&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Last Updata : &quot;</span>);</span><br><span class="line">  DebugPrint(weatherData-&gt;udate);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>演视响应头获取信息</p>
<p>设置了获取四个请求头的信息，然后通过header方法获取它们的数值（接口限制，无法发挥作用）</p>
</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示Http请求天气接口信息,演示响应头操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266HTTPClient.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;XU-ChinaNet&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;15358228063&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* HOST = <span class="string">&quot;http://api.seniverse.com&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* APIKEY = <span class="string">&quot;&quot;</span>;        <span class="comment">//API KEY</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* CITY = <span class="string">&quot;yancheng&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* LANGUAGE = <span class="string">&quot;zh-Hans&quot;</span>;<span class="comment">//zh-Hans 简体中文  会显示乱码</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *keys[] = &#123;<span class="string">&quot;Content-Length&quot;</span>,<span class="string">&quot;Content-Type&quot;</span>,<span class="string">&quot;Connection&quot;</span>,<span class="string">&quot;Date&quot;</span>&#125;;<span class="comment">//需要收集的响应头的信息</span></span><br><span class="line">  </span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> HTTP_TIMEOUT = <span class="number">5000</span>;               <span class="comment">// max respone time from server;</span></span><br><span class="line"></span><br><span class="line">WiFiClient client;</span><br><span class="line">HTTPClient http;</span><br><span class="line">String GetUrl;</span><br><span class="line">String response;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your setup code here, to run once:</span></span><br><span class="line">  WiFi.mode(WIFI_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connecting to &quot;</span>);<span class="comment">//写几句提示，哈哈</span></span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);   <span class="comment">//连接wifi</span></span><br><span class="line">  WiFi.setAutoConnect(<span class="literal">true</span>);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    <span class="comment">//这个函数是wifi连接状态，返回wifi链接状态</span></span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;WiFi connected&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">  <span class="comment">//拼接get请求url  博哥后面考虑看看是否可以封装一个方法来用用 不需要自己一个个拼装这个url</span></span><br><span class="line">  GetUrl = String(HOST) + <span class="string">&quot;/v3/weather/now.json?key=&quot;</span>;</span><br><span class="line">  GetUrl += APIKEY;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;location=&quot;</span>;</span><br><span class="line">  GetUrl += CITY;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;language=&quot;</span>;</span><br><span class="line">  GetUrl += LANGUAGE;</span><br><span class="line">  <span class="comment">//设置超时</span></span><br><span class="line">  http.setTimeout(HTTP_TIMEOUT);</span><br><span class="line">  <span class="comment">//设置请求url</span></span><br><span class="line">  http.begin(client,GetUrl);</span><br><span class="line">  <span class="comment">//以下为设置一些头  其实没什么用 最重要是后端服务器支持</span></span><br><span class="line">  http.setUserAgent(<span class="string">&quot;esp8266&quot;</span>);<span class="comment">//用户代理版本</span></span><br><span class="line">  http.setAuthorization(<span class="string">&quot;esp8266&quot;</span>,<span class="string">&quot;boge&quot;</span>);<span class="comment">//用户校验信息</span></span><br><span class="line">  http.addHeader(<span class="string">&quot;myname&quot;</span>,<span class="string">&quot;cainiaobo&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//设置获取响应头的信息</span></span><br><span class="line">  http.collectHeaders(keys,<span class="number">4</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//心知天气  发送http  get请求</span></span><br><span class="line">  <span class="type">int</span> httpCode = http.GET();</span><br><span class="line">  <span class="keyword">if</span> (httpCode &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;[HTTP] GET... code: %d\n&quot;</span>, httpCode);</span><br><span class="line">      <span class="comment">//判断请求是否成功</span></span><br><span class="line">      <span class="keyword">if</span> (httpCode == HTTP_CODE_OK) &#123;</span><br><span class="line">        <span class="comment">//读取响应内容</span></span><br><span class="line">        response = http.getString();</span><br><span class="line">        DebugPrintln(<span class="string">&quot;Get the data from Internet!&quot;</span>);</span><br><span class="line">        DebugPrintln(response);</span><br><span class="line">        DebugPrintln(String(<span class="string">&quot;Content-Length:&quot;</span>)+ http.header(<span class="string">&quot;Content-Length&quot;</span>));</span><br><span class="line">        DebugPrintln(String(<span class="string">&quot;Content-Type:&quot;</span>)+ http.header(<span class="string">&quot;Content-Type&quot;</span>));</span><br><span class="line">        DebugPrintln(String(<span class="string">&quot;Connection:&quot;</span>)+ http.header(<span class="string">&quot;Connection&quot;</span>));</span><br><span class="line">        DebugPrintln(String(<span class="string">&quot;Date:&quot;</span>)+ http.header(<span class="string">&quot;Date&quot;</span>));</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;[HTTP] GET... failed, error: %s\n&quot;</span>, http.errorToString(httpCode).c_str());</span><br><span class="line">  &#125;</span><br><span class="line">  http.end();</span><br><span class="line">  delay(<span class="number">1000</span>);<span class="comment">//每1s调用一次 </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="14、UDP服务"><a href="#14、UDP服务" class="headerlink" title="14、UDP服务"></a>14、UDP服务</h1><h2 id="1、UDP"><a href="#1、UDP" class="headerlink" title="1、UDP"></a>1、UDP</h2><p>UDP（User Datagram Protocol）一种无连接、不可靠的协议（可能会丢包），</p>
<p>相对于TCP而言：</p>
<ul>
<li><p>UDP面向无连接的，不需建立连接（TCP是面向连接的）</p>
</li>
<li><p>UDP尽力做到可靠，但不绝对可靠（TCP无差错、不丢失、不重复且按序到达）</p>
</li>
<li><p>UDP较好实时性，效率比TCP高</p>
</li>
<li><p>UDP支持一对一，一对多，多对一和多对多的交互通信（TCP点到点）</p>
</li>
<li><p>UDP对系统资源要求较少（TCP多）</p>
</li>
</ul>
<h2 id="2、库和示例"><a href="#2、库和示例" class="headerlink" title="2、库和示例"></a>2、库和示例</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/f31s6s"><img src="https://z3.ax1x.com/2021/08/09/f31s6s.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/09/f31s6s.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="f31s6s.png"></a></p>
<ol>
<li>通过UDP收发数据</li>
</ol>
<p>ESP8266作为UDP服务端，把电脑UDP客户端发过来的数据打印到串口调试器，并回复应答消息（使用Packet Sender软件发送UDP数据）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiUdp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;XU-ChinaNet&quot;</span>;<span class="comment">//wifi账号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;15358228063&quot;</span>;<span class="comment">//wifi密码</span></span><br><span class="line"></span><br><span class="line">WiFiUDP Udp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> localUdpPort = <span class="number">4210</span>;  <span class="comment">// 本地监听端口</span></span><br><span class="line"><span class="type">char</span> incomingPacket[<span class="number">255</span>];  <span class="comment">// 存储Udp客户端发过来的数据</span></span><br><span class="line"><span class="type">char</span>  replyPacket[] = <span class="string">&quot;Hi there! Got the message :-)&quot;</span>;  <span class="comment">// 应答信息</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Connecting to %s &quot;</span>, ssid);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)</span><br><span class="line">  &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot; connected&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//启动Udp监听服务</span></span><br><span class="line">  Udp.begin(localUdpPort);</span><br><span class="line">  <span class="comment">//打印本地ip地址，udp client端会使用到</span></span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Now listening at IP %s, UDP port %d\n&quot;</span>, WiFi.localIP().toString().c_str(), localUdpPort);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//解析Udp数据包</span></span><br><span class="line">  <span class="type">int</span> packetSize = Udp.parsePacket();</span><br><span class="line">  <span class="keyword">if</span> (packetSize)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// 收到Udp数据包</span></span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;Received %d bytes from %s, port %d\n&quot;</span>, packetSize, Udp.remoteIP().toString().c_str(), Udp.remotePort());</span><br><span class="line">    <span class="comment">// 读取Udp数据包</span></span><br><span class="line">    <span class="type">int</span> len = Udp.read(incomingPacket, <span class="number">255</span>);</span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      incomingPacket[len] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//向D串口调试器打印信息</span></span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;UP packet contents: %s\n&quot;</span>, incomingPacket);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//往udp 远端发送应答信息</span></span><br><span class="line">    Udp.beginPacket(Udp.remoteIP(), Udp.remotePort());</span><br><span class="line">    Udp.write(replyPacket);</span><br><span class="line">    Udp.endPacket();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>通过UDP控制LED</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiUdp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *ssid = <span class="string">&quot;XU-ChinaNet&quot;</span>;     <span class="comment">//wifi名称</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *password = <span class="string">&quot;15358228063&quot;</span>; <span class="comment">//wifi密码</span></span><br><span class="line"></span><br><span class="line">WiFiUDP Udp;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> localUdpPort = <span class="number">4210</span>; <span class="comment">// 本地端口号</span></span><br><span class="line"><span class="type">char</span> incomingPacket[<span class="number">255</span>];         <span class="comment">// 接收缓冲区</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">//以下为基本功能初始化，初始化串口和网络和LED</span></span><br><span class="line">  pinMode(LED_BUILTIN, OUTPUT);</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  Serial.println();</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Connecting to %s &quot;</span>, ssid);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED)</span><br><span class="line">  &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot; connected&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//以下开启UDP监听并打印输出信息</span></span><br><span class="line">  Udp.begin(localUdpPort);</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Now listening at IP %s, UDP port %d\n&quot;</span>, WiFi.localIP().toString().c_str(), localUdpPort);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> packetSize = Udp.parsePacket(); <span class="comment">//获取当前队首数据包长度</span></span><br><span class="line">  <span class="keyword">if</span> (packetSize)  <span class="comment">// 有数据可用</span></span><br><span class="line">  &#123;</span><br><span class="line">    Serial.<span class="built_in">printf</span>(<span class="string">&quot;Received %d bytes from %s, port %d\n&quot;</span>, packetSize, Udp.remoteIP().toString().c_str(), Udp.remotePort());</span><br><span class="line">    <span class="type">int</span> len = Udp.read(incomingPacket, <span class="number">255</span>); <span class="comment">// 读取数据到incomingPacket</span></span><br><span class="line">    <span class="keyword">if</span> (len &gt; <span class="number">0</span>)                             <span class="comment">// 如果正确读取</span></span><br><span class="line">    &#123;</span><br><span class="line">      incomingPacket[len] = <span class="number">0</span>; <span class="comment">//末尾补0结束字符串</span></span><br><span class="line">      Serial.<span class="built_in">printf</span>(<span class="string">&quot;UDP packet contents: %s\n&quot;</span>, incomingPacket);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(incomingPacket, <span class="string">&quot;LED_OFF&quot;</span>) == <span class="number">0</span>) <span class="comment">// 命令LED_OFF</span></span><br><span class="line">      &#123;</span><br><span class="line">        digitalWrite(LED_BUILTIN, HIGH); <span class="comment">// 熄灭LED</span></span><br><span class="line">        sendCallBack(<span class="string">&quot;LED has been turn off&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strcmp</span>(incomingPacket, <span class="string">&quot;LED_ON&quot;</span>) == <span class="number">0</span>) <span class="comment">// 如果收到LED_ON</span></span><br><span class="line">      &#123;</span><br><span class="line">        digitalWrite(LED_BUILTIN, LOW); <span class="comment">// 点亮LED</span></span><br><span class="line">        sendCallBack(<span class="string">&quot;LED has been turn on&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> <span class="comment">// 如果非指定消息</span></span><br><span class="line">      &#123;</span><br><span class="line">        sendCallBack(<span class="string">&quot;Command Error!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 发送响应信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">sendCallBack</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *buffer)</span>&#123;</span><br><span class="line">   Udp.beginPacket(Udp.remoteIP(), Udp.remotePort());</span><br><span class="line">   Udp.write(buffer); <span class="comment">//回复内容</span></span><br><span class="line">   Udp.endPacket(); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="15、WebServer–ESP8266WebServer库"><a href="#15、WebServer–ESP8266WebServer库" class="headerlink" title="15、WebServer–ESP8266WebServer库"></a>15、WebServer–ESP8266WebServer库</h1><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/f8kYYq"><img src="https://z3.ax1x.com/2021/08/09/f8kYYq.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/09/f8kYYq.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="f8kYYq.png"></a></p>
<p><strong>示例：</strong></p>
<ol>
<li>演示webserver基础功能，wifi模块连接上热点后，在PC浏览器上输入serverip+url访问</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示webserver基础功能</span></span><br><span class="line"><span class="comment"> *    (当wifi模块连接上ap之后，在pc浏览器中输入ip+uri来访问)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;TP-LINK_5344&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;6206908you11011010&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明一下函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"> </span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;<span class="comment">//创建一个webserver</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理根目录uri请求</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> &#123;</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;hello from esp8266!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理无效uri</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/xxxx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//打印无效uri的信息 包括请求方式 请求参数</span></span><br><span class="line">  String message = <span class="string">&quot;File Not Found\n\n&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;URI: &quot;</span>;</span><br><span class="line">  message += server.uri();</span><br><span class="line">  message += <span class="string">&quot;\nMethod: &quot;</span>;</span><br><span class="line">  message += (server.method() == HTTP_GET) ? <span class="string">&quot;GET&quot;</span> : <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;\nArguments: &quot;</span>;</span><br><span class="line">  message += server.args();</span><br><span class="line">  message += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; server.args(); i++) &#123;</span><br><span class="line">    message += <span class="string">&quot; &quot;</span> + server.argName(i) + <span class="string">&quot;: &quot;</span> + server.arg(i) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  initBasic();</span><br><span class="line">  initWifi();</span><br><span class="line">  initWebServer();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化基础功能：波特率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化wifi模块：工作模式 连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Wait for connection</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//以下配置uri对应的handler</span></span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, handleRoot);</span><br><span class="line"> </span><br><span class="line">  server.on(<span class="string">&quot;/inline&quot;</span>, []() &#123;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;this works as well&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"> </span><br><span class="line">  server.onNotFound(handleNotFound);</span><br><span class="line">  <span class="comment">//启动webserver</span></span><br><span class="line">  server.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;HTTP server started&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>演示webserver返回html功能</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示webserver html功能</span></span><br><span class="line"><span class="comment"> *    (当wifi模块连接上ap之后，在pc浏览器中输入ip+uri来访问)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;XU-ChinaNet&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;15358228063&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明一下函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"> </span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理根目录uri请求</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> temp[<span class="number">400</span>];</span><br><span class="line">  <span class="type">int</span> sec = millis() / <span class="number">1000</span>;</span><br><span class="line">  <span class="type">int</span> min = sec / <span class="number">60</span>;</span><br><span class="line">  <span class="type">int</span> hr = min / <span class="number">60</span>;</span><br><span class="line"> </span><br><span class="line">  <span class="built_in">snprintf</span>(temp, <span class="number">400</span>,</span><br><span class="line"> </span><br><span class="line">           <span class="string">&quot;&lt;html&gt;\</span></span><br><span class="line"><span class="string">  &lt;head&gt;\</span></span><br><span class="line"><span class="string">    &lt;meta http-equiv=&#x27;refresh&#x27; content=&#x27;5&#x27;/&gt;\</span></span><br><span class="line"><span class="string">    &lt;title&gt;ESP8266 Demo&lt;/title&gt;\</span></span><br><span class="line"><span class="string">    &lt;style&gt;\</span></span><br><span class="line"><span class="string">      body &#123; background-color: #cccccc; font-family: Arial, Helvetica, Sans-Serif; Color: #000088; &#125;\</span></span><br><span class="line"><span class="string">    &lt;/style&gt;\</span></span><br><span class="line"><span class="string">  &lt;/head&gt;\</span></span><br><span class="line"><span class="string">  &lt;body&gt;\</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Hello from ESP8266!&lt;/h1&gt;\</span></span><br><span class="line"><span class="string">    &lt;p&gt;Uptime: %02d:%02d:%02d&lt;/p&gt;\</span></span><br><span class="line"><span class="string">    &lt;img src=\&quot;/test.svg\&quot; /&gt;\</span></span><br><span class="line"><span class="string">  &lt;/body&gt;\</span></span><br><span class="line"><span class="string">&lt;/html&gt;&quot;</span>,</span><br><span class="line"> </span><br><span class="line">           hr, min % <span class="number">60</span>, sec % <span class="number">60</span></span><br><span class="line">          );</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, temp);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理无效uri</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/xxxx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//打印无效uri的信息 包括请求方式 请求参数</span></span><br><span class="line">  String message = <span class="string">&quot;File Not Found\n\n&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;URI: &quot;</span>;</span><br><span class="line">  message += server.uri();</span><br><span class="line">  message += <span class="string">&quot;\nMethod: &quot;</span>;</span><br><span class="line">  message += (server.method() == HTTP_GET) ? <span class="string">&quot;GET&quot;</span> : <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;\nArguments: &quot;</span>;</span><br><span class="line">  message += server.args();</span><br><span class="line">  message += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; server.args(); i++) &#123;</span><br><span class="line">    message += <span class="string">&quot; &quot;</span> + server.argName(i) + <span class="string">&quot;: &quot;</span> + server.arg(i) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  initBasic();</span><br><span class="line">  initWifi();</span><br><span class="line">  initWebServer();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化基础功能：波特率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化wifi模块：工作模式 连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Wait for connection</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//以下配置uri对应的handler</span></span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, handleRoot);</span><br><span class="line"> </span><br><span class="line">  server.on(<span class="string">&quot;/inline&quot;</span>, []() &#123;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;this works as well&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  server.on(<span class="string">&quot;/test.svg&quot;</span>, drawGraph);</span><br><span class="line">  server.onNotFound(handleNotFound);</span><br><span class="line">  <span class="comment">//启动webserver</span></span><br><span class="line">  server.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;HTTP server started&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 画图</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">drawGraph</span><span class="params">()</span> &#123;</span><br><span class="line">  String out = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="type">char</span> temp[<span class="number">100</span>];</span><br><span class="line">  out += <span class="string">&quot;&lt;svg xmlns=\&quot;http://www.w3.org/2000/svg\&quot; version=\&quot;1.1\&quot; width=\&quot;400\&quot; height=\&quot;150\&quot;&gt;\n&quot;</span>;</span><br><span class="line">  out += <span class="string">&quot;&lt;rect width=\&quot;400\&quot; height=\&quot;150\&quot; fill=\&quot;rgb(250, 230, 210)\&quot; stroke-width=\&quot;1\&quot; stroke=\&quot;rgb(0, 0, 0)\&quot; /&gt;\n&quot;</span>;</span><br><span class="line">  out += <span class="string">&quot;&lt;g stroke=\&quot;black\&quot;&gt;\n&quot;</span>;</span><br><span class="line">  <span class="type">int</span> y = rand() % <span class="number">130</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> x = <span class="number">10</span>; x &lt; <span class="number">390</span>; x += <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="type">int</span> y2 = rand() % <span class="number">130</span>;</span><br><span class="line">    <span class="built_in">sprintf</span>(temp, <span class="string">&quot;&lt;line x1=\&quot;%d\&quot; y1=\&quot;%d\&quot; x2=\&quot;%d\&quot; y2=\&quot;%d\&quot; stroke-width=\&quot;1\&quot; /&gt;\n&quot;</span>, x, <span class="number">140</span> - y, x + <span class="number">10</span>, <span class="number">140</span> - y2);</span><br><span class="line">    out += temp;</span><br><span class="line">    y = y2;</span><br><span class="line">  &#125;</span><br><span class="line">  out += <span class="string">&quot;&lt;/g&gt;\n&lt;/svg&gt;\n&quot;</span>;</span><br><span class="line"> </span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;image/svg+xml&quot;</span>, out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>演示webserver校验账号密码功能，Autherticate请求头</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示webserver auth校验功能</span></span><br><span class="line"><span class="comment"> *    (当wifi模块连接上ap之后，在pc浏览器中输入ip+uri来访问，不过需要带校验请求头)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;XU-ChinaNet&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;15358228063&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* www_username = <span class="string">&quot;admin&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* www_password = <span class="string">&quot;esp8266&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明一下函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"> </span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;<span class="comment">//创建webserver</span></span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  initBasic();</span><br><span class="line">  initWifi();</span><br><span class="line">  initWebServer();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化基础功能：波特率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化wifi模块：工作模式 连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Wait for connection</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//以下配置uri对应的handler</span></span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, []() &#123;</span><br><span class="line">    <span class="comment">//校验帐号和密码</span></span><br><span class="line">    <span class="keyword">if</span> (!server.authenticate(www_username, www_password)) &#123;</span><br><span class="line">      <span class="keyword">return</span> server.requestAuthentication();</span><br><span class="line">    &#125;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;Login OK&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  server.begin();</span><br><span class="line"> </span><br><span class="line">  DebugPrint(<span class="string">&quot;Open http://&quot;</span>);</span><br><span class="line">  DebugPrint(WiFi.localIP());</span><br><span class="line">  DebugPrintln(<span class="string">&quot;/ in your browser to see it working&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>演示webserver登录功能，html登录页面</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示webserver auth校验功能</span></span><br><span class="line"><span class="comment"> *    (当wifi模块连接上ap之后，在pc浏览器中输入ip+uri来访问，不过需要带校验请求头)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;TP-LINK_5344&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;6206908you11011010&quot;</span>;         <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明一下函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"> </span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 校验是否存在cookie头并且cookie头的值是正确的</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">is_authentified</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Enter is_authentified&quot;</span>);</span><br><span class="line">  <span class="comment">//是否存在cookie头</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasHeader(<span class="string">&quot;Cookie&quot;</span>)) &#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;Found cookie: &quot;</span>);</span><br><span class="line">    <span class="comment">//获取cookie头的信息</span></span><br><span class="line">    String cookie = server.header(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">    DebugPrintln(cookie);</span><br><span class="line">    <span class="keyword">if</span> (cookie.indexOf(<span class="string">&quot;ESPSESSIONID=1&quot;</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Authentification Successful&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Authentification Failed&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理登陆uri</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleLogin</span><span class="params">()</span> &#123;</span><br><span class="line">  String msg;</span><br><span class="line">  <span class="comment">//判断是否存在cookie头</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasHeader(<span class="string">&quot;Cookie&quot;</span>)) &#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;Found cookie: &quot;</span>);</span><br><span class="line">    String cookie = server.header(<span class="string">&quot;Cookie&quot;</span>);</span><br><span class="line">    DebugPrint(cookie);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//判断是否存在DISCONNECT参数</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;DISCONNECT&quot;</span>)) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Disconnection&quot;</span>);</span><br><span class="line">    server.sendHeader(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    server.sendHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">    server.sendHeader(<span class="string">&quot;Set-Cookie&quot;</span>, <span class="string">&quot;ESPSESSIONID=0&quot;</span>);</span><br><span class="line">    server.send(<span class="number">301</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//判断是否存在USERNAME和PASSWORD参数</span></span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;USERNAME&quot;</span>) &amp;&amp; server.hasArg(<span class="string">&quot;PASSWORD&quot;</span>)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (server.arg(<span class="string">&quot;USERNAME&quot;</span>) == <span class="string">&quot;admin&quot;</span> &amp;&amp;  server.arg(<span class="string">&quot;PASSWORD&quot;</span>) == <span class="string">&quot;admin&quot;</span>) &#123;</span><br><span class="line">      server.sendHeader(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">      server.sendHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">      server.sendHeader(<span class="string">&quot;Set-Cookie&quot;</span>, <span class="string">&quot;ESPSESSIONID=1&quot;</span>);</span><br><span class="line">      server.send(<span class="number">301</span>);</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Log in Successful&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    msg = <span class="string">&quot;Wrong username/password! try again.&quot;</span>;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Log in Failed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//返回html 填写账号密码页面</span></span><br><span class="line">  String content = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;form action=&#x27;/login&#x27; method=&#x27;POST&#x27;&gt;To log in, please use : admin/admin&lt;br&gt;&quot;</span>;</span><br><span class="line">  content += <span class="string">&quot;User:&lt;input type=&#x27;text&#x27; name=&#x27;USERNAME&#x27; placeholder=&#x27;user name&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">  content += <span class="string">&quot;Password:&lt;input type=&#x27;password&#x27; name=&#x27;PASSWORD&#x27; placeholder=&#x27;password&#x27;&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">  content += <span class="string">&quot;&lt;input type=&#x27;submit&#x27; name=&#x27;SUBMIT&#x27; value=&#x27;Submit&#x27;&gt;&lt;/form&gt;&quot;</span> + msg + <span class="string">&quot;&lt;br&gt;&quot;</span>;</span><br><span class="line">  content += <span class="string">&quot;You also can go &lt;a href=&#x27;/inline&#x27;&gt;here&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, content);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根目录处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">//root page can be accessed only if authentification is ok</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Enter handleRoot&quot;</span>);</span><br><span class="line">  String header;</span><br><span class="line">  <span class="keyword">if</span> (!is_authentified()) &#123;</span><br><span class="line">    <span class="comment">//校验不通过</span></span><br><span class="line">    server.sendHeader(<span class="string">&quot;Location&quot;</span>, <span class="string">&quot;/login&quot;</span>);</span><br><span class="line">    server.sendHeader(<span class="string">&quot;Cache-Control&quot;</span>, <span class="string">&quot;no-cache&quot;</span>);</span><br><span class="line">    server.send(<span class="number">301</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  String content = <span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;H2&gt;hello, you successfully connected to esp8266!&lt;/H2&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (server.hasHeader(<span class="string">&quot;User-Agent&quot;</span>)) &#123;</span><br><span class="line">    content += <span class="string">&quot;the user agent used is : &quot;</span> + server.header(<span class="string">&quot;User-Agent&quot;</span>) + <span class="string">&quot;&lt;br&gt;&lt;br&gt;&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  content += <span class="string">&quot;You can access this page until you &lt;a href=\&quot;/login?DISCONNECT=YES\&quot;&gt;disconnect&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, content);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 无效uri处理器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span> &#123;</span><br><span class="line">  String message = <span class="string">&quot;File Not Found\n\n&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;URI: &quot;</span>;</span><br><span class="line">  message += server.uri();</span><br><span class="line">  message += <span class="string">&quot;\nMethod: &quot;</span>;</span><br><span class="line">  message += (server.method() == HTTP_GET) ? <span class="string">&quot;GET&quot;</span> : <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;\nArguments: &quot;</span>;</span><br><span class="line">  message += server.args();</span><br><span class="line">  message += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; server.args(); i++) &#123;</span><br><span class="line">    message += <span class="string">&quot; &quot;</span> + server.argName(i) + <span class="string">&quot;: &quot;</span> + server.arg(i) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  initBasic();</span><br><span class="line">  initWifi();</span><br><span class="line">  initWebServer();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化基础功能：波特率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化wifi模块：工作模式 连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Wait for connection</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//以下配置uri对应的handler</span></span><br><span class="line">  </span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, handleRoot);</span><br><span class="line">  server.on(<span class="string">&quot;/login&quot;</span>, handleLogin);</span><br><span class="line">  server.on(<span class="string">&quot;/inline&quot;</span>, []() &#123;</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;this works without need of authentification&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"> </span><br><span class="line">  server.onNotFound(handleNotFound);</span><br><span class="line">  <span class="comment">//设置需要收集的请求头</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> * headerkeys[] = &#123;<span class="string">&quot;User-Agent&quot;</span>, <span class="string">&quot;Cookie&quot;</span>&#125; ;</span><br><span class="line">  <span class="type">size_t</span> headerkeyssize = <span class="keyword">sizeof</span>(headerkeys) / <span class="keyword">sizeof</span>(<span class="type">char</span>*);</span><br><span class="line">  <span class="comment">//收集头信息</span></span><br><span class="line">  server.collectHeaders(headerkeys, headerkeyssize);</span><br><span class="line">  server.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;HTTP server started&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="16、域名服务–ESP8266mDNS库"><a href="#16、域名服务–ESP8266mDNS库" class="headerlink" title="16、域名服务–ESP8266mDNS库"></a>16、域名服务–ESP8266mDNS库</h1><h2 id="1、DNS"><a href="#1、DNS" class="headerlink" title="1、DNS"></a>1、DNS</h2><p>​	DNS（Domain Name System）域名系统（因特网上作为域名和IP地址相互映射的一个分布式数据库），DNS协议运行在UDP协议上，端口号53，mDNS（Multicast DNS）组播dns，主要实现了在<em>没有传统DNS服务器</em>的情况下使用<em>局域网内的主机实现本地发现和域名访问</em>，端口号5353，遵从dns协议（基于UDP协议，即运用了UDP广播）。</p>
<h2 id="2、库和示例-1"><a href="#2、库和示例-1" class="headerlink" title="2、库和示例"></a>2、库和示例</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/f88DBR"><img src="https://z3.ax1x.com/2021/08/09/f88DBR.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/09/f88DBR.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="f88DBR.png"></a></p>
<ol>
<li>演示ESP8266 mDNS responder功能</li>
</ol>
<p>电脑端输入<code>http://esp8266.local/</code>以域名方式访问webserver</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demo：</span></span><br><span class="line"><span class="comment"> *    演示ESP8266 mDNS responder功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"> </span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_SSID     = <span class="string">&quot;TP-LINK_5344&quot;</span>; <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi ssid</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* AP_PSK = <span class="string">&quot;6206908you11011010&quot;</span>;  <span class="comment">// XXXXXX -- 使用时请修改为当前你的 wifi 密码</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;<span class="comment">// serial connection speed</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//声明一下函数</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initmDNS</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"> </span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理根目录uri请求</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;handleRoot&quot;</span>);</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;Hello From ESP8266 mDNS demo&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理无效uri</span></span><br><span class="line"><span class="comment"> * uri:http://server_ip/xxxx</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;handleNotFound&quot;</span>);</span><br><span class="line">  <span class="comment">//打印无效uri的信息 包括请求方式 请求参数</span></span><br><span class="line">  String message = <span class="string">&quot;File Not Found\n\n&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;URI: &quot;</span>;</span><br><span class="line">  message += server.uri();</span><br><span class="line">  message += <span class="string">&quot;\nMethod: &quot;</span>;</span><br><span class="line">  message += (server.method() == HTTP_GET) ? <span class="string">&quot;GET&quot;</span> : <span class="string">&quot;POST&quot;</span>;</span><br><span class="line">  message += <span class="string">&quot;\nArguments: &quot;</span>;</span><br><span class="line">  message += server.args();</span><br><span class="line">  message += <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">uint8_t</span> i = <span class="number">0</span>; i &lt; server.args(); i++) &#123;</span><br><span class="line">    message += <span class="string">&quot; &quot;</span> + server.argName(i) + <span class="string">&quot;: &quot;</span> + server.arg(i) + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  initBasic();</span><br><span class="line">  initWifi();</span><br><span class="line">  initWebServer();</span><br><span class="line">  initmDNS();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  MDNS.update();    <span class="comment">//少这行</span></span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化基础功能：波特率</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initBasic</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(BAUD_RATE);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化wifi模块：工作模式 连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(AP_SSID, AP_PSK);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// Wait for connection</span></span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  DebugPrintln(AP_SSID);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//以下配置uri对应的handler</span></span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, handleRoot);</span><br><span class="line">  server.on(<span class="string">&quot;/inline&quot;</span>, []() &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;handleInline&quot;</span>);</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, <span class="string">&quot;this works as well&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  server.onNotFound(handleNotFound);</span><br><span class="line">  <span class="comment">//启动webserver</span></span><br><span class="line">  server.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;HTTP server started&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化mDNS</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initmDNS</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!MDNS.begin(<span class="string">&quot;esp8266&quot;</span>)) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Error setting up MDNS responder!&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">      delay(<span class="number">1000</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;mDNS responder started,please input http://esp8266.local/ in your browser after install Bonjour&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>2. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  演示ESP8266 mDNS 发现服务功能</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">  注意:</span></span><br><span class="line"><span class="comment">  - 输入你的 WiFi SSID 和 password.</span></span><br><span class="line"><span class="comment">  - 烧写到两块 ESP8266  板子 </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid     = <span class="string">&quot;...&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;...&quot;</span>;</span><br><span class="line"><span class="type">char</span> hostString[<span class="number">16</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;\r\nsetup()&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">sprintf</span>(hostString, <span class="string">&quot;ESP_%06X&quot;</span>, ESP.getChipId());</span><br><span class="line">  Serial.print(<span class="string">&quot;Hostname: &quot;</span>);</span><br><span class="line">  Serial.println(hostString);</span><br><span class="line">  WiFi.hostname(hostString);</span><br><span class="line"></span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    delay(<span class="number">250</span>);</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  Serial.print(<span class="string">&quot;Connected to &quot;</span>);</span><br><span class="line">  Serial.println(ssid);</span><br><span class="line">  Serial.print(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!MDNS.begin(hostString)) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;Error setting up MDNS responder!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;mDNS responder started&quot;</span>);</span><br><span class="line">  <span class="comment">//往mDNS里面注册服务</span></span><br><span class="line">  MDNS.addService(<span class="string">&quot;esp&quot;</span>, <span class="string">&quot;tcp&quot;</span>, <span class="number">8080</span>); </span><br><span class="line"></span><br><span class="line">  Serial.println(<span class="string">&quot;Sending mDNS query&quot;</span>);</span><br><span class="line">  <span class="comment">//查找服务</span></span><br><span class="line">  <span class="type">int</span> n = MDNS.queryService(<span class="string">&quot;esp&quot;</span>, <span class="string">&quot;tcp&quot;</span>); <span class="comment">// Send out query for esp tcp services</span></span><br><span class="line">  Serial.println(<span class="string">&quot;mDNS query done&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;no services found&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Serial.print(n);</span><br><span class="line">    Serial.println(<span class="string">&quot; service(s) found&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; n; ++i) &#123;</span><br><span class="line">      <span class="comment">// 打印查找到的服务具体信息</span></span><br><span class="line">      Serial.print(i + <span class="number">1</span>);</span><br><span class="line">      Serial.print(<span class="string">&quot;: &quot;</span>);</span><br><span class="line">      Serial.print(MDNS.hostname(i));</span><br><span class="line">      Serial.print(<span class="string">&quot; (&quot;</span>);</span><br><span class="line">      Serial.print(MDNS.IP(i));</span><br><span class="line">      Serial.print(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">      Serial.print(MDNS.port(i));</span><br><span class="line">      Serial.println(<span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println();</span><br><span class="line">  Serial.println(<span class="string">&quot;loop() next&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your main code here, to run repeatedly:</span></span><br></pre></td></tr></table></figure>

<h1 id="17、SPIFFS–ESP8266-SPIFFS文件系统"><a href="#17、SPIFFS–ESP8266-SPIFFS文件系统" class="headerlink" title="17、SPIFFS–ESP8266 SPIFFS文件系统"></a>17、SPIFFS–ESP8266 SPIFFS文件系统</h1><h2 id="1、概述："><a href="#1、概述：" class="headerlink" title="1、概述："></a>1、概述：</h2><p>​	Arduino环境下的esp8266的flash存储分配：</p>
<ol>
<li>代码区：程序存储区（包含当前代码区current Sketch、更新代码区OTA update）</li>
<li>文件系统：SPIFFS闪存文件系统（SPI Flash File System）可通过IDE配置，一般NodeMcu配置成3M&#96;&#96;&#96;#include&lt;FS.h&gt;&#96;&#96;</li>
</ol>
<p><strong>不支持目录</strong> <strong>文件名32字符限制</strong>  <strong>建议保持短文件名</strong></p>
<ol>
<li>EEPROM</li>
<li>WIFI Config：设置WiFi模块配置时存储的数据</li>
</ol>
<h2 id="2、库和使用"><a href="#2、库和使用" class="headerlink" title="2、库和使用"></a>2、库和使用</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fGpEUP"><img src="https://z3.ax1x.com/2021/08/09/fGpEUP.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/09/fGpEUP.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fGpEUP.png"></a></p>
<ol>
<li>文件操作</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：spiffs文件操作常见方法使用，包括文件查找、创建、打开、关闭、删除</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;FS.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> myFileName  <span class="string">&quot;mydemo.txt&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(<span class="number">9600</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Check Start SPIFFS...&quot;</span>);</span><br><span class="line">  <span class="comment">//启动SPIFFS，如果下载配置没有配置SPIFFS，返回false</span></span><br><span class="line">  <span class="keyword">if</span>(!SPIFFS.begin())&#123;</span><br><span class="line">     DebugPrintln(<span class="string">&quot;Start SPIFFS Failed!please check Arduino Download Config.&quot;</span>);</span><br><span class="line">     <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Start SPIFFS Done.&quot;</span>);</span><br><span class="line">  <span class="comment">//判断文件是否存在</span></span><br><span class="line">  <span class="keyword">if</span>(SPIFFS.exists(myFileName))&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt exists.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt not exists.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  File myFile;</span><br><span class="line">  <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(myFileName,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">  <span class="comment">//关闭文件</span></span><br><span class="line">  myFile.close();</span><br><span class="line">  <span class="comment">//再次判断文件是否存在</span></span><br><span class="line">  <span class="keyword">if</span>(SPIFFS.exists(myFileName))&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt exists.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt not exists.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//删除文件</span></span><br><span class="line">  DebugPrintln(<span class="string">&quot;mydemo.txt removing...&quot;</span>);</span><br><span class="line">  SPIFFS.remove(myFileName);</span><br><span class="line">  <span class="comment">//再次判断文件是否存在</span></span><br><span class="line">  <span class="keyword">if</span>(SPIFFS.exists(myFileName))&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt exists.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;mydemo.txt not exists.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看spiffs文件系统列表</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：查看spiffs文件系统列表</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;FS.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(<span class="number">9600</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Check Start SPIFFS...&quot;</span>);</span><br><span class="line">  <span class="comment">//启动SPIFFS，如果下载配置没有配置SPIFFS，返回false</span></span><br><span class="line">  <span class="keyword">if</span>(!SPIFFS.begin())&#123;</span><br><span class="line">     DebugPrintln(<span class="string">&quot;Start SPIFFS Failed!please check Arduino Download Config.&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Start SPIFFS Done.&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  File myFile;</span><br><span class="line">  <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;/myDemo.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">  <span class="comment">//关闭文件</span></span><br><span class="line">  myFile.close();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;/myDemo.jpg&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">  <span class="comment">//关闭文件</span></span><br><span class="line">  myFile.close();</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;/myDemo.html&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">  <span class="comment">//关闭文件</span></span><br><span class="line">  myFile.close();</span><br><span class="line">  </span><br><span class="line">  Dir dir = SPIFFS.openDir(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span>(dir.next())&#123;</span><br><span class="line">    String fileName = dir.fileName();</span><br><span class="line">  <span class="type">size_t</span> fileSize = dir.fileSize();</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;FS File:%s,size:%d\n&quot;</span>,fileName.c_str(),fileSize);</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>往文件myDemo.txt中写入一句话并读取出来显示</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：演示文件读写功能</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;FS.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(<span class="number">9600</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Check Start SPIFFS...&quot;</span>);</span><br><span class="line">  <span class="comment">//启动SPIFFS，如果下载配置没有配置SPIFFS，返回false</span></span><br><span class="line">  <span class="keyword">if</span>(!SPIFFS.begin())&#123;</span><br><span class="line">     DebugPrintln(<span class="string">&quot;Start SPIFFS Failed!please check Arduino Download Config.&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Start SPIFFS Done.&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  File myFile;</span><br><span class="line">  <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;myDemo.txt&quot;</span>,<span class="string">&quot;w+&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(myFile)&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Writing something to myDemo.txt...&quot;</span>);</span><br><span class="line">  myFile.println(<span class="string">&quot;单片机菜鸟博哥666&quot;</span>);</span><br><span class="line">  myFile.close();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Writing Done.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Open File Failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//打开文件 可读</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;myDemo.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(myFile)&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Reading myDemo.txt...&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span>(myFile.available())&#123;</span><br><span class="line">    <span class="comment">//读取文件输出</span></span><br><span class="line">    Serial.write(myFile.read());</span><br><span class="line">  &#125;</span><br><span class="line">  myFile.close();</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Open File Failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  DebugPrintln(<span class="string">&quot;Setup Done!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>烧写文件，将要存入SOIFFS区域的文件，提前放在代码目录的”data”目录中，使用<a target="_blank" rel="noopener" href="https://github.com/esp8266/arduino-esp8266fs-plugin/releases/download/0.5.0/ESP8266FS-0.5.0.zip">ESP8266FS</a>工具烧写（集成在ArduinoIDE中，但要安装这个工具）（提示没有找到这个工具的话，一般都是版本问题，换个版本就好了）</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：演示上传文件并读取文件内容</span></span><br><span class="line"><span class="comment"> * 前提：需要先往SPIFFS里面上传config.txt文件 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;FS.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//以下三个定义为调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugBegin(<span class="number">9600</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Check Start SPIFFS...&quot;</span>);</span><br><span class="line">  <span class="comment">//启动SPIFFS，如果下载配置没有配置SPIFFS，返回false</span></span><br><span class="line">  <span class="keyword">if</span>(!SPIFFS.begin())&#123;</span><br><span class="line">     DebugPrintln(<span class="string">&quot;Start SPIFFS Failed!please check Arduino Download Config.&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Start SPIFFS Done.&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  File myFile;</span><br><span class="line">  <span class="comment">//打开文件 不存在就创建一个 可读可写</span></span><br><span class="line">  myFile = SPIFFS.open(<span class="string">&quot;/config.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span>(myFile)&#123;</span><br><span class="line">    <span class="comment">//打印文件大小</span></span><br><span class="line">    <span class="type">int</span> size = myFile.size();</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Size=%d\r\n&quot;</span>, size);</span><br><span class="line">  <span class="comment">//读取文件内容</span></span><br><span class="line">  DebugPrintln(myFile.readString());</span><br><span class="line">  myFile.close();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Reading Done.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Open File Failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="18、web配网"><a href="#18、web配网" class="headerlink" title="18、web配网"></a>18、web配网</h1><p>自定义AP配网</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能：AP配网（web配网）</span></span><br><span class="line"><span class="comment"> * 作者：单片机菜鸟哥</span></span><br><span class="line"><span class="comment"> * 时间：2020-02-15</span></span><br><span class="line"><span class="comment"> * 描述：</span></span><br><span class="line"><span class="comment"> *    1.设置固定IP 192.168.4.1</span></span><br><span class="line"><span class="comment"> *    2.设置webserver监听web请求</span></span><br><span class="line"><span class="comment"> *    3.处理web请求，获取ssid和pwd</span></span><br><span class="line"><span class="comment"> *    4.连接网络</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">  <span class="comment">//以下三个定义为调试定义</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">  <span class="comment">//以下三个定义为调试定义</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugPrintln(message)</span></span><br><span class="line">  <span class="meta">#<span class="keyword">define</span> DebugPrint(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ap_ssid = <span class="string">&quot;esp_webconfig&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ap_password = <span class="string">&quot;&quot;</span>;<span class="comment">//开放式网络</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> sta_ssid[<span class="number">32</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">char</span> sta_password[<span class="number">64</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* webpage_html = <span class="string">&quot;\</span></span><br><span class="line"><span class="string">&lt;!DOCTYPE html&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;html lang=&#x27;en&#x27;&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;head&gt;\r\n\</span></span><br><span class="line"><span class="string">  &lt;meta charset=&#x27;UTF-8&#x27;&gt;\r\n\</span></span><br><span class="line"><span class="string">  &lt;title&gt;Document&lt;/title&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;/head&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;body&gt;\r\n\</span></span><br><span class="line"><span class="string">  &lt;form name=&#x27;input&#x27; action=&#x27;/&#x27; method=&#x27;POST&#x27;&gt;\r\n\</span></span><br><span class="line"><span class="string">        wifi名称: &lt;br&gt;\r\n\</span></span><br><span class="line"><span class="string">        &lt;input type=&#x27;text&#x27; name=&#x27;ssid&#x27;&gt;&lt;br&gt;\r\n\</span></span><br><span class="line"><span class="string">        wifi密码:&lt;br&gt;\r\n\</span></span><br><span class="line"><span class="string">        &lt;input type=&#x27;text&#x27; name=&#x27;password&#x27;&gt;&lt;br&gt;\r\n\</span></span><br><span class="line"><span class="string">        &lt;input type=&#x27;submit&#x27; value=&#x27;保存&#x27;&gt;\r\n\</span></span><br><span class="line"><span class="string">    &lt;/form&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;/body&gt;\r\n\</span></span><br><span class="line"><span class="string">&lt;/html&gt;\r\n\</span></span><br><span class="line"><span class="string">&quot;</span>;</span><br><span class="line"></span><br><span class="line">IPAddress <span class="title function_">local_IP</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">1</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">gateway</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">1</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">subnet</span><span class="params">(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initApConfig</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">connectToWifi</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRootPost</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">ESP8266WebServer <span class="title function_">server</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;connect ap: &quot;</span>);</span><br><span class="line">  DebugPrintln(ap_ssid);</span><br><span class="line"></span><br><span class="line">  initApConfig();</span><br><span class="line"></span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.softAPIP());</span><br><span class="line"></span><br><span class="line">  initWebServer();</span><br><span class="line"></span><br><span class="line">  DebugPrintln(<span class="string">&quot;HTTP server started&quot;</span>);</span><br><span class="line"></span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;Ready! Open http://%s in your browser\n&quot;</span>,</span><br><span class="line">  WiFi.softAPIP().toString().c_str());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  server.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化AP配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initApConfig</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  WiFi.softAPConfig(local_IP, gateway, subnet);</span><br><span class="line">  WiFi.softAP(ap_ssid, ap_password);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 初始化webserver配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWebServer</span><span class="params">()</span>&#123;</span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, HTTP_GET, handleRoot);</span><br><span class="line">  server.on(<span class="string">&quot;/&quot;</span>, HTTP_POST, handleRootPost);</span><br><span class="line">  server.onNotFound(handleNotFound);</span><br><span class="line"></span><br><span class="line">  server.begin();   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 连接到WiFi</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">connectToWifi</span><span class="params">()</span>&#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;connectToWifi&quot;</span>);</span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(sta_ssid, sta_password);</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">          delay(<span class="number">500</span>);</span><br><span class="line">          cnt++;</span><br><span class="line">          Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">          <span class="keyword">if</span>(cnt&gt;=<span class="number">40</span>)&#123;</span><br><span class="line">            cnt = <span class="number">0</span>;</span><br><span class="line">            <span class="comment">//重启系统</span></span><br><span class="line">            DebugPrintln(<span class="string">&quot;\r\nRestart now!&quot;</span>);</span><br><span class="line">            ESP.restart();</span><br><span class="line">          &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;connectToWifi Success!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理web post请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRootPost</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;handleRootPost&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;ssid&quot;</span>)) &#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;got ssid:&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(sta_ssid, server.arg(<span class="string">&quot;ssid&quot;</span>).c_str());</span><br><span class="line">    DebugPrintln(sta_ssid);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;error, not found ssid&quot;</span>);</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;error, not found ssid&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (server.hasArg(<span class="string">&quot;password&quot;</span>)) &#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;got password:&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(sta_password, server.arg(<span class="string">&quot;password&quot;</span>).c_str());</span><br><span class="line">    DebugPrintln(sta_password);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;error, not found password&quot;</span>);</span><br><span class="line">    server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;error, not found password&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, <span class="string">&quot;&lt;meta charset=&#x27;UTF-8&#x27;&gt;保存成功&quot;</span>);</span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  <span class="comment">//连接wifi</span></span><br><span class="line">  connectToWifi();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 处理web get请求</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleRoot</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;handleRoot&quot;</span>);</span><br><span class="line">  server.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, webpage_html);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">handleNotFound</span><span class="params">()</span> &#123;</span><br><span class="line">  String message = <span class="string">&quot;File Not Found\n\n&quot;</span>;</span><br><span class="line">  server.send(<span class="number">404</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="19、NTP–时间服务"><a href="#19、NTP–时间服务" class="headerlink" title="19、NTP–时间服务"></a>19、NTP–时间服务</h1><p>​	NTP（Network Time Protocol）网络时间协议，基于UDP，用于网络时间同步的协议，使网络中的计算机时钟同步到UTC,再配合各个时区的偏移调整就能实现精准同步对时功能。</p>
<p>NTP报文协议</p>
<p>实现:</p>
<ol>
<li>拼接协议</li>
<li>使用现成NTP第三方库（NTPClient）</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;NTPClient.h&gt;</span></span></span><br><span class="line"><span class="comment">// change next line to use with another board/shield</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="comment">//#include &lt;WiFi.h&gt; // for WiFi shield</span></span><br><span class="line"><span class="comment">//#include &lt;WiFi101.h&gt; // for WiFi 101 shield or MKR1000</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiUdp.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *ssid     = <span class="string">&quot;XU-ChinaNet&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span> *password = <span class="string">&quot;15358228063&quot;</span>;</span><br><span class="line"></span><br><span class="line">WiFiUDP ntpUDP;</span><br><span class="line"></span><br><span class="line"><span class="comment">// You can specify the time server pool and the offset (in seconds, can be</span></span><br><span class="line"><span class="comment">// changed later with setTimeOffset() ). Additionaly you can specify the</span></span><br><span class="line"><span class="comment">// update interval (in milliseconds, can be changed using setUpdateInterval() ).</span></span><br><span class="line">NTPClient <span class="title function_">timeClient</span><span class="params">(ntpUDP, <span class="string">&quot;ntp1.aliyun.com&quot;</span>, <span class="number">60</span>*<span class="number">60</span>*<span class="number">8</span>, <span class="number">30</span>*<span class="number">60</span>*<span class="number">1000</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span>&#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line"></span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( WiFi.status() != WL_CONNECTED ) &#123;</span><br><span class="line">    delay ( <span class="number">500</span> );</span><br><span class="line">    Serial.print ( <span class="string">&quot;.&quot;</span> );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  timeClient.begin();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  timeClient.update();</span><br><span class="line"></span><br><span class="line">  Serial.println(timeClient.getFormattedTime());</span><br><span class="line">  <span class="type">int</span> hours = timeClient.getHours();</span><br><span class="line">  <span class="type">int</span> minu =  timeClient.getMinutes();</span><br><span class="line">  <span class="type">int</span> sece =  timeClient.getSeconds();</span><br><span class="line">  Serial.<span class="built_in">printf</span>(<span class="string">&quot;hour:%d minu:%d sece:%d\n&quot;</span>, hours,minu,sece);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="20、DNSServer–真正的域名服务"><a href="#20、DNSServer–真正的域名服务" class="headerlink" title="20、DNSServer–真正的域名服务"></a>20、DNSServer–真正的域名服务</h1><p>​	建立DNS服务，使用时模块必须处于AP模式下；真正意义上的精简版DNS服务器；DNSServer运行于UDP服务；这里DNS服务器唯一的作用是把域名转成对应映射地址（只支持一个）</p>
<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fGI9sS"><img src="https://z3.ax1x.com/2021/08/10/fGI9sS.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/10/fGI9sS.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fGI9sS.png"></a></p>
<p>1. </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：在手机浏览器访问 &quot;www.danpianji.com&quot;会显示“Hello World” </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DNSServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> byte DNS_PORT = <span class="number">53</span>;</span><br><span class="line">IPAddress <span class="title function_">apIP</span><span class="params">(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)</span>;</span><br><span class="line">DNSServer dnsServer;</span><br><span class="line">ESP8266WebServer <span class="title function_">webServer</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  WiFi.softAPConfig(apIP, apIP, IPAddress(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>));</span><br><span class="line">  WiFi.softAP(<span class="string">&quot;DNSServer example&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// modify TTL associated  with the domain name (in seconds)</span></span><br><span class="line">  <span class="comment">// default is 60 seconds</span></span><br><span class="line">  dnsServer.setTTL(<span class="number">300</span>);</span><br><span class="line">  <span class="comment">// set which return code will be used for all other domains (e.g. sending</span></span><br><span class="line">  <span class="comment">// ServerFailure instead of NonExistentDomain will reduce number of queries</span></span><br><span class="line">  <span class="comment">// sent by clients)</span></span><br><span class="line">  <span class="comment">// default is DNSReplyCode::NonExistentDomain</span></span><br><span class="line">  dnsServer.setErrorReplyCode(DNSReplyCode::ServerFailure);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动DNS server，映射主机名为 www.danpianji.com</span></span><br><span class="line">  <span class="type">bool</span> status = dnsServer.start(DNS_PORT, <span class="string">&quot;www.danpianji.com&quot;</span>, apIP);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(status)&#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;start dnsserver success.&quot;</span>);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">     DebugPrintln(<span class="string">&quot;start dnsserver failed.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// simple HTTP server to see that DNS server is working</span></span><br><span class="line">  webServer.onNotFound([]() &#123;</span><br><span class="line">    String message = <span class="string">&quot;Hello World!\n\n&quot;</span>;</span><br><span class="line">    message += <span class="string">&quot;URI: &quot;</span>;</span><br><span class="line">    message += webServer.uri();</span><br><span class="line"></span><br><span class="line">    webServer.send(<span class="number">200</span>, <span class="string">&quot;text/plain&quot;</span>, message);</span><br><span class="line">  &#125;);</span><br><span class="line">  webServer.begin();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  dnsServer.processNextRequest();</span><br><span class="line">  webServer.handleClient();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Portal认证</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：portal认证</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;DNSServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> byte DNS_PORT = <span class="number">53</span>;</span><br><span class="line">IPAddress <span class="title function_">apIP</span><span class="params">(<span class="number">192</span>, <span class="number">168</span>, <span class="number">1</span>, <span class="number">1</span>)</span>;</span><br><span class="line">DNSServer dnsServer;</span><br><span class="line">ESP8266WebServer <span class="title function_">webServer</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line"></span><br><span class="line">String responseHTML = <span class="string">&quot;&quot;</span></span><br><span class="line">                      <span class="string">&quot;&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;CaptivePortal&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&quot;</span></span><br><span class="line">                      <span class="string">&quot;&lt;h1&gt;Hello World!&lt;/h1&gt;&lt;p&gt;This is a captive portal example. All requests will &quot;</span></span><br><span class="line">                      <span class="string">&quot;be redirected here.&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  WiFi.softAPConfig(apIP, apIP, IPAddress(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>));</span><br><span class="line">  WiFi.softAP(<span class="string">&quot;DNSServer CaptivePortal example&quot;</span>);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  <span class="comment">// 所有请求都映射到一个具体地址</span></span><br><span class="line">  dnsServer.start(DNS_PORT, <span class="string">&quot;*&quot;</span>, apIP);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// replay to all requests with same HTML</span></span><br><span class="line">  webServer.onNotFound([]() &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;webServer handle.&quot;</span>);</span><br><span class="line">    webServer.send(<span class="number">200</span>, <span class="string">&quot;text/html&quot;</span>, responseHTML);</span><br><span class="line">  &#125;);</span><br><span class="line">  webServer.begin();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  dnsServer.processNextRequest();</span><br><span class="line">  webServer.handleClient();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="21、无线更新–OTA固件更新"><a href="#21、无线更新–OTA固件更新" class="headerlink" title="21、无线更新–OTA固件更新"></a>21、无线更新–OTA固件更新</h1><h2 id="1、ArduinoOTA"><a href="#1、ArduinoOTA" class="headerlink" title="1、ArduinoOTA"></a>1、ArduinoOTA</h2><ul>
<li>连接WIFI；</li>
<li>配置ArduinoOTA对象的事件函数；</li>
<li>启动ArduinoOTA服务ArduinoOTA.begin();</li>
<li>在loop()函数将处理权交由ArduinoOTA.handle()。</li>
</ul>
<p>为了区分正常工作模式以及更新模式，可以设置标志位来区分（标志位可通过其他手段修改，如按键、软件控制）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (flag ==<span class="number">0</span> ) &#123;</span><br><span class="line">    <span class="comment">// 正常工作状态的代码</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ArduinoOTA.handle();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fGXaO1"><img src="https://z3.ax1x.com/2021/08/10/fGXaO1.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/10/fGXaO1.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fGXaO1.png"></a></p>
<p>python2.7环境</p>
<p>旧代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：OTA之Arduino IDE更新 V1.0版本代码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiUdp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoOTA.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CodeVersion <span class="string">&quot;CodeVersion V1.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;xxxx&quot;</span>;<span class="comment">//填上wifi账号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxxxx&quot;</span>;<span class="comment">//填上wifi密码</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Booting Sketch....&quot;</span>);</span><br><span class="line">  DebugPrintln(CodeVersion);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.waitForConnectResult() != WL_CONNECTED) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Connection Failed! Rebooting...&quot;</span>);</span><br><span class="line">    delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">//重启ESP8266模块</span></span><br><span class="line">    ESP.restart();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Port defaults to 8266</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPort(8266);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Hostname defaults to esp8266-[ChipID]</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setHostname(&quot;myesp8266&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// No authentication by default</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPassword(&quot;admin&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Password can be set with it&#x27;s md5 value as well</span></span><br><span class="line">  <span class="comment">// MD5(admin) = 21232f297a57a5a743894a0e4a801fc3</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPasswordHash(&quot;21232f297a57a5a743894a0e4a801fc3&quot;);</span></span><br><span class="line"></span><br><span class="line">  ArduinoOTA.onStart([]() &#123;</span><br><span class="line">    String type;</span><br><span class="line">  <span class="comment">//判断一下OTA内容</span></span><br><span class="line">    <span class="keyword">if</span> (ArduinoOTA.getCommand() == U_FLASH) &#123;</span><br><span class="line">      type = <span class="string">&quot;sketch&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// U_SPIFFS</span></span><br><span class="line">      type = <span class="string">&quot;filesystem&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> if updating SPIFFS this would be the place to unmount SPIFFS using SPIFFS.end()</span></span><br><span class="line">    DebugPrintln(<span class="string">&quot;Start updating &quot;</span> + type);</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onEnd([]() &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;\nEnd&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onProgress([](<span class="type">unsigned</span> <span class="type">int</span> progress, <span class="type">unsigned</span> <span class="type">int</span> total) &#123;</span><br><span class="line">    DebugPrintF(<span class="string">&quot;Progress: %u%%\r&quot;</span>, (progress / (total / <span class="number">100</span>)));</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onError([](<span class="type">ota_error_t</span> error) &#123;</span><br><span class="line">    DebugPrintF(<span class="string">&quot;Error[%u]: &quot;</span>, error);</span><br><span class="line">    <span class="keyword">if</span> (error == OTA_AUTH_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Auth Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_BEGIN_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Begin Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_CONNECT_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Connect Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_RECEIVE_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Receive Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_END_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;End Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Ready&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  ArduinoOTA.handle();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>烧写成功后，重启IDE（IDE与8266建立无线连接）端口项出现网络端口</p>
<p>新代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 功能描述：OTA之Arduino IDE更新 V1.1版本代码</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiUdp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoOTA.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CodeVersion <span class="string">&quot;CodeVersion V1.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;xxxx&quot;</span>;<span class="comment">//填上wifi账号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxxx&quot;</span>;<span class="comment">//填上wifi密码</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Booting Sketch....&quot;</span>);</span><br><span class="line">  DebugPrintln(CodeVersion);</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line">  <span class="keyword">while</span> (WiFi.waitForConnectResult() != WL_CONNECTED) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;Connection Failed! Rebooting...&quot;</span>);</span><br><span class="line">    delay(<span class="number">5000</span>);</span><br><span class="line">  <span class="comment">//重启ESP8266模块</span></span><br><span class="line">    ESP.restart();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Port defaults to 8266</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPort(8266);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Hostname defaults to esp8266-[ChipID]</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setHostname(&quot;myesp8266&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// No authentication by default</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPassword(&quot;admin&quot;);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Password can be set with it&#x27;s md5 value as well</span></span><br><span class="line">  <span class="comment">// MD5(admin) = 21232f297a57a5a743894a0e4a801fc3</span></span><br><span class="line">  <span class="comment">// ArduinoOTA.setPasswordHash(&quot;21232f297a57a5a743894a0e4a801fc3&quot;);</span></span><br><span class="line"></span><br><span class="line">  ArduinoOTA.onStart([]() &#123;</span><br><span class="line">    String type;</span><br><span class="line">  <span class="comment">//判断一下OTA内容</span></span><br><span class="line">    <span class="keyword">if</span> (ArduinoOTA.getCommand() == U_FLASH) &#123;</span><br><span class="line">      type = <span class="string">&quot;sketch&quot;</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// U_SPIFFS</span></span><br><span class="line">      type = <span class="string">&quot;filesystem&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> if updating SPIFFS this would be the place to unmount SPIFFS using SPIFFS.end()</span></span><br><span class="line">    DebugPrintln(<span class="string">&quot;Start updating &quot;</span> + type);</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onEnd([]() &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;\nEnd&quot;</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onProgress([](<span class="type">unsigned</span> <span class="type">int</span> progress, <span class="type">unsigned</span> <span class="type">int</span> total) &#123;</span><br><span class="line">    DebugPrintF(<span class="string">&quot;Progress: %u%%\r&quot;</span>, (progress / (total / <span class="number">100</span>)));</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.onError([](<span class="type">ota_error_t</span> error) &#123;</span><br><span class="line">    DebugPrintF(<span class="string">&quot;Error[%u]: &quot;</span>, error);</span><br><span class="line">    <span class="keyword">if</span> (error == OTA_AUTH_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Auth Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_BEGIN_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Begin Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_CONNECT_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Connect Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_RECEIVE_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;Receive Failed&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (error == OTA_END_ERROR) &#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;End Failed&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  ArduinoOTA.begin();</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Ready&quot;</span>);</span><br><span class="line">  DebugPrint(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  ArduinoOTA.handle();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="2、WebUpdateOTA"><a href="#2、WebUpdateOTA" class="headerlink" title="2、WebUpdateOTA"></a>2、WebUpdateOTA</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/fJ9d3T"><img src="https://z3.ax1x.com/2021/08/10/fJ9d3T.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/10/fJ9d3T.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="fJ9d3T.png"></a></p>
<ol>
<li>系统自带OTA之WEB更新（通过建立 webserver来上传新固件以达到更新目的）</li>
</ol>
<p>V1.1代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 功能描述：OTA之web更新 V1.0版本代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiClient.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266HTTPUpdateServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CodeVersion <span class="string">&quot;CodeVersion V1.0&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* host = <span class="string">&quot;esp8266-webupdate&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;xxx&quot;</span>;<span class="comment">//填上wifi账号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxx&quot;</span>;<span class="comment">//填上wifi密码</span></span><br><span class="line"></span><br><span class="line">ESP8266WebServer <span class="title function_">httpServer</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line">ESP8266HTTPUpdateServer httpUpdater;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Booting Sketch...&quot;</span>);</span><br><span class="line">  DebugPrintln(CodeVersion);</span><br><span class="line">  WiFi.mode(WIFI_AP_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (WiFi.waitForConnectResult() != WL_CONNECTED) &#123;</span><br><span class="line">    WiFi.begin(ssid, password);</span><br><span class="line">    DebugPrintln(<span class="string">&quot;WiFi failed, retrying.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//启动mdns服务</span></span><br><span class="line">  MDNS.begin(host);</span><br><span class="line">  <span class="comment">//配置webserver为更新server</span></span><br><span class="line">  httpUpdater.setup(&amp;httpServer);</span><br><span class="line">  httpServer.begin();</span><br><span class="line"></span><br><span class="line">  MDNS.addService(<span class="string">&quot;http&quot;</span>, <span class="string">&quot;tcp&quot;</span>, <span class="number">80</span>);</span><br><span class="line">  DebugPrintF(<span class="string">&quot;HTTPUpdateServer ready! Open http://%s.local/update in your browser\n&quot;</span>, host);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  httpServer.handleClient();</span><br><span class="line">  MDNS.update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同一WIFI下，打开调试器中提示的网站</p>
<p>编译V1.1代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 功能描述：OTA之web更新 V1.1版本代码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WiFiClient.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266mDNS.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266HTTPUpdateServer.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//调试定义</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugBegin(baud_rate)    Serial.begin(baud_rate)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintF(...) Serial.printf( __VA_ARGS__ )</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CodeVersion <span class="string">&quot;CodeVersion V1.1&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* host = <span class="string">&quot;esp8266-webupdate&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* ssid = <span class="string">&quot;xxx&quot;</span>;<span class="comment">//填上wifi账号</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* password = <span class="string">&quot;xxx&quot;</span>;<span class="comment">//填上wifi密码</span></span><br><span class="line"></span><br><span class="line">ESP8266WebServer <span class="title function_">httpServer</span><span class="params">(<span class="number">80</span>)</span>;</span><br><span class="line">ESP8266HTTPUpdateServer httpUpdater;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  DebugBegin(<span class="number">115200</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Booting Sketch...&quot;</span>);</span><br><span class="line">  DebugPrintln(CodeVersion);</span><br><span class="line">  WiFi.mode(WIFI_AP_STA);</span><br><span class="line">  WiFi.begin(ssid, password);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (WiFi.waitForConnectResult() != WL_CONNECTED) &#123;</span><br><span class="line">    WiFi.begin(ssid, password);</span><br><span class="line">    DebugPrintln(<span class="string">&quot;WiFi failed, retrying.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//启动mdns服务</span></span><br><span class="line">  MDNS.begin(host);</span><br><span class="line">  <span class="comment">//配置webserver为更新server</span></span><br><span class="line">  httpUpdater.setup(&amp;httpServer);</span><br><span class="line">  httpServer.begin();</span><br><span class="line"></span><br><span class="line">  MDNS.addService(<span class="string">&quot;http&quot;</span>, <span class="string">&quot;tcp&quot;</span>, <span class="number">80</span>);</span><br><span class="line">  DebugPrintF(<span class="string">&quot;HTTPUpdateServer ready! Open http://%s.local/update in your browser\n&quot;</span>, host);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  httpServer.handleClient();</span><br><span class="line">  MDNS.update();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>选择bin文件，通过WEB网页上传</p>
<ol start="2">
<li>自定义OTA之WEB更新（个性化页面）</li>
</ol>
<h2 id="3-SerialUpdateOTA—OTA之服务器更新"><a href="#3-SerialUpdateOTA—OTA之服务器更新" class="headerlink" title="3.SerialUpdateOTA—OTA之服务器更新"></a>3.SerialUpdateOTA—OTA之服务器更新</h2><p><a target="_blank" rel="noopener" href="https://imgtu.com/i/ftmccj"><img src="https://z3.ax1x.com/2021/08/10/ftmccj.png" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/10/ftmccj.png" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="ftmccj.png"></a></p>
<p>放在服务器上，无感知更新</p>
<h1 id="22、WebSocket-Client–全双工通信"><a href="#22、WebSocket-Client–全双工通信" class="headerlink" title="22、WebSocket Client–全双工通信"></a>22、WebSocket Client–全双工通信</h1><p>问题：HTTP：一个<em><strong>请求-响应</strong></em>应用层协议，客户端没有主动发请求，服务器不能主动给客户端发数据</p>
<p>方法：</p>
<ol>
<li><em><strong>轮询</strong></em>（浪费带宽资源）</li>
<li>应用层协议解决<em><strong>MQTT</strong></em>协议</li>
<li><em><strong>WebSocket</strong></em>协议：让客户端与服务器之间建立无限制的全双工通信，任何一方都可主动发消息给对方（HTML5定义的协议，更好的节省服务器资源和带宽，并实时进行通讯）</li>
</ol>
<p>两阶段：</p>
<ol>
<li><p>通过HTTP请求确认WebSocket握手协议阶段；</p>
</li>
<li><p>通过WebSocket交互数据阶段。</p>
</li>
</ol>
<h1 id="23、例程"><a href="#23、例程" class="headerlink" title="23、例程"></a>23、例程</h1><h2 id="1、局域网应用–炫酷RGB"><a href="#1、局域网应用–炫酷RGB" class="headerlink" title="1、局域网应用–炫酷RGB"></a>1、局域网应用–炫酷RGB</h2><p>相关技术点：</p>
<ul>
<li>ArduinoJson库</li>
<li>TCP Server服务</li>
<li>STA模式</li>
<li>一键配网</li>
</ul>
<p>内容：</p>
<p>手机、ESP8266均连接在同一个路由器wifi，8266作为服务端，手机作为客户端，手机再通过wifi给8266发送数据，8266接收到数据再把数据发给Arduino（串口通信）,Arduino解析数据达到控制效果</p>
<p>实现：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tingyouwu/WifiLamp">APP源码地址</a></p>
<p>8266端代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 功能：wifi RGB 8266端</span></span><br><span class="line"><span class="comment">*       加入SmartConfig功能</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_SRV_CLIENTS 3   <span class="comment">//最大同时联接数，即你想要接入的设备数量，8266tcpserver只能接入五个</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED 2</span></span><br><span class="line">  </span><br><span class="line">WiFiServer <span class="title function_">server</span><span class="params">(<span class="number">8266</span>)</span>;    <span class="comment">//你要的端口号，随意修改，范围0-65535</span></span><br><span class="line">WiFiClient serverClients[MAX_SRV_CLIENTS];</span><br><span class="line"><span class="type">int</span> flag = HIGH;<span class="comment">//默认当前灭灯</span></span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(<span class="number">115200</span>);</span><br><span class="line">  pinMode(LED,OUTPUT);</span><br><span class="line">  digitalWrite(LED, HIGH);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(!autoConfig())&#123;              <span class="comment">//连接WIFI，先是自动连接，超过20秒自动连接失败，开始smartConfig()</span></span><br><span class="line">    smartConfig();</span><br><span class="line">    Serial.print(<span class="string">&quot;Connecting to WiFi&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">       delay(<span class="number">500</span>);</span><br><span class="line">       Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  digitalWrite(LED, LOW);</span><br><span class="line">  Serial.println(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  Serial.println(WiFi.localIP());      <span class="comment">//WiFi.localIP()返回8266获得的ip地址</span></span><br><span class="line">  server.begin();</span><br><span class="line">  server.setNoDelay(<span class="literal">true</span>);  <span class="comment">//加上后才正常些</span></span><br><span class="line">  <span class="comment">//使能软件看门狗的触发间隔</span></span><br><span class="line">  ESP.wdtEnable(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">uint8_t</span> index;</span><br><span class="line">  <span class="keyword">if</span> (server.hasClient())&#123;</span><br><span class="line">        <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; MAX_SRV_CLIENTS; index++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (!serverClients[index] || !serverClients[index].connected())&#123;</span><br><span class="line">                <span class="keyword">if</span> (serverClients[index]) serverClients[index].stop();<span class="comment">//未联接,就释放</span></span><br><span class="line">                serverClients[index] = server.available();<span class="comment">//分配新的</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//8266tcpserver只能接入五个  超出的需要释放</span></span><br><span class="line">        WiFiClient serverClient = server.available();</span><br><span class="line">        <span class="keyword">if</span> (serverClient)&#123;</span><br><span class="line">          serverClient.stop();</span><br><span class="line">        &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; MAX_SRV_CLIENTS; index++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (serverClients[index] &amp;&amp; serverClients[index].connected())&#123;</span><br><span class="line">            <span class="comment">//处理客户端发过来的数据</span></span><br><span class="line">            <span class="keyword">if</span> (serverClients[index].available())&#123;</span><br><span class="line">                <span class="keyword">while</span> (serverClients[index].available()) </span><br><span class="line">                    <span class="comment">//把数据发送给mega</span></span><br><span class="line">                    Serial.write(serverClients[index].read());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span>(Serial.available()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="type">char</span> ch = Serial.read();</span><br><span class="line">      <span class="comment">//收到ardunio发过来的进入smartconfig模式的命令</span></span><br><span class="line">      <span class="keyword">if</span>(ch == <span class="string">&#x27;1&#x27;</span>)&#123;</span><br><span class="line">        smartConfig();</span><br><span class="line">        delay(<span class="number">1000</span>);</span><br><span class="line">        digitalWrite(LED, LOW);</span><br><span class="line">        Serial.println(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">        Serial.println(WiFi.localIP());<span class="comment">//WiFi.localIP()返回8266获得的ip地址</span></span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//喂狗</span></span><br><span class="line">   ESP.wdtFeed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 自动连接20s 超过之后自动进入SmartConfig模式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">autoConfig</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_AP_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">  WiFi.begin();</span><br><span class="line">  delay(<span class="number">2000</span>);                <span class="comment">//刚启动模块的话 延时稳定一下</span></span><br><span class="line">  Serial.println(<span class="string">&quot;AutoConfiging ......&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> index=<span class="number">0</span>;index&lt;<span class="number">20</span>;index++)&#123;</span><br><span class="line">    <span class="type">int</span> wstatus = WiFi.status();</span><br><span class="line">    <span class="keyword">if</span> (wstatus == WL_CONNECTED)&#123;</span><br><span class="line">      Serial.println(<span class="string">&quot;AutoConfig Success&quot;</span>);</span><br><span class="line">      Serial.print(<span class="string">&quot;SSID:&quot;</span>);</span><br><span class="line">      Serial.println(WiFi.SSID().c_str());</span><br><span class="line">      Serial.print(<span class="string">&quot;PSW:&quot;</span>);</span><br><span class="line">      Serial.println(WiFi.psk().c_str());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">      delay(<span class="number">1000</span>);</span><br><span class="line">      flag = !flag;</span><br><span class="line">      digitalWrite(LED, flag);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  Serial.println(<span class="string">&quot;AutoConfig Faild!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 开启SmartConfig功能</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smartConfig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  delay(<span class="number">2000</span>);</span><br><span class="line">  Serial.println(<span class="string">&quot;Wait for Smartconfig&quot;</span>);<span class="comment">// 等待配网</span></span><br><span class="line">  WiFi.beginSmartConfig();</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">    Serial.print(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    delay(<span class="number">500</span>);</span><br><span class="line">    flag = !flag;</span><br><span class="line">    digitalWrite(LED, flag);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (WiFi.smartConfigDone())&#123;</span><br><span class="line">      <span class="comment">//smartconfig配置完毕</span></span><br><span class="line">      Serial.println(<span class="string">&quot;SmartConfig Success&quot;</span>);</span><br><span class="line">      Serial.print(<span class="string">&quot;SSID:&quot;</span>);</span><br><span class="line">      Serial.println(WiFi.SSID().c_str());</span><br><span class="line">      Serial.print(<span class="string">&quot;PSW:&quot;</span>);</span><br><span class="line">      Serial.println(WiFi.psk().c_str());</span><br><span class="line">      WiFi.mode(WIFI_AP_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">      WiFi.setAutoConnect(<span class="literal">true</span>);  <span class="comment">// 设置自动连接</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Arduino端代码：（接收8266信息，JSON解析）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 功能：wifi lamp arduino端</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SoftwareSerial.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line">  </span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;                   <span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> MAX_CONTENT_SIZE = <span class="number">50</span>; </span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> t_bright=<span class="number">1</span>,t_color=<span class="number">2</span>,t_frequency=<span class="number">3</span>,t_switch=<span class="number">4</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//#define UNO      //uncomment this line when you use it with UNO board</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MEGA    <span class="comment">//uncomment this line when you use it with MEGA board</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNO</span></span><br><span class="line"> SoftwareSerial <span class="title function_">mySerial</span><span class="params">(<span class="number">10</span>,<span class="number">11</span>)</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNO</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WifiSerial  Serial</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MyDebugSerial mySerial</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> MEGA</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WifiSerial Serial1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MyDebugSerial Serial</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>  </span></span><br><span class="line"> </span><br><span class="line"><span class="comment">//该条语句用于使能DEBUG输出信息，屏蔽掉就不会输出debug调试信息</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG</span></span><br><span class="line"><span class="comment">//该条语句用于使能是共阴RGB  屏蔽掉就是共阳RGB</span></span><br><span class="line"><span class="comment">//#define COMMON_GND</span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBGLN(message)    MyDebugSerial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DBGLN(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"> </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> UNO </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_RED 3 <span class="comment">//red 引脚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_GREEN 5 <span class="comment">//green 引脚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_BLUE 6 <span class="comment">//blue 引脚</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_ENABLE 9  <span class="comment">//使能引脚 pwm控制亮度</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_KEY 7<span class="comment">// 按键</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_RED 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_GREEN 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_BLUE 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_ENABLE 5</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PIN_KEY 6  </span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> </span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> red = <span class="number">0</span>,green = <span class="number">0</span>,blue = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> type = <span class="number">4</span>;<span class="comment">//当前模式 1亮度 2颜色 3呼吸 4开关</span></span><br><span class="line"><span class="type">int</span> frequency = <span class="number">1</span>;<span class="comment">//频率</span></span><br><span class="line"><span class="type">int</span> switch_status = <span class="number">1</span>;<span class="comment">//关闭 or 开启</span></span><br><span class="line"><span class="type">int</span> bright = <span class="number">1</span>;<span class="comment">//亮度</span></span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> response[MAX_CONTENT_SIZE];</span><br><span class="line"><span class="type">int</span> fadeValue = <span class="number">0</span>;<span class="comment">//当前亮度</span></span><br><span class="line"><span class="type">bool</span> isAdd = <span class="literal">true</span>;<span class="comment">//是否是从暗到亮</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// 定义记录按键当前状态的变量</span></span><br><span class="line"><span class="type">int</span> state_btn;</span><br><span class="line"><span class="comment">// 定义记录按键最近一次状态变化的变量，并初始化状态为LOW。</span></span><br><span class="line"><span class="type">int</span> lastButtonState = LOW;</span><br><span class="line"><span class="comment">// 定义记录最近一次抖动的时间变量，并初始化时间为0毫秒。</span></span><br><span class="line"><span class="type">long</span> lastDebounceTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 定义延迟抖动的时间变量</span></span><br><span class="line"><span class="type">long</span> debouncdDelay = <span class="number">60</span>;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 初始化操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  pinMode(PIN_RED, OUTPUT);</span><br><span class="line">  pinMode(PIN_GREEN, OUTPUT);</span><br><span class="line">  pinMode(PIN_BLUE, OUTPUT);</span><br><span class="line">  pinMode(PIN_ENABLE, OUTPUT);</span><br><span class="line">  pinMode(PIN_KEY,INPUT);</span><br><span class="line">  </span><br><span class="line">  WifiSerial.begin(BAUD_RATE);</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> UNO</span></span><br><span class="line">      MyDebugSerial.begin(<span class="number">9600</span>);<span class="comment">//软串口9600稳定</span></span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">      MyDebugSerial.begin(BAUD_RATE);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  DBGLN(<span class="string">&quot;Arduino Init End&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc  主函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(WifiSerial.available()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">    clrEsp8266ResponseBuffer();</span><br><span class="line">    <span class="type">int</span> data_size = ReceiveMessage(response, <span class="keyword">sizeof</span>(response));</span><br><span class="line">    <span class="keyword">if</span>(data_size&gt;<span class="number">0</span>)&#123;</span><br><span class="line">      <span class="comment">//开始解析数据</span></span><br><span class="line">      parseData(response);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="keyword">if</span>(type == t_frequency)&#123;</span><br><span class="line">    <span class="comment">//呼吸灯效果</span></span><br><span class="line">    breatheRGB(frequency);</span><br><span class="line">  &#125;</span><br><span class="line">  checkButton();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 读取串口缓冲区里面的数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">ReceiveMessage</span><span class="params">(<span class="type">char</span>* content, <span class="type">size_t</span> maxSize)</span>&#123;</span><br><span class="line">  <span class="comment">//不用 readBytes 因为比较耗时</span></span><br><span class="line">  <span class="type">size_t</span> length = WifiSerial.readBytesUntil(<span class="string">&#x27;&#125;&#x27;</span>,content, maxSize);</span><br><span class="line">  content[length] = <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">  content[++length] = <span class="number">0</span>;</span><br><span class="line">  DBGLN(content);</span><br><span class="line">  <span class="keyword">return</span> length;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * @Desc 解析json</span></span><br><span class="line"><span class="comment">     * 有三种</span></span><br><span class="line"><span class="comment">     * 1.亮度控制页面(0 暗 1正常 2亮)</span></span><br><span class="line"><span class="comment">     * &#123;</span></span><br><span class="line"><span class="comment">     *     &quot;t&quot;: 1,</span></span><br><span class="line"><span class="comment">     *     &quot;bb&quot;: 2</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     * 2.颜色控制页面</span></span><br><span class="line"><span class="comment">     * &#123;</span></span><br><span class="line"><span class="comment">     *     &quot;t&quot;: 2,</span></span><br><span class="line"><span class="comment">     *     &quot;cr&quot;: 154,</span></span><br><span class="line"><span class="comment">     *     &quot;cg&quot;: 147,</span></span><br><span class="line"><span class="comment">     *     &quot;cb&quot;: 255</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     * 3.呼吸灯控制页面(0 慢呼吸 1正常 2快)</span></span><br><span class="line"><span class="comment">     * &#123;</span></span><br><span class="line"><span class="comment">     *    &quot;t&quot;: 3,</span></span><br><span class="line"><span class="comment">     *    &quot;gf&quot;: 1</span></span><br><span class="line"><span class="comment">     * &#125;</span></span><br><span class="line"><span class="comment">     * 4.开关控制(0关闭 1开启)</span></span><br><span class="line"><span class="comment">     * &#123;</span></span><br><span class="line"><span class="comment">     *    &quot;t&quot;: 4,</span></span><br><span class="line"><span class="comment">     *    &quot;ss&quot;: 1</span></span><br><span class="line"><span class="comment">     * &#125; </span></span><br><span class="line"><span class="comment">     **/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parseData</span><span class="params">(<span class="type">char</span>* content)</span> &#123;</span><br><span class="line"><span class="comment">//    -- 根据我们需要解析的数据来计算JSON缓冲区最佳大小</span></span><br><span class="line"><span class="comment">//   如果你使用StaticJsonBuffer时才需要</span></span><br><span class="line"><span class="comment">//    const size_t BUFFER_SIZE = 1024;</span></span><br><span class="line"><span class="comment">//   在堆栈上分配一个临时内存池</span></span><br><span class="line"><span class="comment">//    StaticJsonBuffer&lt;BUFFER_SIZE&gt; jsonBuffer;</span></span><br><span class="line"><span class="comment">//    -- 如果堆栈的内存池太大，使用 DynamicJsonBuffer jsonBuffer 代替</span></span><br><span class="line">  DynamicJsonBuffer jsonBuffer;</span><br><span class="line">   </span><br><span class="line">  JsonObject&amp; root = jsonBuffer.parseObject(content);</span><br><span class="line">   </span><br><span class="line">  <span class="keyword">if</span> (!root.success()) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;JSON parsing failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  type = root[<span class="string">&quot;t&quot;</span>];</span><br><span class="line">  <span class="keyword">switch</span>(type)&#123;</span><br><span class="line">    <span class="keyword">case</span> t_bright:</span><br><span class="line">         bright = root[<span class="string">&quot;bb&quot;</span>];</span><br><span class="line">         brightRGB(bright);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> t_color:</span><br><span class="line">         red = root[<span class="string">&quot;cr&quot;</span>];</span><br><span class="line">         green = root[<span class="string">&quot;cg&quot;</span>];</span><br><span class="line">         blue = root[<span class="string">&quot;cb&quot;</span>];</span><br><span class="line">         colorRGB(red,green,blue);</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> t_frequency:</span><br><span class="line">         frequency = root[<span class="string">&quot;gf&quot;</span>];</span><br><span class="line">         <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> t_switch:</span><br><span class="line">         switch_status = root[<span class="string">&quot;ss&quot;</span>];</span><br><span class="line">         <span class="type">bool</span> enable = switch_status == <span class="number">1</span>;</span><br><span class="line">         switchRGB(enable);</span><br><span class="line">         <span class="keyword">break</span>;     </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 控制灯亮度</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">brightRGB</span><span class="params">(<span class="type">int</span> bright)</span>&#123;</span><br><span class="line">  <span class="type">int</span> level = bright%<span class="number">3</span>;</span><br><span class="line">  <span class="type">int</span> bright_level;</span><br><span class="line">  <span class="keyword">switch</span>(level)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//暗  50</span></span><br><span class="line">      bright_level = <span class="number">50</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//正常 100</span></span><br><span class="line">      bright_level = <span class="number">100</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">//亮  200</span></span><br><span class="line">      bright_level = <span class="number">200</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> COMMON_GND</span></span><br><span class="line">     <span class="comment">//共地</span></span><br><span class="line">     analogWrite(PIN_ENABLE,bright_level);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">     analogWrite(PIN_ENABLE,<span class="number">255</span>-bright_level);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 控制RGB颜色</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">colorRGB</span><span class="params">(<span class="type">int</span> red, <span class="type">int</span> green, <span class="type">int</span> blue)</span>&#123;</span><br><span class="line">  <span class="meta">#<span class="keyword">ifdef</span> COMMON_GND</span></span><br><span class="line">     analogWrite(PIN_RED,constrain(red,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">     analogWrite(PIN_GREEN,constrain(green,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">     analogWrite(PIN_BLUE,constrain(blue,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">  <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">     analogWrite(PIN_RED,constrain(<span class="number">255</span>-red,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">     analogWrite(PIN_GREEN,constrain(<span class="number">255</span>-green,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">     analogWrite(PIN_BLUE,constrain(<span class="number">255</span>-blue,<span class="number">0</span>,<span class="number">255</span>));</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 控制亮灭</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">switchRGB</span><span class="params">(<span class="type">bool</span> enable)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(enable)&#123;</span><br><span class="line">    <span class="comment">//打开</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> COMMON_GND</span></span><br><span class="line">     <span class="comment">//共地</span></span><br><span class="line">     analogWrite(PIN_ENABLE,<span class="number">255</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">     analogWrite(PIN_ENABLE,<span class="number">0</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//关闭</span></span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> COMMON_GND</span></span><br><span class="line">     <span class="comment">//共地</span></span><br><span class="line">     analogWrite(PIN_ENABLE,<span class="number">0</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">     analogWrite(PIN_ENABLE,<span class="number">255</span>);</span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 呼吸灯</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">breatheRGB</span><span class="params">(<span class="type">int</span> frequency)</span>&#123;</span><br><span class="line">  <span class="type">int</span> level = frequency%<span class="number">3</span>;</span><br><span class="line">  <span class="type">int</span> f_level;</span><br><span class="line">  <span class="keyword">switch</span>(level)&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//慢  50</span></span><br><span class="line">      f_level = <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//正常 100</span></span><br><span class="line">      f_level = <span class="number">10</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">//快  200</span></span><br><span class="line">      f_level = <span class="number">20</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(isAdd)&#123;</span><br><span class="line">    <span class="comment">//递增方向</span></span><br><span class="line">     fadeValue +=f_level;</span><br><span class="line">     <span class="keyword">if</span>(fadeValue&gt;=<span class="number">255</span>)&#123;</span><br><span class="line">       fadeValue = <span class="number">255</span>;</span><br><span class="line">       isAdd =<span class="literal">false</span>;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="comment">//递减方向</span></span><br><span class="line">    fadeValue -=f_level;</span><br><span class="line">     <span class="keyword">if</span>(fadeValue&lt;=<span class="number">0</span>)&#123;</span><br><span class="line">       fadeValue = <span class="number">0</span>;</span><br><span class="line">       isAdd =<span class="literal">true</span>;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  analogWrite(PIN_ENABLE,fadeValue);</span><br><span class="line">  delay(<span class="number">20</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 检查按键功能</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">checkButton</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">int</span> buttonState = digitalRead(PIN_KEY);<span class="comment">//读取当前按键状态</span></span><br><span class="line">  <span class="keyword">if</span>(buttonState != lastButtonState)&#123;</span><br><span class="line">     <span class="comment">//如果按键发生了变化  则重新设置最近一次抖动的时间</span></span><br><span class="line">     <span class="comment">//方法millis()可以获取当前时间，单位统一为毫秒。</span></span><br><span class="line">     lastDebounceTime = millis();  </span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">// 判断按键按下状态时间间隔是否大于延迟抖动的时间长度。</span></span><br><span class="line">  <span class="keyword">if</span>(millis()-lastDebounceTime&gt;debouncdDelay)&#123;</span><br><span class="line">    <span class="comment">// 判断当前的按键状态是否和之前有所变化</span></span><br><span class="line">    <span class="keyword">if</span>(buttonState != state_btn)&#123;</span><br><span class="line">       <span class="comment">// 如果发生了变化，</span></span><br><span class="line">       <span class="comment">// 则更新按键状态变量。</span></span><br><span class="line">       state_btn = buttonState;</span><br><span class="line">       <span class="keyword">if</span>(state_btn == HIGH)&#123;</span><br><span class="line">        <span class="comment">//再次确认是否真的按下了按键</span></span><br><span class="line">         DBGLN(<span class="string">&quot;smartconfig&quot;</span>);</span><br><span class="line">         WifiSerial.write(<span class="string">&#x27;1&#x27;</span>);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 更新按键最近一次状态变化的变量</span></span><br><span class="line">  lastButtonState = buttonState;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">clrEsp8266ResponseBuffer</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(response, <span class="number">0</span>, MAX_CONTENT_SIZE);      <span class="comment">//清空</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2、OLED显示天气屏"><a href="#2、OLED显示天气屏" class="headerlink" title="2、OLED显示天气屏"></a>2、OLED显示天气屏</h2><p>相关技术点：</p>
<ul>
<li>ArduinoJson V5库</li>
<li>TCP Client</li>
<li>STA模式</li>
<li>一键配网</li>
<li>U8G2 OLED库</li>
</ul>
<p>内容：</p>
<p>向心知天气请求当地城市天气情况，并在OLED上显示天气图标、温度值以及城市名称</p>
<p>心知天气参考<a target="_blank" rel="noopener" href="https://docs.seniverse.com/api/weather/now.html">wiki</a></p>
<p>天气编码<a target="_blank" rel="noopener" href="https://docs.seniverse.com/api/start/code.html">wiki</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 功能：OLED显示天气屏</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Arduino.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;U8g2lib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> U8X8_HAVE_HW_SPI</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;SPI.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> U8X8_HAVE_HW_I2C</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Wire.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LED D4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEBUG <span class="comment">//是否开启debug功能</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)    Serial.println(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrintln(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> DEBUG</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)    Serial.print(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DebugPrint(message)</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_DAY_SUN <span class="string">&quot;0&quot;</span> <span class="comment">//晴（国内城市白天晴）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_NIGHT_SUN <span class="string">&quot;1&quot;</span> <span class="comment">//晴（国内城市夜晚晴）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_DAY_SUN1 <span class="string">&quot;2&quot;</span> <span class="comment">//晴（国外城市白天晴）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_NIGHT_SUN2 <span class="string">&quot;3&quot;</span> <span class="comment">//晴（国外城市夜晚晴）</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_CLOUDY <span class="string">&quot;4&quot;</span> <span class="comment">//多云</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_DAY_PARTLY_CLOUDY <span class="string">&quot;5&quot;</span> <span class="comment">//白天晴间多云</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_NIGHT_PARTLY_CLOUDY <span class="string">&quot;6&quot;</span> <span class="comment">//夜晚晴间多云</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_DAY_MOSTLY_CLOUDY <span class="string">&quot;7&quot;</span> <span class="comment">//白天大部多云</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_NIGHT_MOSTLY_CLOUDY <span class="string">&quot;8&quot;</span> <span class="comment">//夜晚大部多云</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_OVERCAST <span class="string">&quot;9&quot;</span> <span class="comment">//阴</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_SHOWER <span class="string">&quot;10&quot;</span> <span class="comment">//阵雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_THUNDERSHOWER <span class="string">&quot;11&quot;</span> <span class="comment">//雷阵雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_THUNDERSHOWER_WITH_HAIL <span class="string">&quot;12&quot;</span> <span class="comment">//雷阵雨伴有冰雹</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_LIGHT_RAIN <span class="string">&quot;13&quot;</span> <span class="comment">//小雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_MODERATE_RAIN <span class="string">&quot;14&quot;</span> <span class="comment">//中雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_HEAVY_RAIN <span class="string">&quot;15&quot;</span> <span class="comment">//大雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_STORM <span class="string">&quot;16&quot;</span> <span class="comment">//暴雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_HEAVY_STORM <span class="string">&quot;17&quot;</span> <span class="comment">//大暴雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_SEVERE_STORM <span class="string">&quot;18&quot;</span> <span class="comment">//特大暴雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_ICE_RAIN <span class="string">&quot;19&quot;</span> <span class="comment">//冻雨</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_SLEET <span class="string">&quot;20&quot;</span> <span class="comment">//雨夹雪</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_SNOW_FLURRY <span class="string">&quot;21&quot;</span> <span class="comment">//阵雪</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_LIGHT_SNOW <span class="string">&quot;22&quot;</span> <span class="comment">//小雪</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_MODERATE_SNOW <span class="string">&quot;23&quot;</span> <span class="comment">//中雪</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_HEAVY_SNOW <span class="string">&quot;24&quot;</span> <span class="comment">//大雪</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEATHER_CODE_SNOW_STORM <span class="string">&quot;25&quot;</span> <span class="comment">//暴雪</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUN_DAY 0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUN_NIGHT 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SUN_CLOUD 2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CLOUD 3</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RAIN 4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> THUNDER 5</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//声明方法</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">autoConfig</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">smartConfig</span><span class="params">()</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">sendRequest</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host, <span class="type">const</span> <span class="type">char</span>* cityid, <span class="type">const</span> <span class="type">char</span>* apiKey)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">skipResponseHeaders</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">readReponseContent</span><span class="params">(<span class="type">char</span>* content, <span class="type">size_t</span> maxSize)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stopConnect</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">clrEsp8266ResponseBuffer</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"><span class="type">bool</span> <span class="title function_">parseUserData</span><span class="params">(<span class="type">char</span>* content, <span class="keyword">struct</span> UserData* userData)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">drawWeatherSymbol</span><span class="params">(<span class="type">u8g2_uint_t</span> x, <span class="type">u8g2_uint_t</span> y, <span class="type">uint8_t</span> symbol)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">drawWeather</span><span class="params">(<span class="type">uint8_t</span> symbol, <span class="type">int</span> degree)</span>;</span><br><span class="line">  </span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> BAUD_RATE = <span class="number">115200</span>;<span class="comment">// serial connection speed</span></span><br><span class="line"><span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> HTTP_TIMEOUT = <span class="number">5000</span>;               <span class="comment">// max respone time from server</span></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> MAX_CONTENT_SIZE = <span class="number">500</span>;                   <span class="comment">// max size of the HTTP response</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* host = <span class="string">&quot;api.seniverse.com&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* APIKEY = <span class="string">&quot;wcmquevztdy1jpca&quot;</span>;        <span class="comment">//API KEY</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* city = <span class="string">&quot;guangzhou&quot;</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* language = <span class="string">&quot;zh-Hans&quot;</span>;<span class="comment">//zh-Hans 简体中文  会显示乱码</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> flag = HIGH;<span class="comment">//默认当前灭灯</span></span><br><span class="line">U8G2_SSD1306_128X64_NONAME_F_HW_I2C <span class="title function_">u8g2</span><span class="params">(U8G2_R0, <span class="comment">/* reset=*/</span> U8X8_PIN_NONE)</span>;</span><br><span class="line"></span><br><span class="line">WiFiClient client;</span><br><span class="line"><span class="type">char</span> response[MAX_CONTENT_SIZE];</span><br><span class="line"><span class="type">char</span> endOfHeaders[] = <span class="string">&quot;\r\n\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">long</span> lastTime = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// 请求服务间隔</span></span><br><span class="line"><span class="type">long</span> Delay = <span class="number">20000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们要从此网页中提取的数据的类型</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">UserData</span> &#123;</span></span><br><span class="line">  <span class="type">char</span> city[<span class="number">16</span>];<span class="comment">//城市名称</span></span><br><span class="line">  <span class="type">char</span> weather_code[<span class="number">4</span>];<span class="comment">//天气现象code（多云...）</span></span><br><span class="line">  <span class="type">char</span> temp[<span class="number">5</span>];<span class="comment">//温度</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 初始化操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  Serial.begin(BAUD_RATE);</span><br><span class="line">  pinMode(LED,OUTPUT);</span><br><span class="line">  digitalWrite(LED, HIGH);</span><br><span class="line"></span><br><span class="line">  WiFi.disconnect();</span><br><span class="line">  <span class="keyword">if</span>(!autoConfig())&#123;</span><br><span class="line">    smartConfig();</span><br><span class="line">    DebugPrint(<span class="string">&quot;Connecting to WiFi&quot;</span>);<span class="comment">//写几句提示，哈哈</span></span><br><span class="line">    <span class="keyword">while</span> (WiFi.status() != WL_CONNECTED) &#123;</span><br><span class="line">    <span class="comment">//这个函数是wifi连接状态，返回wifi链接状态</span></span><br><span class="line">       delay(<span class="number">500</span>);</span><br><span class="line">       DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  digitalWrite(LED, LOW);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;IP address: &quot;</span>);</span><br><span class="line">  DebugPrintln(WiFi.localIP());<span class="comment">//WiFi.localIP()返回8266获得的ip地址</span></span><br><span class="line">  lastTime = millis();</span><br><span class="line">  u8g2.begin();  </span><br><span class="line">  u8g2.enableUTF8Print();</span><br><span class="line">  <span class="comment">//使能软件看门狗的触发间隔</span></span><br><span class="line">  ESP.wdtEnable(<span class="number">5000</span>);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc  主函数</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">while</span> (!client.connected())&#123;</span><br><span class="line">     <span class="keyword">if</span> (!client.connect(host, <span class="number">80</span>))&#123;</span><br><span class="line">         flag = !flag;</span><br><span class="line">         digitalWrite(LED, flag);</span><br><span class="line">         delay(<span class="number">500</span>);</span><br><span class="line">         <span class="comment">//喂狗</span></span><br><span class="line">         ESP.wdtFeed();</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(millis()-lastTime&gt;=Delay)&#123;</span><br><span class="line">   <span class="comment">//每间隔20s左右调用一次</span></span><br><span class="line">     lastTime = millis();</span><br><span class="line">     <span class="keyword">if</span> (sendRequest(host, city, APIKEY) &amp;&amp; skipResponseHeaders()) &#123;</span><br><span class="line">       clrEsp8266ResponseBuffer();</span><br><span class="line">       readReponseContent(response, <span class="keyword">sizeof</span>(response));</span><br><span class="line">       UserData userData;</span><br><span class="line">       <span class="keyword">if</span> (parseUserData(response, &amp;userData)) &#123;</span><br><span class="line">          showWeather(&amp;userData);</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="comment">//喂狗</span></span><br><span class="line">   ESP.wdtFeed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 自动连接20s 超过之后自动进入SmartConfig模式</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">autoConfig</span><span class="params">()</span>&#123;</span><br><span class="line">  WiFi.mode(WIFI_AP_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">  WiFi.begin();</span><br><span class="line">  delay(<span class="number">2000</span>);<span class="comment">//刚启动模块的话 延时稳定一下</span></span><br><span class="line">  DebugPrintln(<span class="string">&quot;AutoConfiging ......&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span>(<span class="type">int</span> index=<span class="number">0</span>;index&lt;<span class="number">10</span>;index++)&#123;</span><br><span class="line">    <span class="type">int</span> wstatus = WiFi.status();</span><br><span class="line">    <span class="keyword">if</span> (wstatus == WL_CONNECTED)&#123;</span><br><span class="line">      DebugPrintln(<span class="string">&quot;AutoConfig Success&quot;</span>);</span><br><span class="line">      DebugPrint(<span class="string">&quot;SSID:&quot;</span>);</span><br><span class="line">      DebugPrintln(WiFi.SSID().c_str());</span><br><span class="line">      DebugPrint(<span class="string">&quot;PSW:&quot;</span>);</span><br><span class="line">      DebugPrintln(WiFi.psk().c_str());</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">      delay(<span class="number">500</span>);</span><br><span class="line">      flag = !flag;</span><br><span class="line">      digitalWrite(LED, flag);</span><br><span class="line">    &#125; </span><br><span class="line">  &#125;</span><br><span class="line">  DebugPrintln(<span class="string">&quot;AutoConfig Faild!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 开启SmartConfig功能</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">smartConfig</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  WiFi.mode(WIFI_STA);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Wait for Smartconfig&quot;</span>);</span><br><span class="line">  <span class="comment">// 等待配网</span></span><br><span class="line">  WiFi.beginSmartConfig();</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>)&#123;</span><br><span class="line">    DebugPrint(<span class="string">&quot;.&quot;</span>);</span><br><span class="line">    delay(<span class="number">200</span>);</span><br><span class="line">    flag = !flag;</span><br><span class="line">    digitalWrite(LED, flag);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (WiFi.smartConfigDone())&#123;</span><br><span class="line">      <span class="comment">//smartconfig配置完毕</span></span><br><span class="line">      DebugPrintln(<span class="string">&quot;SmartConfig Success&quot;</span>);</span><br><span class="line">      DebugPrint(<span class="string">&quot;SSID:&quot;</span>);</span><br><span class="line">      DebugPrintln(WiFi.SSID().c_str());</span><br><span class="line">      DebugPrint(<span class="string">&quot;PSW:&quot;</span>);</span><br><span class="line">      DebugPrintln(WiFi.psk().c_str());</span><br><span class="line">      WiFi.mode(WIFI_AP_STA);     <span class="comment">//设置esp8266 工作模式</span></span><br><span class="line">      WiFi.setAutoConnect(<span class="literal">true</span>);  <span class="comment">// 设置自动连接</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @发送请求指令</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">sendRequest</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* host, <span class="type">const</span> <span class="type">char</span>* cityid, <span class="type">const</span> <span class="type">char</span>* apiKey)</span> &#123;</span><br><span class="line">  <span class="comment">// We now create a URI for the request</span></span><br><span class="line">  <span class="comment">//心知天气</span></span><br><span class="line">  String GetUrl = <span class="string">&quot;/v3/weather/now.json?key=&quot;</span>;</span><br><span class="line">  GetUrl += apiKey;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;location=&quot;</span>;</span><br><span class="line">  GetUrl += city;</span><br><span class="line">  GetUrl += <span class="string">&quot;&amp;language=&quot;</span>;</span><br><span class="line">  GetUrl += language;</span><br><span class="line">  <span class="comment">// This will send the request to the server</span></span><br><span class="line">  client.print(String(<span class="string">&quot;GET &quot;</span>) + GetUrl + <span class="string">&quot; HTTP/1.1\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Host: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Connection: close\r\n\r\n&quot;</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;create a request:&quot;</span>);</span><br><span class="line">  DebugPrintln(String(<span class="string">&quot;GET &quot;</span>) + GetUrl + <span class="string">&quot; HTTP/1.1\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Host: &quot;</span> + host + <span class="string">&quot;\r\n&quot;</span> +</span><br><span class="line">               <span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">  delay(<span class="number">1000</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 跳过 HTTP 头，使我们在响应正文的开头</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">bool</span> <span class="title function_">skipResponseHeaders</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// HTTP headers end with an empty line</span></span><br><span class="line">  <span class="type">bool</span> ok = client.find(endOfHeaders);</span><br><span class="line">  <span class="keyword">if</span> (!ok) &#123;</span><br><span class="line">    DebugPrintln(<span class="string">&quot;No response or invalid response!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ok;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* @Desc 从HTTP服务器响应中读取正文</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">readReponseContent</span><span class="params">(<span class="type">char</span>* content, <span class="type">size_t</span> maxSize)</span> &#123;</span><br><span class="line">  <span class="type">size_t</span> length = client.readBytes(content, maxSize);</span><br><span class="line">  delay(<span class="number">100</span>);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Get the data from Internet!&quot;</span>);</span><br><span class="line">  content[length] = <span class="number">0</span>;</span><br><span class="line">  DebugPrintln(content);</span><br><span class="line">  DebugPrintln(<span class="string">&quot;Read data Over!&quot;</span>);</span><br><span class="line">  client.flush();<span class="comment">//这句代码需要加上  不然会发现每隔一次client.find会失败</span></span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">// 关闭与HTTP服务器连接</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">stopConnect</span><span class="params">()</span> &#123;</span><br><span class="line">  client.stop();</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">void</span> <span class="title function_">clrEsp8266ResponseBuffer</span><span class="params">(<span class="type">void</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">memset</span>(response, <span class="number">0</span>, MAX_CONTENT_SIZE);      <span class="comment">//清空</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">parseUserData</span><span class="params">(<span class="type">char</span>* content, <span class="keyword">struct</span> UserData* userData)</span> &#123;</span><br><span class="line"><span class="comment">//    -- 根据我们需要解析的数据来计算JSON缓冲区最佳大小</span></span><br><span class="line"><span class="comment">//   如果你使用StaticJsonBuffer时才需要</span></span><br><span class="line"><span class="comment">//    const size_t BUFFER_SIZE = 1024;</span></span><br><span class="line"><span class="comment">//   在堆栈上分配一个临时内存池</span></span><br><span class="line"><span class="comment">//    StaticJsonBuffer&lt;BUFFER_SIZE&gt; jsonBuffer;</span></span><br><span class="line"><span class="comment">//    -- 如果堆栈的内存池太大，使用 DynamicJsonBuffer jsonBuffer 代替</span></span><br><span class="line">  DynamicJsonBuffer jsonBuffer;</span><br><span class="line">  </span><br><span class="line">  JsonObject&amp; root = jsonBuffer.parseObject(content);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!root.success()) &#123;</span><br><span class="line">    Serial.println(<span class="string">&quot;JSON parsing failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="comment">//复制我们感兴趣的字符串</span></span><br><span class="line">  <span class="built_in">strcpy</span>(userData-&gt;city, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;location&quot;</span>][<span class="string">&quot;name&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(userData-&gt;weather_code, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;code&quot;</span>]);</span><br><span class="line">  <span class="built_in">strcpy</span>(userData-&gt;temp, root[<span class="string">&quot;results&quot;</span>][<span class="number">0</span>][<span class="string">&quot;now&quot;</span>][<span class="string">&quot;temperature&quot;</span>]);</span><br><span class="line">  <span class="comment">//  -- 这不是强制复制，你可以使用指针，因为他们是指向“内容”缓冲区内，所以你需要确保</span></span><br><span class="line">  <span class="comment">//   当你读取字符串时它仍在内存中</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据天气接口返回的数据判断显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">showWeather</span><span class="params">(<span class="keyword">struct</span> UserData* userData)</span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_DAY_SUN) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_DAY_SUN1) == <span class="number">0</span>)&#123;</span><br><span class="line">    drawWeather(SUN_DAY,userData-&gt;temp,userData-&gt;city);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_NIGHT_SUN) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_NIGHT_SUN2) == <span class="number">0</span> )&#123;</span><br><span class="line">    drawWeather(SUN_NIGHT,userData-&gt;temp,userData-&gt;city);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_DAY_PARTLY_CLOUDY) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_NIGHT_PARTLY_CLOUDY) == <span class="number">0</span> )&#123;</span><br><span class="line">    drawWeather(SUN_CLOUD,userData-&gt;temp,userData-&gt;city);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_CLOUDY) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_DAY_MOSTLY_CLOUDY) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_NIGHT_MOSTLY_CLOUDY) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_OVERCAST) == <span class="number">0</span>)&#123;</span><br><span class="line">    drawWeather(CLOUD,userData-&gt;temp,userData-&gt;city); </span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_SHOWER) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_LIGHT_RAIN) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_MODERATE_RAIN) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_HEAVY_RAIN) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_STORM) == <span class="number">0</span></span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_HEAVY_STORM) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_SEVERE_STORM) == <span class="number">0</span>)&#123;</span><br><span class="line">    drawWeather(RAIN,userData-&gt;temp,userData-&gt;city);</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_THUNDERSHOWER) == <span class="number">0</span> </span><br><span class="line">  || <span class="built_in">strcmp</span>(userData-&gt;weather_code,WEATHER_CODE_THUNDERSHOWER_WITH_HAIL) == <span class="number">0</span>)&#123;</span><br><span class="line">    drawWeather(THUNDER,userData-&gt;temp,userData-&gt;city);</span><br><span class="line">  &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    drawWeather(CLOUD,userData-&gt;temp,userData-&gt;city); </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">drawWeather</span><span class="params">(<span class="type">uint8_t</span> symbol, <span class="type">char</span>* degree,<span class="type">char</span>* city)</span></span><br><span class="line">&#123;</span><br><span class="line">  DebugPrintln(city);</span><br><span class="line">  u8g2.clearBuffer();         <span class="comment">// clear the internal memory</span></span><br><span class="line">  <span class="comment">//绘制天气符号</span></span><br><span class="line">  drawWeatherSymbol(<span class="number">0</span>, <span class="number">48</span>, symbol);</span><br><span class="line">  <span class="comment">//绘制温度</span></span><br><span class="line">  u8g2.setFont(u8g2_font_logisoso32_tf);</span><br><span class="line">  u8g2.setCursor(<span class="number">48</span>+<span class="number">3</span>, <span class="number">42</span>);</span><br><span class="line">  u8g2.print(degree);</span><br><span class="line">  u8g2.print(<span class="string">&quot;°C&quot;</span>);   <span class="comment">// requires enableUTF8Print()</span></span><br><span class="line">  u8g2.setFont(u8g2_font_unifont_t_chinese3);</span><br><span class="line"></span><br><span class="line">  <span class="type">u8g2_uint_t</span> strWidth = u8g2.getUTF8Width(city);</span><br><span class="line">  <span class="type">u8g2_uint_t</span> displayWidth = u8g2.getDisplayWidth();</span><br><span class="line">  </span><br><span class="line">  u8g2.setCursor(displayWidth - strWidth - <span class="number">5</span>, <span class="number">60</span>);</span><br><span class="line">  u8g2.print(city);</span><br><span class="line">  u8g2.sendBuffer();        <span class="comment">// transfer internal memory to the display</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 绘制天气符号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">drawWeatherSymbol</span><span class="params">(<span class="type">u8g2_uint_t</span> x, <span class="type">u8g2_uint_t</span> y, <span class="type">uint8_t</span> symbol)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// fonts used:</span></span><br><span class="line">  <span class="comment">// u8g2_font_open_iconic_embedded_6x_t</span></span><br><span class="line">  <span class="comment">// u8g2_font_open_iconic_weather_6x_t</span></span><br><span class="line">  <span class="comment">// encoding values, see: https://github.com/olikraus/u8g2/wiki/fntgrpiconic</span></span><br><span class="line">  <span class="keyword">switch</span>(symbol)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> SUN_DAY:<span class="comment">//太阳</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_weather_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">69</span>); </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SUN_NIGHT:<span class="comment">//太阳</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_weather_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">66</span>); </span><br><span class="line">      <span class="keyword">break</span>;  </span><br><span class="line">    <span class="keyword">case</span> SUN_CLOUD:<span class="comment">//晴间多云</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_weather_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">65</span>); </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CLOUD:<span class="comment">//多云</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_weather_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">64</span>); </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RAIN:<span class="comment">//下雨</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_weather_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">67</span>); </span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> THUNDER:<span class="comment">//打雷</span></span><br><span class="line">      u8g2.setFont(<span class="type">u8g2_font_open_iconic_embedded_6x_t</span>);</span><br><span class="line">      u8g2.drawGlyph(x, y, <span class="number">67</span>);</span><br><span class="line">      <span class="keyword">break</span>;      </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3、WIFI小车"><a href="#3、WIFI小车" class="headerlink" title="3、WIFI小车"></a>3、WIFI小车</h2><p>相关技术点：</p>
<p>WebSocket Client 全双工通信</p>
<p>WebSocket Server 全双工通信</p>
<p>内容：</p>
<ul>
<li>NodeMcu作为AP。手机控制端作为STA，连接AP</li>
<li>NodeMcu作为WebSocketServer端，手机作为WebSocketClient端</li>
<li>两者建立WS通信，手机往NodeMcu发送控制命令</li>
<li>NodeMcu控制电机</li>
</ul>
<p>实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> *功能：wifi小车 ESP8266</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WiFi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;WebSocketsServer.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ESP8266WebServer.h&gt;</span> </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ArduinoJson.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_SSID <span class="string">&quot;WiFiCar&quot;</span> <span class="comment">//这里改成你的AP名字</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AP_PSW  <span class="string">&quot;12345678&quot;</span> <span class="comment">//这里改成你的AP密码 8位以上</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IN1 D1 <span class="comment">// 7 6 右轮</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IN2 D2 </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IN3 D3 <span class="comment">// 5 4 左轮</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IN4 D4</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LEFT <span class="string">&quot;3&quot;</span> <span class="comment">//左转编码</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RIGHT <span class="string">&quot;4&quot;</span><span class="comment">//右转编码</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GO <span class="string">&quot;1&quot;</span><span class="comment">//前进编码</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BACK <span class="string">&quot;2&quot;</span><span class="comment">//后退编码</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STOP <span class="string">&quot;0&quot;</span><span class="comment">//停止编码</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> USE_SERIAL Serial</span></span><br><span class="line"></span><br><span class="line">IPAddress <span class="title function_">local_IP</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">25</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">gateway</span><span class="params">(<span class="number">192</span>,<span class="number">168</span>,<span class="number">4</span>,<span class="number">1</span>)</span>;</span><br><span class="line">IPAddress <span class="title function_">subnet</span><span class="params">(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0</span>)</span>;</span><br><span class="line"></span><br><span class="line">WebSocketsServer webSocket = WebSocketsServer(<span class="number">81</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initSys</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initAP</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initWS</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">initCar</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stopCar</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">turnLeft</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">turnRight</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">go</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">back</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">webSocketEvent</span><span class="params">(<span class="type">uint8_t</span> num, WStype_t type, <span class="type">uint8_t</span> * payload, <span class="type">size_t</span> length)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">setup</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your setup code here, to run once:</span></span><br><span class="line">  initSys();</span><br><span class="line">  initAP();</span><br><span class="line">  initWS();</span><br><span class="line">  initCar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">loop</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">// put your main code here, to run repeatedly:</span></span><br><span class="line">  webSocket.loop();</span><br><span class="line">  <span class="comment">//喂狗</span></span><br><span class="line">  ESP.wdtFeed();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initSys</span><span class="params">()</span>&#123;</span><br><span class="line">  USE_SERIAL.begin(<span class="number">115200</span>);</span><br><span class="line">  USE_SERIAL.println();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initAP</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//配置AP信息</span></span><br><span class="line">  WiFi.mode(WIFI_AP);</span><br><span class="line">  WiFi.softAPConfig(local_IP, gateway, subnet);</span><br><span class="line">  boolean result = WiFi.softAP(AP_SSID, AP_PSW);</span><br><span class="line">  <span class="keyword">if</span>(!result)&#123;</span><br><span class="line">     ESP.restart();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initWS</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="comment">// start webSocket server</span></span><br><span class="line">   webSocket.begin();</span><br><span class="line">   webSocket.onEvent(webSocketEvent);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">initCar</span><span class="params">()</span>&#123;</span><br><span class="line">  pinMode(IN1,OUTPUT);</span><br><span class="line">  pinMode(IN2,OUTPUT);</span><br><span class="line">  pinMode(IN3,OUTPUT);</span><br><span class="line">  pinMode(IN4,OUTPUT);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">stopCar</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="comment">//默认全是低电平 停止状态</span></span><br><span class="line">  digitalWrite(IN1,LOW);      </span><br><span class="line">  digitalWrite(IN2,LOW);</span><br><span class="line">  digitalWrite(IN3,LOW);   </span><br><span class="line">  digitalWrite(IN4,LOW);  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 左转</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">turnLeft</span><span class="params">()</span>&#123;</span><br><span class="line">  digitalWrite(IN1,HIGH);      </span><br><span class="line">  digitalWrite(IN2,LOW);         <span class="comment">//右轮前进</span></span><br><span class="line">  digitalWrite(IN3,LOW);      </span><br><span class="line">  digitalWrite(IN4,LOW);         <span class="comment">//左轮不动</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 右转</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">turnRight</span><span class="params">()</span>&#123;</span><br><span class="line">  digitalWrite(IN1,LOW);      </span><br><span class="line">  digitalWrite(IN2,LOW);         <span class="comment">//右轮不动</span></span><br><span class="line">  digitalWrite(IN3,HIGH);      </span><br><span class="line">  digitalWrite(IN4,LOW);         <span class="comment">//左轮前进</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 前进</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">go</span><span class="params">()</span>&#123;</span><br><span class="line">  digitalWrite(IN1,HIGH);      </span><br><span class="line">  digitalWrite(IN2,LOW);         <span class="comment">//右轮前进</span></span><br><span class="line">  digitalWrite(IN3,HIGH);      </span><br><span class="line">  digitalWrite(IN4,LOW);         <span class="comment">//左轮前进</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 倒车</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">back</span><span class="params">()</span>&#123;</span><br><span class="line">  digitalWrite(IN1,LOW);      </span><br><span class="line">  digitalWrite(IN2,HIGH);        <span class="comment">//右轮后退</span></span><br><span class="line">  digitalWrite(IN3,LOW);      </span><br><span class="line">  digitalWrite(IN4,HIGH);        <span class="comment">//左轮后退</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">webSocketEvent</span><span class="params">(<span class="type">uint8_t</span> num, WStype_t type, <span class="type">uint8_t</span> * payload, <span class="type">size_t</span> length)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(type) &#123;</span><br><span class="line">        <span class="keyword">case</span> WStype_DISCONNECTED:</span><br><span class="line">            USE_SERIAL.<span class="built_in">printf</span>(<span class="string">&quot;[%u] Disconnected!\n&quot;</span>, num);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WStype_CONNECTED: &#123;</span><br><span class="line">            IPAddress ip = webSocket.remoteIP(num);</span><br><span class="line">            USE_SERIAL.<span class="built_in">printf</span>(<span class="string">&quot;[%u] Connected from %d.%d.%d.%d url: %s\n&quot;</span>, num, ip[<span class="number">0</span>], ip[<span class="number">1</span>], ip[<span class="number">2</span>], ip[<span class="number">3</span>], payload);</span><br><span class="line">            <span class="comment">// send message to client</span></span><br><span class="line">            webSocket.sendTXT(num, <span class="string">&quot;Connected&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> WStype_TEXT:</span><br><span class="line">            USE_SERIAL.<span class="built_in">printf</span>(<span class="string">&quot;[%u] get Text: %s\n&quot;</span>, num, payload);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 缺少控制逻辑</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
































      </div>
      <div class="post-tags-categories">
        
        <div class="tags">
          
            <a href="/tags/%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%BC%80%E5%8F%91/" class="">
              嵌入式开发
            </a>
          
        </div>
        
      </div>
      
        <div class="copyright">
  <ul class="post-copyright">
    <li class="post-copyright-author">
    <strong>作者:  </strong>旧时南风</a>
    </li>
    <li class="post-copyright-link">
    <strong>文章链接:  </strong>
    <a href="/2021/07/25/esp8266/" target="_blank" title="ESP8266">http://former-south-wind.github.io/2021/07/25/esp8266/</a>
    </li>
    <li class="post-copyright-license">
      <strong>版权声明:   </strong>
      本网站所有文章除特别声明外,均采用 <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">CC BY-NC-ND 4.0</a>
      许可协议。转载请注明出处!
    </li>
  </ul>
<div>
      
    </article>
    <!-- 上一篇文章和下一篇文章 -->
    
      <!-- 文章详情页的上一页和下一页 -->
<div class="post-nav">



  
  <div class="post-nav-prev post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://s21.ax1x.com/2024/07/19/pkT3Eb8.jpg" class="lazyload placeholder" data-srcset="https://s21.ax1x.com/2024/07/19/pkT3Eb8.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
    </div>
    <a href="/2021/08/03/openhd-shu-mei-pai-shu-zi-tu-chuan/" class="post-nav-link">
      <div class="title">
        <i class="fas fa-angle-left"></i> 上一篇:
        <div class="title-text">OpenHD-树莓派数字图传</div>
      </div>
      
      <!-- <div class="content">
        1、OpenHD
​	ez固件，还有ruby固件

      </div> -->
    </a>
  </div>



  
  <div class="post-nav-next post-nav-item">
    <div class="post-nav-img" style="background-size: cover; 
      background-position: center center;">
      <img class="lazyload lazyload placeholder" src="https://z3.ax1x.com/2021/08/25/heui60.jpg" class="lazyload placeholder" data-srcset="https://z3.ax1x.com/2021/08/25/heui60.jpg" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" src="" alt="">
    </div>
    <a href="/2021/07/23/mo-shui-ping/" class="post-nav-link">
      <div class="title">
        下一篇: <i class="fas fa-angle-right"></i>
        <div class="title-text">墨水屏</div>
      </div>
      <!-- <div class="content">
        1、背景咸鱼淘的，15一套，三色的18一套，兼容微雪驱动，拆机屏幕，质量的确没有微雪的屏幕好，但还够用，要及时清屏，防止
      </div> -->
    </a>
  </div>

</div>

    
    

    <!-- 打赏 -->
    
      <div id="appDonate" class="post-donate">
  <div id="donate_board" class="donate_bar center" ref="donate">
    <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏" @click="showDialogDrawer()"></a>
  </div>
  <transition name="fade">
    <div 
      class="donate-box-mask"
      v-cloak 
      v-show="visible"
      @click="cancelDialogDrawer()"
    >
    </div>
  </transition>
  <transition name="bounce">
    <div class="donate-box" v-cloak v-show="visible">
      <div class="donate-box_close">
        <i class="fas fa-times" aria-hidden="true" @click="cancelDialogDrawer" pointer></i>
      </div>
      <div class="donate-box_title">
        <h4>
          你的赏识是我前进的动力
        </h4>
      </div>
      <div class="donate-box_tab">
        <div class="Alipay" pointer :class="{'active': tabActive === 'Alipay'}" @click="changeTabActive('Alipay')">
          支付宝
        </div>
        <div class="WeChatpay" pointer :class="{'active': tabActive === 'WeChatpay'}" @click="changeTabActive('WeChatpay')">
          微信
        </div>
      </div>
      <div class="donate-box_img">
        <div class="AlipayImg" v-show="tabActive === 'Alipay'">
          <img src="https://s21.ax1x.com/2024/07/19/pkozUOK.webp" class="lazyload placeholder" data-srcset="https://s21.ax1x.com/2024/07/19/pkozUOK.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="支付宝打赏" />
        </div> 
        <div class="WeChatpayImg" v-show="tabActive === 'WeChatpay'">
          <img src="https://s21.ax1x.com/2024/07/19/pkozDFH.webp" class="lazyload placeholder" data-srcset="https://s21.ax1x.com/2024/07/19/pkozDFH.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="微信打赏" />
        </div>
      </div>
    </div>
  </transition>
</div>

<script>
  var body = document.body || document.documentElement || window;
  var vm = new Vue({
    el: '#appDonate',
    data: {
      visible: false,
      tabActive: 'Alipay',
      top: 0,
    },
    computed: {
    },
    mounted() {
    },
    methods: {
      showDialogDrawer() {
        this.visible = true;
        // 防止页面滚动，只能让弹框滚动
        // function getScroll() {
        //   return {
        //     left: window.pageXOffset || document.documentElement.scrollLeft || document.body.scrollLeft || 0,
        //     top: window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0
        //   };
        // }
        this.top = $(document).scrollTop() // or getScroll().top
        // console.log('aa', $('.main-content'));
        body.style.cssText = 'overflow: hidden;';
      },
      cancelDialogDrawer() {
        this.visible = false;
        body.removeAttribute('style');
        $(document).scrollTop(this.top)
      },
      changeTabActive(name) {
        this.tabActive = name;
      }
    },
    created() {}
  })
</script>
    

    <!-- 分享 -->
    
      <!-- https://github.com/overtrue/share.js -->
<!-- 文章详情页的分享 -->
<div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>

<script defer src="/js/shareJs/social-share.min.js"></script>
</script>

<style>
  .social-share {
    margin: 20px 0;
  }
</style>


    
    
    <!-- 评论 -->
    <!-- 评论 -->

  <div id="myComment">
    
      <div id="gitment-container"></div>

    
  </div>


<!-- 还需要在后面这个地址里设置script, comment script in themes\hexo-theme-bamboo\layout\_partial\scripts\index.ejs -->


  </div>

  <!-- 目录 -->
  <aside id='l_side'>
  
    
      <section class="widget side_blogger">
  <div class='content'>
    
      
        <a class='avatar flat-box rectangle' href='/about/'>
          <img src='/medias/icons/avatar.jpg'/>
        </a>
      
    
    
      <div class='text'>
        
          <h2>旧时南风</h2>
        
        
          <p>越热爱，越幸运</p>

        
        
          <p><span id="jinrishici-sentence">南风知我意，吹梦到西州</span></p>
          <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js" charset="utf-8"></script>
        
      </div>
    
    
      <div class="social-wrapper">
        
          
            <a href="https://space.bilibili.com/456189645?spm_id_from=333.1007.0.0"
              class="social fa fa-video flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="mailto:xuzhiweiro@163.com"
              class="social fas fa-envelope flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="https://github.com/former-south-wind"
              class="social fab fa-github flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=2926700458"
              class="social fab fa-qq flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
          
            <a href="/atom.xml"
              class="social fas fa-rss flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
              
            </a>
          
        
      </div>
    
  </div>
</section>

    
  
  
  

  <div class="layout_sticky">    
    
      
<section class="widget side_toc">
  
  <header>
    
      <i style="color: " class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name' style="color: ">本文目录</span>
    
  </header>


  <div class='content'>
    <div class="toc-main">
      <div class="toc-content">
        <!-- <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81esp8266%E7%B3%BB%E5%88%97%E6%A8%A1%E5%9D%97"><span class="toc-text">1、esp8266系列模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81%E5%9B%BA%E4%BB%B6%E4%B8%8B%E8%BD%BD%E9%94%99%E8%AF%AF%E8%BF%9B%E8%A1%8C%E6%93%A6%E9%99%A4"><span class="toc-text">2、固件下载错误进行擦除</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87%EF%BC%88Arduino%E5%BC%80%E5%8F%91%EF%BC%89"><span class="toc-text">3、环境准备（Arduino开发）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E7%A1%AC%E4%BB%B6%E5%87%86%E5%A4%87"><span class="toc-text">1、硬件准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81ESP-01%E7%B3%BB%E5%88%97"><span class="toc-text">1、ESP-01系列</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E7%94%A8%E7%9A%84%E6%9C%80%E5%A4%9A%E7%9A%8412F"><span class="toc-text">2、用的最多的12F</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81NodeMcu%EF%BC%88ESP-12F%E5%BC%80%E5%8F%91%E6%9D%BF%EF%BC%89"><span class="toc-text">3、NodeMcu（ESP-12F开发板）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%818266-12E"><span class="toc-text">4、8266-12E</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%BD%AF%E4%BB%B6%E5%87%86%E5%A4%87"><span class="toc-text">2、软件准备</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81Arduino%E5%AE%89%E8%A3%85-8266%E5%8C%85%E5%AE%89%E8%A3%85"><span class="toc-text">1、Arduino安装+8266包安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%8A%AF%E7%89%87%E6%A3%80%E6%B5%8B%E7%A8%8B%E5%BA%8F"><span class="toc-text">2、芯片检测程序</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81%E7%9B%B8%E5%85%B3%E5%A4%96%E8%AE%BE%E4%BD%BF%E7%94%A8"><span class="toc-text">4、相关外设使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E8%AE%A1%E6%97%B6%E5%92%8C%E5%BB%B6%E6%97%B6"><span class="toc-text">1、计时和延时</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81IO%E5%8F%A3%EF%BC%88Blink%EF%BC%89"><span class="toc-text">2、IO口（Blink）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E4%B8%AD%E6%96%AD"><span class="toc-text">3、中断</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E6%A8%A1%E6%8B%9F%E8%BE%93%E5%85%A5%EF%BC%88ADC%EF%BC%89"><span class="toc-text">4、模拟输入（ADC）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%B5%8B%E9%87%8F%E5%A4%96%E9%83%A8%E7%94%B5%E5%8E%8B"><span class="toc-text">1、测量外部电压</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E6%B5%8B%E9%87%8F%E7%B3%BB%E7%BB%9F%E5%A4%96%E9%83%A8%E7%94%B5%E5%8E%8B"><span class="toc-text">2、测量系统外部电压</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5%E3%80%81%E6%A8%A1%E6%8B%9F%E8%BE%93%E5%87%BA%EF%BC%88PWM%EF%BC%89"><span class="toc-text">5、模拟输出（PWM）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6%E3%80%81%E4%B8%B2%E5%8F%A3%E9%80%9A%E4%BF%A1"><span class="toc-text">6、串口通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81ESP8266%E4%B8%8EEEPROM"><span class="toc-text">7、ESP8266与EEPROM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%86%99%E6%95%B0%E6%8D%AE"><span class="toc-text">1、写数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E8%AF%BB%E6%95%B0%E6%8D%AE"><span class="toc-text">2、读数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E6%B8%85%E9%99%A4%E6%95%B0%E6%8D%AE"><span class="toc-text">3、清除数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E7%BB%93%E6%9E%84%E4%BD%93%E6%93%8D%E4%BD%9C"><span class="toc-text">4、结构体操作</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81SPI%E9%80%9A%E4%BF%A1"><span class="toc-text">8、SPI通信</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0"><span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81ESP8266-SPI%E7%B1%BB%E5%BA%93%E6%88%90%E5%91%98%E5%87%BD%E6%95%B0"><span class="toc-text">2、ESP8266 SPI类库成员函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81SPI%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-text">3、SPI寄存器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E3%80%81Ticker-%E2%80%94ESP8266%E5%AE%9A%E6%97%B6%E5%BA%93"><span class="toc-text">10、Ticker —ESP8266定时库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-1"><span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">2、示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#11%E3%80%81Arduino-Core-For-ESP8266"><span class="toc-text">11、Arduino Core For ESP8266</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#12%E3%80%81ESP8266%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F%E4%B8%8EESP8266WIFI%E5%BA%93"><span class="toc-text">12、ESP8266工作模式与ESP8266WIFI库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ESP8266%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-text">1、ESP8266工作模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81ESP8266WIFI%E5%BA%93"><span class="toc-text">2、ESP8266WIFI库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81WIFI%E9%80%9A%E7%94%A8%E5%8A%9F%E8%83%BD%E5%BA%93%EF%BC%88ESP8266WiFiGeneric%EF%BC%89%EF%BC%9A"><span class="toc-text">1、WIFI通用功能库（ESP8266WiFiGeneric）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81STA%E5%BA%93%EF%BC%88ESP8266WiFiSTA%EF%BC%89%EF%BC%9A"><span class="toc-text">2、STA库（ESP8266WiFiSTA）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81AP%E5%BA%93%EF%BC%88ESP8266WIFIAP%EF%BC%89"><span class="toc-text">3、AP库（ESP8266WIFIAP）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81WiFi%E6%89%AB%E6%8F%8F%E5%BA%93%EF%BC%88ESP8266WiFiScan%EF%BC%89"><span class="toc-text">4、WiFi扫描库（ESP8266WiFiScan）:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81TCP%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88WiFiClient%EF%BC%89"><span class="toc-text">5、TCP客户端（WiFiClient）:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81TCP%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88WiFiClientSecure-https%EF%BC%89"><span class="toc-text">6、TCP客户端（WiFiClientSecure https）:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81TCP%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%88WiFiServer%EF%BC%89"><span class="toc-text">7、TCP服务端（WiFiServer）:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81TCP%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%88WiFiServerSecure-https%EF%BC%89"><span class="toc-text">8、TCP服务端（WiFiServerSecure https）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81ESP8266WiFi%E5%BA%93%E8%87%AA%E5%B8%A6%E6%96%B9%E6%B3%95%EF%BC%9A"><span class="toc-text">9、ESP8266WiFi库自带方法：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">3、示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81AP%E6%A8%A1%E5%BC%8F"><span class="toc-text">1、AP模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81STA%E6%A8%A1%E5%BC%8F"><span class="toc-text">2、STA模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%89%AB%E6%8F%8F%EF%BC%9A"><span class="toc-text">3、扫描：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E9%80%9A%E7%94%A8%E5%BA%93%E5%A4%84%E7%90%86%E4%BA%8B%E4%BB%B6%EF%BC%9A"><span class="toc-text">4、通用库处理事件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81TCP%E5%AE%A2%E6%88%B7%E7%AB%AF%EF%BC%88client%EF%BC%89"><span class="toc-text">5、TCP客户端（client）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81TCP%E6%9C%8D%E5%8A%A1%E7%AB%AF%EF%BC%88server%EF%BC%89"><span class="toc-text">6、TCP服务端（server）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81Smartconfig%E6%99%BA%E8%83%BD%E9%85%8D%E7%BD%91%EF%BC%9A"><span class="toc-text">7、Smartconfig智能配网：</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#13%E3%80%81HttpClient%E2%80%93ESP8266HTTPClient%E5%BA%93"><span class="toc-text">13、HttpClient–ESP8266HTTPClient库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81HTTP"><span class="toc-text">1、HTTP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0-2"><span class="toc-text">1、概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-text">2、工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81HTTP%E8%AF%B7%E6%B1%82"><span class="toc-text">3、HTTP请求</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81HTTP-Response%E5%93%8D%E5%BA%94%E4%BF%A1%E6%81%AF"><span class="toc-text">4、HTTP Response响应信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81ESP8266HTTPClient%E5%BA%93"><span class="toc-text">5、ESP8266HTTPClient库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E7%A4%BA%E4%BE%8B"><span class="toc-text">6、示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#14%E3%80%81UDP%E6%9C%8D%E5%8A%A1"><span class="toc-text">14、UDP服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81UDP"><span class="toc-text">1、UDP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%BA%93%E5%92%8C%E7%A4%BA%E4%BE%8B"><span class="toc-text">2、库和示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#15%E3%80%81WebServer%E2%80%93ESP8266WebServer%E5%BA%93"><span class="toc-text">15、WebServer–ESP8266WebServer库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#16%E3%80%81%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1%E2%80%93ESP8266mDNS%E5%BA%93"><span class="toc-text">16、域名服务–ESP8266mDNS库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81DNS"><span class="toc-text">1、DNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%BA%93%E5%92%8C%E7%A4%BA%E4%BE%8B-1"><span class="toc-text">2、库和示例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#17%E3%80%81SPIFFS%E2%80%93ESP8266-SPIFFS%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F"><span class="toc-text">17、SPIFFS–ESP8266 SPIFFS文件系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E6%A6%82%E8%BF%B0%EF%BC%9A"><span class="toc-text">1、概述：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E5%BA%93%E5%92%8C%E4%BD%BF%E7%94%A8"><span class="toc-text">2、库和使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#18%E3%80%81web%E9%85%8D%E7%BD%91"><span class="toc-text">18、web配网</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#19%E3%80%81NTP%E2%80%93%E6%97%B6%E9%97%B4%E6%9C%8D%E5%8A%A1"><span class="toc-text">19、NTP–时间服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#20%E3%80%81DNSServer%E2%80%93%E7%9C%9F%E6%AD%A3%E7%9A%84%E5%9F%9F%E5%90%8D%E6%9C%8D%E5%8A%A1"><span class="toc-text">20、DNSServer–真正的域名服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#21%E3%80%81%E6%97%A0%E7%BA%BF%E6%9B%B4%E6%96%B0%E2%80%93OTA%E5%9B%BA%E4%BB%B6%E6%9B%B4%E6%96%B0"><span class="toc-text">21、无线更新–OTA固件更新</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81ArduinoOTA"><span class="toc-text">1、ArduinoOTA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81WebUpdateOTA"><span class="toc-text">2、WebUpdateOTA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-SerialUpdateOTA%E2%80%94OTA%E4%B9%8B%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%9B%B4%E6%96%B0"><span class="toc-text">3.SerialUpdateOTA—OTA之服务器更新</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#22%E3%80%81WebSocket-Client%E2%80%93%E5%85%A8%E5%8F%8C%E5%B7%A5%E9%80%9A%E4%BF%A1"><span class="toc-text">22、WebSocket Client–全双工通信</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#23%E3%80%81%E4%BE%8B%E7%A8%8B"><span class="toc-text">23、例程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%B1%80%E5%9F%9F%E7%BD%91%E5%BA%94%E7%94%A8%E2%80%93%E7%82%AB%E9%85%B7RGB"><span class="toc-text">1、局域网应用–炫酷RGB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81OLED%E6%98%BE%E7%A4%BA%E5%A4%A9%E6%B0%94%E5%B1%8F"><span class="toc-text">2、OLED显示天气屏</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81WIFI%E5%B0%8F%E8%BD%A6"><span class="toc-text">3、WIFI小车</span></a></li></ol></li></ol> -->
        <div class="toc"></div>
      </div>
    </div>
  </div>
</section>
<!-- 手机端目录按钮 -->
<div id="toc-mobile-btn">
  <i class="fas fa-list-ul" aria-hidden="true"></i>
</div>

      
  <section class="widget side_recent_post">
    
  <header>
    
      <a style="color: " href='/tags/'><i class="fas fa-book fa-fw" aria-hidden="true"></i><span class='name'>最新文章</span></a>
    
  </header>


    <div class='content'>
      
      <!-- hash算法 -->
      
      <div class="aside-list">
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/09/04/esp32-xue-xi-yu-kai-fa-mo-shui-ping-zhuo-mian-xiao-ping-mu/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://s21.ax1x.com/2024/07/19/pkTKAzV.webp" class="lazyload placeholder" data-srcset="https://s21.ax1x.com/2024/07/19/pkTKAzV.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">09-04</span>
                
              </div>
              <a class="post-title" href="/2024/09/04/esp32-xue-xi-yu-kai-fa-mo-shui-ping-zhuo-mian-xiao-ping-mu/">esp32学习与开发-墨水屏桌面小屏幕</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/08/30/type-c/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic2.zhimg.com/80/v2-63bbdb5b76b8d349ad35ff4281efbd37_1440w.webp" class="lazyload placeholder" data-srcset="https://pic2.zhimg.com/80/v2-63bbdb5b76b8d349ad35ff4281efbd37_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">08-30</span>
                
              </div>
              <a class="post-title" href="/2024/08/30/type-c/">Type-C</a>
            </div>
          </div>
        
          <div class="aside-list-item">
            
            
            

            <div class="post-img-box">
              <a href="/2024/07/23/git/" class="post-img " style="background-size: cover; 
                background-position: center center;">
                <img class="lazyload lazyload placeholder" style="width:100%;height:100%;object-fit:cover;" data-src="https://pic4.zhimg.com/80/v2-e434e3a2888fb4efb1844845b8791d1f_1440w.webp" class="lazyload placeholder" data-srcset="https://pic4.zhimg.com/80/v2-e434e3a2888fb4efb1844845b8791d1f_1440w.webp" srcset="https://pic1.zhimg.com/v2-cd38920285d125be80b3eb504052c550_b.webp" alt="">
              </a>
            </div>
            <div class="post-date-title">
              <div>
                
                  <span class="post-date">07-23</span>
                
              </div>
              <a class="post-title" href="/2024/07/23/git/">Git</a>
            </div>
          </div>
        
      </div>
    </div>
  </section>

    
  </div>
</aside>

  <!-- 图片放大 Wrap images with fancybox support -->
  <script defer src="/js/wrapImage.js"></script>
</div>

<!-- 文章详情页背景图 -->
<div id="appBgSwiper" style="position: fixed;left: 0;top: 0;width: 100%;height: 100%;z-index: -2;"
	:style="{'background-color': bgColor ? bgColor : 'transparent'}">
	<transition-group tag="ul" :name="names">
		<li v-for='(image,index) in img' :key='index' v-show="index === mark" class="bg-swiper-box">
			<img :src="image" class="bg-swiper-img no-lazy">
		</li>
	</transition-group>
</div>
<script>
	var vm = new Vue({
		el: '#appBgSwiper',
		data: {
			names: '' || 'fade' || 'fade', // translate-fade fade
			mark: 0,
			img: [],
			bgColor: '',
			time: null
		},
		methods: {   //添加方法
			change(i, m) {
				if (i > m) {
					// this.names = 'fade';
				} else if (i < m) {
					// this.names = 'fade';
				} else {
					return;
				}
				this.mark = i;
			},
			prev() {
				// this.names = 'fade';
				this.mark--;
				if (this.mark === -1) {
					this.mark = 3;
					return
				}
			},
			next() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			autoPlay() {
				// this.names = 'fade';
				this.mark++;
				if (this.mark === this.img.length) {
					this.mark = 0;
					return
				}
			},
			play() {
				let bgImgDelay = '' || '180000'
				let delay = parseInt(bgImgDelay) || 180000;
				this.time = setInterval(this.autoPlay, delay);
			},
			enter() {
				clearInterval(this.time);
			},
			leave() {
				this.play();
			}
		},
		created() {
			this.play()
		},
		beforeDestroy() {
			clearInterval(this.time);
		},
		mounted() {
			let prop = '' || 'https://cdn.jsdelivr.net/gh/former-south-wind/picx-images-hosting@master/blog-pictures/5.86tj7kz28a.webp';
			let isImg = prop.includes('.bmp') || prop.includes('.jpg') || prop.includes('.png') || prop.includes('.tif') || prop.includes('.gif') || prop.includes('.pcx') || prop.includes('.tga') || prop.includes('.exif') || prop.includes('.fpx') || prop.includes('.psd') || prop.includes('.cdr') || prop.includes('.pcd') || prop.includes('.dxf') || prop.includes('.ufo') || prop.includes('.eps') || prop.includes('.ai') || prop.includes('.raw') || prop.includes('.WMF') || prop.includes('.webp') || prop.includes('.jpeg') || prop.includes('http://') || prop.includes('https://')
			if (isImg) {
				let img = prop.split(',');
				let configRoot = '/'
				let arrImg = [];
				img.forEach(el => {
					var Expression = /http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/;
					var objExp = new RegExp(Expression);

					if (objExp.test(el)) {
						// http or https
						arrImg.push(el);
					} else {
						// 非http or https开头
						// 本地文件
						let firstStr = el.charAt(0);
						if (firstStr == '/') {
							el = el.substr(1); // 删除第一个字符 '/',因为 configRoot最后一个字符为 /
						}
						el = configRoot + el;
						arrImg.push(el);
					}
				})
				this.img = arrImg;
			} else {
				this.bgColor = prop;
			}
		}
	})
</script>

<style>
	.bg-swiper-box {
		position: absolute;
		display: block;
		width: 100%;
		height: 100%;
	}

	.bg-swiper-img {
		object-fit: cover;
		width: 100%;
		height: 100%;
	}
</style>




  <script>
  function loadMermaid() {
    if (document.getElementsByClassName('mermaid').length) {
      if (window.mermaidJsLoad) mermaid.init()
      else {
        loadScript('https://unpkg.com/mermaid/dist/mermaid.min.js').then(() => {
          window.mermaidJsLoad = true
          mermaid.initialize({
            theme: 'default',
          })
          if ('true') {
            mermaid.init();
          }
        })
      }
    }
  };
  document.addEventListener("DOMContentLoaded", function () {
    loadMermaid();
  })

  document.addEventListener('pjax:complete', function () {
    loadMermaid();
  })
  
</script>


      </main>
    </div>

    <!-- 页脚 -->
    
  
  
    <!-- 底部鱼儿跳动效果，依赖于jquery-->
<div id="j-fish-skip" style=" position: relative;height: 153px;width: auto;"></div>
<script defer>
  var RENDERER = {
    POINT_INTERVAL: 5,
    FISH_COUNT: 3,
    MAX_INTERVAL_COUNT: 50,
    INIT_HEIGHT_RATE: .5,
    THRESHOLD: 50,
    FISH_COLOR: '',
    init: function () {
      this.setFishColor(); this.setParameters(), this.reconstructMethods(), this.setup(), this.bindEvent(), this.render()
    },
    setFishColor: function () {
      let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
      if (isDark) {
        this.FISH_COLOR = '#222'; // 暗黑色，有时间把这整成一个变量
      } else {
        this.FISH_COLOR = '#87ccee' || '#7bd3f7';
      }
    },
    setParameters: function () {
      this.$window = $(window), this.$container = $("#j-fish-skip"), this.$canvas = $("<canvas />"), this.context = this.$canvas.appendTo(this.$container).get(0).getContext("2d"), this.points = [], this.fishes = [], this.watchIds = []
    },
    createSurfacePoints: function () {
      var t = Math.round(this.width / this.POINT_INTERVAL);
      this.pointInterval = this.width / (t - 1), this.points.push(new SURFACE_POINT(this, 0));
      for (var i = 1; i < t; i++) {
        var e = new SURFACE_POINT(this, i * this.pointInterval),
          h = this.points[i - 1];
        e.setPreviousPoint(h), h.setNextPoint(e), this.points.push(e)
      }
    },
    reconstructMethods: function () {
      this.watchWindowSize = this.watchWindowSize.bind(this), this.jdugeToStopResize = this.jdugeToStopResize.bind(this), this.startEpicenter = this.startEpicenter.bind(this), this.moveEpicenter = this.moveEpicenter.bind(this), this.reverseVertical = this.reverseVertical.bind(this), this.render = this.render.bind(this)
    },
    setup: function () {
      this.points.length = 0, this.fishes.length = 0, this.watchIds.length = 0, this.intervalCount = this.MAX_INTERVAL_COUNT, this.width = this.$container.width(), this.height = this.$container.height(), this.fishCount = this.FISH_COUNT * this.width / 500 * this.height / 500, this.$canvas.attr({
        width: this.width,
        height: this.height
      }), this.reverse = !1, this.fishes.push(new FISH(this)), this.createSurfacePoints()
    },
    watchWindowSize: function () {
      this.clearTimer(), this.tmpWidth = this.$window.width(), this.tmpHeight = this.$window.height(), this.watchIds.push(setTimeout(this.jdugeToStopResize, this.WATCH_INTERVAL))
    },
    clearTimer: function () {
      for (; this.watchIds.length > 0;) clearTimeout(this.watchIds.pop())
    },
    jdugeToStopResize: function () {
      var t = this.$window.width(),
        i = this.$window.height(),
        e = t == this.tmpWidth && i == this.tmpHeight;
      this.tmpWidth = t, this.tmpHeight = i, e && this.setup()
    },
    bindEvent: function () {
      this.$window.on("resize", this.watchWindowSize), this.$container.on("mouseenter", this.startEpicenter), this.$container.on("mousemove", this.moveEpicenter)
    },
    getAxis: function (t) {
      var i = this.$container.offset();
      return {
        x: t.clientX - i.left + this.$window.scrollLeft(),
        y: t.clientY - i.top + this.$window.scrollTop()
      }
    },
    startEpicenter: function (t) {
      this.axis = this.getAxis(t)
    },
    moveEpicenter: function (t) {
      var i = this.getAxis(t);
      this.axis || (this.axis = i), this.generateEpicenter(i.x, i.y, i.y - this.axis.y), this.axis = i
    },
    generateEpicenter: function (t, i, e) {
      if (!(i < this.height / 2 - this.THRESHOLD || i > this.height / 2 + this.THRESHOLD)) {
        var h = Math.round(t / this.pointInterval);
        h < 0 || h >= this.points.length || this.points[h].interfere(i, e)
      }
    },
    reverseVertical: function () {
      this.reverse = !this.reverse;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].reverseVertical()
    },
    controlStatus: function () {
      for (var t = 0, i = this.points.length; t < i; t++) this.points[t].updateSelf();
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].updateNeighbors();
      this.fishes.length < this.fishCount && 0 == --this.intervalCount && (this.intervalCount = this.MAX_INTERVAL_COUNT, this.fishes.push(new FISH(this)))
    },
    render: function () {
      requestAnimationFrame(this.render), this.controlStatus(), this.context.clearRect(0, 0, this.width, this.height), this.context.fillStyle = this.FISH_COLOR;
      for (var t = 0, i = this.fishes.length; t < i; t++) this.fishes[t].render(this.context);
      this.context.save(), this.context.globalCompositeOperation = "xor", this.context.beginPath(), this.context.moveTo(0, this.reverse ? 0 : this.height);
      for (t = 0, i = this.points.length; t < i; t++) this.points[t].render(this.context);
      this.context.lineTo(this.width, this.reverse ? 0 : this.height), this.context.closePath(), this.context.fill(), this.context.restore()
    }
  },
  SURFACE_POINT = function (t, i) {
    this.renderer = t, this.x = i, this.init()
  };
  SURFACE_POINT.prototype = {
    SPRING_CONSTANT: .03,
    SPRING_FRICTION: .9,
    WAVE_SPREAD: .3,
    ACCELARATION_RATE: .01,
    init: function () {
      this.initHeight = this.renderer.height * this.renderer.INIT_HEIGHT_RATE, this.height = this.initHeight, this.fy = 0, this.force = {
        previous: 0,
        next: 0
      }
    },
    setPreviousPoint: function (t) {
      this.previous = t
    },
    setNextPoint: function (t) {
      this.next = t
    },
    interfere: function (t, i) {
      this.fy = this.renderer.height * this.ACCELARATION_RATE * (this.renderer.height - this.height - t >= 0 ? -1 : 1) * Math.abs(i)
    },
    updateSelf: function () {
      this.fy += this.SPRING_CONSTANT * (this.initHeight - this.height), this.fy *= this.SPRING_FRICTION, this.height += this.fy
    },
    updateNeighbors: function () {
      this.previous && (this.force.previous = this.WAVE_SPREAD * (this.height - this.previous.height)), this.next && (this.force.next = this.WAVE_SPREAD * (this.height - this.next.height))
    },
    render: function (t) {
      this.previous && (this.previous.height += this.force.previous, this.previous.fy += this.force.previous), this.next && (this.next.height += this.force.next, this.next.fy += this.force.next), t.lineTo(this.x, this.renderer.height - this.height)
    }
  };
  var FISH = function (t) {
    this.renderer = t, this.init()
  };
  FISH.prototype = {
    GRAVITY: .4,
    init: function () {
      this.direction = Math.random() < .5, this.x = this.direction ? this.renderer.width + this.renderer.THRESHOLD : -this.renderer.THRESHOLD, this.previousY = this.y, this.vx = this.getRandomValue(4, 10) * (this.direction ? -1 : 1), this.renderer.reverse ? (this.y = this.getRandomValue(1 * this.renderer.height / 10, 4 * this.renderer.height / 10), this.vy = this.getRandomValue(2, 5), this.ay = this.getRandomValue(.05, .2)) : (this.y = this.getRandomValue(6 * this.renderer.height / 10, 9 * this.renderer.height / 10), this.vy = this.getRandomValue(-5, -2), this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1, this.theta = 0, this.phi = 0
    },
    getRandomValue: function (t, i) {
      return t + (i - t) * Math.random()
    },
    reverseVertical: function () {
      this.isOut = !this.isOut, this.ay *= -1
    },
    controlStatus: function (t) {
      this.previousY = this.y, this.x += this.vx, this.y += this.vy, this.vy += this.ay, this.renderer.reverse ? this.y > this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy -= this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(.05, .2)), this.isOut = !1) : this.y < this.renderer.height * this.renderer.INIT_HEIGHT_RATE ? (this.vy += this.GRAVITY, this.isOut = !0) : (this.isOut && (this.ay = this.getRandomValue(-.2, -.05)), this.isOut = !1), this.isOut || (this.theta += Math.PI / 20, this.theta %= 2 * Math.PI, this.phi += Math.PI / 30, this.phi %= 2 * Math.PI), this.renderer.generateEpicenter(this.x + (this.direction ? -1 : 1) * this.renderer.THRESHOLD, this.y, this.y - this.previousY), (this.vx > 0 && this.x > this.renderer.width + this.renderer.THRESHOLD || this.vx < 0 && this.x < -this.renderer.THRESHOLD) && this.init()
    },
    render: function (t) {
      t.save(), t.translate(this.x, this.y), t.rotate(Math.PI + Math.atan2(this.vy, this.vx)), t.scale(1, this.direction ? 1 : -1), t.beginPath(), t.moveTo(-30, 0), t.bezierCurveTo(-20, 15, 15, 10, 40, 0), t.bezierCurveTo(15, -10, -20, -15, -30, 0), t.fill(), t.save(), t.translate(40, 0), t.scale(.9 + .2 * Math.sin(this.theta), 1), t.beginPath(), t.moveTo(0, 0), t.quadraticCurveTo(5, 10, 20, 8), t.quadraticCurveTo(12, 5, 10, 0), t.quadraticCurveTo(12, -5, 20, -8), t.quadraticCurveTo(5, -10, 0, 0), t.fill(), t.restore(), t.save(), t.translate(-3, 0), t.rotate((Math.PI / 3 + Math.PI / 10 * Math.sin(this.phi)) * (this.renderer.reverse ? -1 : 1)), t.beginPath(), this.renderer.reverse ? (t.moveTo(5, 0), t.bezierCurveTo(10, 10, 10, 30, 0, 40), t.bezierCurveTo(-12, 25, -8, 10, 0, 0)) : (t.moveTo(-5, 0), t.bezierCurveTo(-10, -10, -10, -30, 0, -40), t.bezierCurveTo(12, -25, 8, -10, 0, 0)), t.closePath(), t.fill(), t.restore(), t.restore(), this.controlStatus(t)
    }
  }, $(function () {
    RENDERER.init()
    $('.dark').click(function () {
      setTimeout(() => {
        RENDERER.setFishColor();
        RENDERER.context.fill();
      });
    })
  });
</script>
  
  <div class="footer bg-color">
    <div class="footer-main">
      
        
          <div class="link">
            
              
                <a target="_blank" rel="noopener" href="https://space.bilibili.com/456189645?spm_id_from=333.1007.0.0" class="social">
                  
                    <i class="fa fa-video" aria-hidden="true"></i>
                  
                </a>
              
            
              
                <a href="mailto:xuzhiweiro@163.com" class="social">
                  
                    <i class="fas fa-envelope" aria-hidden="true"></i>
                  
                </a>
              
            
              
                <a target="_blank" rel="noopener" href="https://github.com/former-south-wind" class="social">
                  
                    <i class="fab fa-github" aria-hidden="true"></i>
                  
                </a>
              
            
              
                <a href="tencent://AddContact/?fromId=50&amp;fromSubId=1&amp;subcmd=all&amp;uin=2926700458" class="social">
                  
                    <i class="fab fa-qq" aria-hidden="true"></i>
                  
                </a>
              
            
              
                <a href="/atom.xml" class="social">
                  
                    <i class="fas fa-rss" aria-hidden="true"></i>
                  
                </a>
              
            
          </div>
        
      
        
          <div class="footer-copyright">
            <p>Copyright © 2019 - 2024 <a target="_blank" rel="noopener" href="https://github.com/former-south-wind">旧时南风</a> | Powered by <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo</a> | Theme <a target="_blank" rel="noopener" href="https://github.com/yuang01/theme">Bamboo</a> </p>

          </div>
        
      
        
          <div class="footer-custom">
            
          </div>
        
      
    </div>
  </div>



    <!-- 渲染暗黑按钮 -->
    
      <div class="dark" onclick="toggleDarkMode()">
  <div class="dark-content">
    <i class="fas" id="darkIcon" aria-hidden="true"></i>
  </div>
</div>

<script defer>
  $(function() {
    // 初始化暗黑模式状态
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    updateDarkModeIcon(isDark);
  });

  function toggleDarkMode() {
    const isDark = $(document.body).hasClass('darkModel');
    $(document.body).toggleClass('darkModel');
    localStorage.setItem('dark', !isDark);
    updateDarkModeIcon(!isDark);
  }

  function updateDarkModeIcon(isDark) {
    const iconElement = document.getElementById('darkIcon');
    if (isDark) {
      iconElement.classList.remove('fa-moon');
      iconElement.classList.add('fa-lightbulb');
    } else {
      iconElement.classList.remove('fa-lightbulb');
      iconElement.classList.add('fa-moon');
    }
  }
</script>

    
    <!-- 渲染回到顶部按钮 -->
    
      <div class="goTop top-btn-color" pointer>
  <i class="fas fa-arrow-up" aria-hidden="true"></i>
</div>
<script defer src="/js/goTop.js"></script>

    
    <!-- 渲染左下角音乐播放器 -->
    
      <link rel="stylesheet" href="/js/aplayer/APlayer@1.10.1.min.css">
<style>
.aplayer .aplayer-lrc p {
  
  display: none;
  
  font-size: 12px;
  font-weight: 700;
  line-height: 16px !important;
}

.aplayer .aplayer-lrc p.aplayer-lrc-current {
  
  display: none;
  
  font-size: 15px;
  color: #42b983;
}


.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
  left: -66px !important;
}

.aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
  left: 0px !important;
}


</style>
<meting-js  
  class=""
  server="netease"
  type="playlist"
  id="9143039841"
  fixed='true'
  autoplay='false'
  theme='#42b983'
  loop='all'
  order='random'
  preload='auto'
  volume='0.7'
  list-folded='true'
>
</meting-js>

<!-- <style>
  #aplayer {
    position: fixed;
    left: 0;
    bottom: 300px;
  }
</style> -->
<script defer src="https://unpkg.com/aplayer@1.10.1/dist/APlayer.min.js"></script>
<script defer src="https://unpkg.com/meting@2/dist/Meting.min.js"></script>
    

    <!-- 图片放大 -->
    
      <script src="https://unpkg.com/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    

    <!-- 百度解析 -->
    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script async>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <!-- 背景彩带 -->
    

    <script src="/js/utils/index.js"></script>
    <script src="/js/app.js"></script>
    
    <!-- 文章目录所需js -->
<!-- <link href="/js/tocbot/tocbot.css" rel="stylesheet">
<script src="/js/tocbot/tocbot.min.js"></script> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.min.js"></script>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.18.2/tocbot.css">

<script>
  var headerEl = 'h1, h2, h3, h4',  //headers 
    content = '.post-detail',//文章容器
    idArr = {};  //标题数组以确定是否增加索引id
  //add #id
  var option = {
    // Where to render the table of contents.
    tocSelector: '.toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: content,
    // Which headings to grab inside of the contentSelector element.
    headingSelector: headerEl,
    scrollSmooth: true,
    scrollSmoothOffset: -70,
    // headingsOffset: -($(window).height() * 0.4 - 45),
    headingsOffset: -($(window).height() * 0.4 - 70),
    // positionFixedSelector: '.toc-main',
    // positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
    activeLinkClass: 'is-active-link',
    orderedList: true,
    collapseDepth: 20,
    // onClick: function (e) {},
  }
  if ($('.toc').length > 0) {

    $(content).children(headerEl).each(function () {
      //去除空格以及多余标点
      var headerId = $(this).text().replace(/[\s|\~|`|\!|\@|\#|\$|\%|\^|\&|\*|\(|\)|\_|\+|\=|\||\|\[|\]|\{|\}|\;|\:|\"|\'|\,|\<|\.|\>|\/|\?|\：|\，|\。]/g, '');

      headerId = headerId.toLowerCase();
      if (idArr[headerId]) {
        //id已经存在
        $(this).attr('id', headerId + '-' + idArr[headerId]);
        idArr[headerId]++;
      }
      else {
        //id未存在
        idArr[headerId] = 1;
        $(this).attr('id', headerId);
      }
    });

    document.addEventListener("DOMContentLoaded", function () {
      tocbot.init(option);
      mobileTocClick();
    });

  }

  window.tocScrollFn = function () {
    return bamboo.throttle(function () {
      findHeadPosition();
    }, 100)()
  }
  window.addEventListener('scroll', tocScrollFn);

  const findHeadPosition = function (top) {
    if ($('.toc-list').length <= 0) {
      return false;
    }
    setTimeout(() => {  // or DOMContentLoaded 
      autoScrollToc();
    }, 0);
  }

  const autoScrollToc = function () {
    const $activeItem = document.querySelector('.is-active-link');
    const $cardToc = document.querySelector('.toc-content');
    const activePosition = $activeItem.getBoundingClientRect().top
    const sidebarScrollTop = $cardToc.scrollTop
    if (activePosition > (document.documentElement.clientHeight - 100)) {
      $cardToc.scrollTop = sidebarScrollTop + 150
    }
    if (activePosition < 150) {
      $cardToc.scrollTop = sidebarScrollTop - 150
    }
  }

  document.addEventListener('pjax:send', function () {
    if ($('.toc').length) {
      tocbot.destroy();
    }
  });

  document.addEventListener('pjax:complete', function () {
    if ($('.toc').length) {
      tocbot.init(option);
      mobileTocClick();
    }
  });
  
  // 手机端toc按钮点击出现目录
  const mobileTocClick = function () {
    const $cardTocLayout = document.getElementsByClassName('side_toc')[0];
    const $cardToc = $cardTocLayout.getElementsByClassName('toc-content')[0];
    let right = '45px';
    if (window.innerWidth >= 551 && window.innerWidth <= 992) {
      right = '100px'
    }
    const mobileToc = {
      open: () => {
        $cardTocLayout.style.cssText = 'animation: toc-open .3s; opacity: 1; right: ' + right
      },

      close: () => {
        $cardTocLayout.style.animation = 'toc-close .2s'
        setTimeout(() => {
          $cardTocLayout.style.cssText = "opacity:''; animation: ''; right: ''"
        }, 100)
      }
    }
    document.getElementById('toc-mobile-btn').addEventListener('click', () => {
      if (window.getComputedStyle($cardTocLayout).getPropertyValue('opacity') === '0') mobileToc.open()
      else mobileToc.close()
    })

    $cardToc.addEventListener('click', (e) => {
      if (window.innerWidth < 992) { // 小于992px的时候
        mobileToc.close()
      }
    })
  }
</script>

<style>
  /* .is-position-fixed {
    position: sticky !important;
    top: 74px;
  }

  .toc-main ul {
    counter-reset: show-list;
  }

  .toc-main ul li::before {
    content: counter(item)".";
    display: block;
    position: absolute;
    left: 12px;
    top: 0;
  } */
</style>
 

<!-- 设置导航背景 -->
<script>
  let setHeaderClass = () => {
    const nav = $('#navHeader');
    const navTop = nav.outerHeight();
    const winTop = $(window).scrollTop();
    if(winTop > navTop) {
      nav.addClass('header-bg-color');
    }
    else {
      nav.removeClass('header-bg-color');
    }
  };

  let scrollCollect = () => {
    return bamboo.throttle(function (e) {
      setHeaderClass();
    }, 200)()
  }

  let initHeaderBg = () => {
    setHeaderClass();
  }

  setHeaderClass();
  window.addEventListener('scroll', scrollCollect);

  document.addEventListener('pjax:send', function () {
    window.removeEventListener('scroll', scrollCollect)
  })
  document.addEventListener('pjax:complete', function () {
    window.addEventListener('scroll', scrollCollect);
    setHeaderClass();
  })
</script> 

<!-- 渲染issues标签里的内容 -->
<script>
  function loadIssuesJS() {
    if ($(".post-detail").find(".issues-api").length == 0) {
      return;
    } 
    loadScript('/js/issues/index.js');
  };
  $(function () {
    loadIssuesJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof IssuesAPI == "undefined") {
      loadIssuesJS();
    }
  })
</script>

<!-- 渲染远程json加载的图片标签(getPhotoOnline)里的内容 -->
<script>
  function loadPhotoOnlineJS() {
    if ($(".post-detail").find(".getJsonPhoto-api").length == 0) {
      return;
    } 
    loadScript('/js/getPhotoOnline/index.js');
  };
  $(function () {
    loadPhotoOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getPhotoJson == "undefined") {
      loadPhotoOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的talk标签(getTalkOnline)里的内容 -->
<script>
  function loadTalkOnlineJS() {
    if ($(".post-detail").find(".getJsonTalk-api").length == 0) {
      return;
    } 
    loadScript('https://cdnjs.cloudflare.com/ajax/libs/waterfall.js/1.0.2/waterfall.min.js'); // 瀑布流插件，https://raphamorim.io/waterfall.js/
    loadScript('/js/getTalkOnline/index.js');
  };
  $(function () {
    loadTalkOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getTalkJson == "undefined") {
      loadTalkOnlineJS();
    }
  })
</script>

<!-- 渲染远程json加载的site-card标签(getSiteOnline)里的内容 -->
<script>
  function loadSiteOnlineJS() {
    if ($(".post-detail").find(".getJsonSite-api").length == 0) {
      return;
    } 
    loadScript('/js/getSiteOnline/index.js');
  };
  $(function () {
    loadSiteOnlineJS();
  });
  document.addEventListener('pjax:complete', function () {
    if (typeof getSiteJson == "undefined") {
      loadSiteOnlineJS();
    }
  })
</script>

<!-- 输入框打字特效 -->
<!-- 输入框打字特效 -->

  <script src="/js/activate-power-mode.js"></script>
  <script>
    POWERMODE.colorful = true;  // 打开随机颜色特效
    POWERMODE.shake = false;    // 关闭输入框抖动
    document.body.addEventListener('input', POWERMODE);//监听打字事件
  </script>


<!-- markdown代码一键复制功能 -->

  <link rel="stylesheet" href="https://unpkg.com/v-plugs-ayu/lib/ayu.css">
  <script src="https://unpkg.com/v-plugs-ayu/lib/ayu.umd.min.js"></script>
  <script src="/js/clipboard/clipboard.min.js"></script>
  <div id="appCopy">
  </div>
  <script data-pjax>
    var vm = new Vue({
      el: '#appCopy',
      data: {
      },
      computed: {
      },
      mounted() {
        const that = this;
        var copy = '复制';
        /* code */
        var initCopyCode = function () {
          var copyHtml = '';
          copyHtml += '<button class="btn-copy" data-clipboard-snippet="" style="position:absolute;top:0;right:0;z-index:1;">';
          copyHtml += '<i class="fas fa-copy"></i><span>' + copy + '</span>';
          copyHtml += '</button>';
          $(".post-detail pre").not('.gutter pre').wrap("<div class='codeBox' style='position:relative;width:100%;'></div>")
          $(".post-detail pre").not('.gutter pre').before(copyHtml);
          new ClipboardJS('.btn-copy', {
            target: function (trigger) {
              return trigger.nextElementSibling;
            }
          });
        }
        initCopyCode();
        $('.btn-copy').unbind('click').bind('click', function () {
          doSomething();
        })
        $(document).unbind('keypress').bind('keypress', function (e) {
          if (e.ctrlKey && e.keyCode == 67) {
            doSomething();
          }
        })

        function doSomething() {
          that.$notify({
            title: "成功",
            content: "代码已复制，请遵守相关授权协议。",
            type: 'success'
          })
        }
      },
      methods: {
      },
      created() { }
    })
  </script>
  

<!-- 图片懒加载 -->
<script defer src="https://unpkg.com/vanilla-lazyload@17.1.0/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>


<!-- 卡片滚动动画 -->
   

<!-- 评论所需js -->

  
        <script type="text/javascript">
  var utteranceComment = {};

  function check_utterance() {
    let isDark = JSON.parse(localStorage.getItem('dark')) || JSON.parse('false');
    if (isDark) {
      utteranceComment.Theme = 'github-dark';
    } else {
      utteranceComment.Theme = 'github-light';
    }

    return document.getElementById("gitment-container");
  }
  comment_el = '#gitment-container';
  load_utterance = function () {
    if ($(comment_el).length) {
      // 匿名函数，防止污染全局变量
      const HEAD = check_utterance();

      var utterances = document.createElement('script');
      utterances.type = 'text/javascript';
      utterances.async = true;
      utterances.setAttribute('issue-term', 'pathname')
      utterances.setAttribute('theme', utteranceComment.Theme)
      utterances.setAttribute('repo', 'former-south-wind/former-south-wind.github.io')
      utterances.crossorigin = 'anonymous';
      utterances.src = 'https://utteranc.es/client.js';
      // content 是要插入评论的地方
      document.getElementById('gitment-container').appendChild(utterances);

    }
  }

  function dark_utterance() {
    const HEAD = check_utterance();
    if (!HEAD) return;
    const message = {
      type: 'set-theme',
      theme: utteranceComment.Theme
    };
    const utteranceIframe = document.querySelector('iframe');
    utteranceIframe.contentWindow.postMessage(message, 'https://utteranc.es');
  }

  $(document).ready(load_utterance);
  document.addEventListener('pjax:complete', function () {
    load_utterance();
  });

  $('.dark').click(function () {
    setTimeout(() => {
      dark_utterance();
    });
  })

</script>

<style>
  .utterances {
    max-width: inherit !important;
  }
</style>
      


<!-- 鼠标点击特效 -->
<!-- 爱心点击 -->

   
    <script async src="/js/cursor/clicklove.js"></script> 
  




  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" data-pjax></script>


<!-- 轮播图标签 -->
<script>
  var bambooSwiperTag = {};
  function load_swiper() {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    loadCSS("https://unpkg.com/swiper@6/swiper-bundle.min.css")
    loadScript("https://unpkg.com/swiper@6/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    bambooSwiperTag.swiper = new Swiper('.post-swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      autoplay: true ? {
        delay: 3000,
        stopOnLastSlide: false,
        disableOnInteraction: false,
      } : false,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
      on:{
        init: function(){
          swiperAnimateCache(this); //隐藏动画元素 
          swiperAnimate(this); //初始化完成开始动画
        }, 
        slideChangeTransitionEnd: function(){ 
          swiperAnimate(this); //每个slide切换结束时也运行当前slide动画
          //this.slides.eq(this.activeIndex).find('.ani').removeClass('ani'); 动画只展现一次，去除ani类名
        } 
      }
    });
  }

  document.addEventListener('pjax:complete', function () {
    if (!document.querySelectorAll(".post-swiper-container")[0]) return;
    if (typeof bambooSwiperTag.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>
    <!-- pjax -->
    

<!-- pjax -->


  <script src="/js/pjax@0.2.8/index.js"></script>
  
    <div class="pjax-animate">
  
    <div class="loading-circle"><div id="loader-circle"></div></div>
    <script>
      window.ShowLoading = function() {
        $(".loading-circle").css("display", "block");
      };
      window.HideLoading = function() {
        $(".loading-circle").css("display", "none");
      }
    </script>
  
	<script>
    document.addEventListener('pjax:complete', function () {
      window.HideLoading();
    })
    document.addEventListener('pjax:send', function () {
      window.ShowLoading();
    })
    document.addEventListener('pjax:error', function () {
      window.HideLoading();
    })
	</script>
</div>

  

  <script>
    var pjax = new Pjax({
      elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([no-pjax])',   // 拦截正常带链接的 a 标签
      selectors: ["#pjax-container","title"],                                   // 根据实际需要确认重载区域
      cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
      timeout: 5000
    });

    document.addEventListener('pjax:send', function (e) {

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      $(window).unbind('resize');
      $(window).unbind('scroll');
      $(document).unbind('scroll');
      $(document).unbind('click');
      $('body').unbind('click');

    })
    
    document.addEventListener('pjax:complete', function () {
      $('script[data-pjax], .pjax-reload script').each(function () {
        $(this).parent().append($(this).remove());
      });
    });

    document.addEventListener('pjax:error', function (e) {
      window.location.href = e.triggerElement.href;
    })
    
    // 刷新不从顶部开始
    document.addEventListener("DOMContentLoaded", function () {
      history.scrollRestoration = 'auto';
    })
  </script>



  </body>
</html>